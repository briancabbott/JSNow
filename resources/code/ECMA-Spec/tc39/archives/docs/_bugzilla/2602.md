---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":2602,"creation_ts":"2014-04-01 07:17:00 -0700","short_desc":"Loader: a Load can be dropped due to a race condition populating [[LinkSets]]","delta_ts":"2015-03-16 14:41:05 -0700","product":"Draft for 6th Edition","component":"deferred features","version":"Rev 22: January 20, 2014 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"WONTFIX","priority":"Normal","bug_severity":"enhancement","everconfirmed":true,"reporter":{"uid":"jorendorff","name":"Jason Orendorff"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":["dherman","guybedford","jorendorff","samth"],"long_desc":[{"commentid":7495,"comment_count":0,"who":{"uid":"jorendorff","name":"Jason Orendorff"},"bug_when":"2014-04-01 07:17:23 -0700","thetext":"Guy Bedford reports:\n> When in ProcessLoadDependencies, RequestLoad is called for each\n> dependency, in turn running ProceedToLocate.\n> \n> This ProceedToLocate therefore runs before we've added the dependency\n> load to the linkset with AddLoadToLinkset.\n> \n> As a result, we can reach the Fetch and Locate hooks before the\n> load.linkSets have been populated at all.\n> \n> The check for load.linkSets.length == 0 then passes, assuming a failed\n> load, and the fetch and translate get skipped.\n\nI agree this is a race condition and a bug.\n\nThere are several possible fixes. Guy suggests changing the check to test load.[[Status]] rather than load.[[LinkSets]], which seems like the simplest thing."},{"commentid":7498,"comment_count":1,"who":{"uid":"guybedford","name":"Guy Bedford"},"bug_when":"2014-04-01 10:52:03 -0700","thetext":"The race condition is simply caused by the asynchronous nature of promises. So just running ProceedToLocate after a process tick is enough to avoid it.\n\nSince RequestLoad only seems to be called from within ProcessLoadDependencies, it may even make sense to collapse RequestLoad into ProcessLoadDependencies and then run the call to ProceedToLocate after each AddDependencyLoad instead of before."},{"commentid":13771,"comment_count":2,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-16 14:41:05 -0700","thetext":"concerns old module spec."}]}}
---
