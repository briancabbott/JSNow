---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":2831,"creation_ts":"2014-05-09 11:56:00 -0700","short_desc":"25.4 Promises","delta_ts":"2014-08-24 11:29:30 -0700","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 24: April 27, 2014 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"WONTFIX","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":"fdohrendorf","assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":["andrebargull","d"],"long_desc":[{"commentid":8260,"comment_count":0,"who":"fdohrendorf","bug_when":"2014-05-09 11:56:34 -0700","thetext":"If an exception is thrown inside of an onFulfilled callback function that was given as Parameter to the then(25.4.5.3) method, without any Additional then(or catch) calls, that exception will be catched by PromiseReactionTask(25.4.2.1),  without being rethrown.\n\nThis happens because inside of the then(25.4.5.3) method a new promisecapability record is created which includes a new promise, that doesn't get a Default callback handler for onRejected. So when the exception is thrown it goes up to PromiseReactionTask is then delegated to this new PromiseCapability record, and delegated to the reject method, and then to the TriggerPromiseReactions, which should Enqueue a PromiseReactionTask for every PromiseRejectReactions, but These are empty at that Point, so TriggerPromiseReactions just returns undefined, as a NormalCompletion.\n\nI would expect the exception to get rethrown so that it lands inside NextTask (8.4.2)  Operation.\n\nI created a working solution by adding a flag to Promise that tells if it was just created.\nAlso i add a Default promiseRejectReaction to the promise of the new promiseCapability record that is created inside the then method.\nFinally i added a check in then beginnig of the then method and if the flag is set i clear the promiseRejectReactions and unset the flag.\nThis throws the exception as expected.\n\nI tested my solution with:\nhttps://github.com/promises-aplus/promises-tests\n\nIf this was actually the intended behavior i would pretty much love to hear why, because i obviously didn't get it. And i just spend alot of time figuring this out.\nBecause my exceptions weren't showing up as expected."},{"commentid":8268,"comment_count":1,"who":{"uid":"d","name":"Domenic Denicola"},"bug_when":"2014-05-09 12:43:25 -0700","thetext":"This is how promises work. It allows code like\n\n```js\nvar promise = anotherPromise.then(value => {\n  if (!isValid(value)) {\n    throw new Error('Invalid value ' + value + '!');\n  }\n});\n\n// later, after some other async processing takes place:\ndoAsyncStuff().then(() => {\n  promise.catch(error => showUser(error.message));\n});\n```\n\nPromises can hold rejections indefinitely, until someone listens to them. Modern promise environments provide debugging experiences that allow you to introspect any currently-rejected promises."},{"commentid":8313,"comment_count":2,"who":"fdohrendorf","bug_when":"2014-05-11 07:02:59 -0700","thetext":"Ok i didn't know that. I expected this to work differently, is there any documentation how it came to this decision?\n\nI thought, since it is async, that the Operation that sets up the promises should also Setup exception handling, before giving control to the async Operation. Which then expects tobe Setup completly, and if it encounters an exception should behave as stated. So that an unhandled exception is really thrown. Thinking of async operations in a more synchronous way.\n\nAlso what brought me to my conclusion was the line:\n1.If result is an abrupt completion, then perform implementation defined unhandled exception processing.\n-- in NextTask (8.4.2)\nWhich will never be hit with an abrupt completion, at least not from any promise related Task.\n\nThanks for the quick Response."},{"commentid":8314,"comment_count":3,"who":{"uid":"andrebargull","name":"AndrÃ© Bargull"},"bug_when":"2014-05-11 08:16:55 -0700","thetext":"(In reply to comment #2)\n> Also what brought me to my conclusion was the line:\n> 1.If result is an abrupt completion, then perform implementation defined\n> unhandled exception processing.\n> -- in NextTask (8.4.2)\n> Which will never be hit with an abrupt completion, at least not from any\n> promise related Task.\n\nIt is possible to take that step with promise tasks, for example using this code [1]. But the results are implementation defined, for example V8 simply ignores the exception (cf. the empty catch block in [2]). \n\n[1] https://github.com/anba/es6draft/blob/f2255ae58fed3e8c4f7153c5bea654d2b14fa2df/src/test/scripts/suite/lib/promises.js#L13-L19\n[2] https://code.google.com/p/v8/source/browse/branches/bleeding_edge/src/promise.js?spec=svnr21247&r=r21247#179"}]}}
---
