---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":3395,"creation_ts":"2014-11-20 17:10:00 -0800","short_desc":"7.4.7.5 IteratorClose should throw if hasReturn and !iterator.return().done","delta_ts":"2015-01-28 12:11:04 -0800","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 28: October 14, 2014 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"INVALID","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":{"uid":"ben","name":"Ben Newman"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"long_desc":[{"commentid":10668,"comment_count":0,"who":{"uid":"ben","name":"Ben Newman"},"bug_when":"2014-11-20 17:10:44 -0800","thetext":"The current implementation of IteratorClose(iterator, completion) is as follows:\n\n  Assert: Type(iterator) is Object.\n  Assert: completion is a Completion Record.\n  Let hasReturn be HasProperty(iterator, \"return\").\n  ReturnIfAbrupt(hasReturn).\n  If hasReturn is true, then\n    Let innerResult be Invoke(iterator, \"return\", ( )).\n    If completion.[[type]] is not throw and innerResult.[[type]] is throw, then\n      Return innerResult.\n  Return completion.\n\nPer David Herman's recommendation, we should report an error if innerResult.[[type]] is normal and ToObject(innerResult.[[value]]).done is not true:\n\n  Assert: Type(iterator) is Object.\n  Assert: completion is a Completion Record.\n  Let hasReturn be HasProperty(iterator, \"return\").\n  ReturnIfAbrupt(hasReturn).\n  If hasReturn is true, then\n    Let innerResult be Invoke(iterator, \"return\", ( )).\n    If completion.[[type]] is throw, then\n      Return completion.\n    If innerResult.[[type]] is throw, then\n      Return innerResult.\n    If innerResult.[[type]] is normal, then\n      Let done be Get(ToObject(innerResult.[[value]]), \"done\").\n      If done is not true, throw a TypeError exception.\n  Return completion."},{"commentid":10669,"comment_count":1,"who":{"uid":"ben","name":"Ben Newman"},"bug_when":"2014-11-20 17:18:58 -0800","thetext":"Motivation: https://speakerdeck.com/dherman/closing-iterators"},{"commentid":11740,"comment_count":2,"who":{"uid":"ben","name":"Ben Newman"},"bug_when":"2015-01-28 12:11:04 -0800","thetext":"After discussion in the TC39 meeting of 28 January 2015, it was decided an exception should NOT be thrown by the for-of loop when the result of the iterator.return() call is an object with a falsy .done property. Note that an exception should still be thrown if the result of the .return() call is not an object.\n\nIterator implementors who really want an exception to be thrown if .return() is called early can implement their own return method that throws an exception."}]}}
---
