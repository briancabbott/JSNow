---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":4041,"creation_ts":"2015-02-20 13:36:00 -0800","short_desc":"15.1 super and new.target should not be allowed in direct evals","delta_ts":"2015-07-10 08:35:03 -0700","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 34: February 20, 2015 Release Candidate 1","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":{"uid":"allen","name":"Allen Wirfs-Brock"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":["brterlso","dslomov","erik.arvidsson","jorendorff","rossberg"],"long_desc":[{"commentid":13212,"comment_count":0,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-20 13:36:06 -0800","thetext":"15.1 explicitly allows for  'super' and 'new.taget' to appear within direct eval'ed scripts within function bodies.\n\nThis is probably a bad idea that either is going to add complexity to implementations or perhaps limit optimization opportunities. \n\nI think we should remove the \"unless...\" clause's in the 3rd and 4th bullets of 15.1.\n\n(BTW, if somebody really needs to eval some code that needs to use super or 'new.target' there are workarounds such as:\n\nlet nt = ()=>new.target;\nlet superMethodCall = (m,...args)=>super[m](...args);\n\ninstead of:\neval(\"if (!new.target) super.foo();\");\n\nsays:\neval(\"if (!nt()) superMethodCall('foo');\");"},{"commentid":13217,"comment_count":1,"who":{"uid":"jorendorff","name":"Jason Orendorff"},"bug_when":"2015-02-21 01:27:37 -0800","thetext":"What optimization opportunities should we be worried about here? Keep in mind that the presence of direct eval already inhibits virtually every optimization we've got. Methods that do not call direct eval will be unaffected either way, right?\n\nAs for direct eval implementation complexity, 'new.target' and 'super' don't seem any worse than 'this' and 'arguments', and given that we have to implement them all in arrow functions anyway, it probably won't be much harder to add direct eval support.\n\nAdmittedly, for any given weird corner case, throwing a SyntaxError is even easier.\n\n----\n\nI'd consider dropping [[NeedsSuper]] and NeedsSuperBinding altogether and calling MakeMethod on every method. The fact that this can be skipped for methods that don't use 'super' is worth a NOTE, but not normative text, in my view."},{"commentid":13255,"comment_count":2,"who":{"uid":"arv","name":"Erik Arvidsson"},"bug_when":"2015-02-23 08:12:52 -0800","thetext":"One of the problems (when implementing new.target) is that we need to statically know whether the function will need access to the NewTarget. We could treat the presence of direct eval the same way we would do new.target though.\n\nAs an end user I think we should allow super and new.target in direct evals.\n\n----\n\nI agree with Jason, I don't think the spec needs to mention [[NeedsSuper]]. An implementation can skip adding the [[HomeObject]] as long as it isn't observable."},{"commentid":13328,"comment_count":3,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-24 15:32:40 -0800","thetext":"fixed in rev35 editor's draft\n\ngot rid of NeedsSuperBinding and make all MakeMethod calls unconditional\n\nkeeping the 15.1 early errors"},{"commentid":13494,"comment_count":4,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-04 18:58:14 -0800","thetext":"fixed in rev35"}]}}
---
