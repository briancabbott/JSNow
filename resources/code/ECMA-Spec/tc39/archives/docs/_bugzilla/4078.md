---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":4078,"creation_ts":"2015-02-22 04:26:00 -0800","short_desc":"21.2 RegExp: Incomplete compatibility for %RegExpPrototype%","delta_ts":"2015-03-04 18:58:21 -0800","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 34: February 20, 2015 Release Candidate 1","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":{"uid":"andrebargull","name":"André Bargull"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":["d","getify"],"long_desc":[{"commentid":13253,"comment_count":0,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-02-22 04:26:16 -0800","thetext":"js> \"\".match(RegExp.prototype)\nuncaught exception: TypeError: function called on an incompatible object\njs> \"\".split(RegExp.prototype)\nuncaught exception: TypeError: function called on an incompatible object\njs> \"\".replace(RegExp.prototype)\nuncaught exception: TypeError: function called on an incompatible object\n\nThe TypeErrors are thrown because %RegExpPrototype% is not handled in the various RegExp flags accessors methods.\n\n\nIt is certainly possible to patch each accessor to handle %RegExpPrototype%, but I start to believe\nthat simply adding [[OriginalSource]] and [[OriginalFlags]] internal slots to %RegExpPrototype% is\na better solution. Therefore I'd like to propose the following changes:\n\n\n1) Remove special casing %RegExpPrototype% in RegExp.prototype.test( S ) step 5.\n2) Add [[OriginalSource]] and [[OriginalFlags]] internal slots to %RegExpPrototype%. The slot values are the empty string.\n3) Add an assertion to 21.2.3.2.2 RegExpInitialize as the first step: \"1. Assert: obj has a [[RegExpMatcher]] internal slot.\".\n4) Handle %RegExpPrototype% in 21.2.5.2 RegExp.prototype.exec and 21.2.5.2.1 RegExpExec this way:\n\n21.2.5.2 RegExp.prototype.exec ( string ) - Replace steps 3-4 with:\n  3.  If R has [[OriginalSource]] and [[OriginalFlags]] internal slots, then\n    a.  If R does not have a [[RegExpMatcher]] internal slot, then\n        i.  Let R be RegExpCreate(R.[[OriginalSource]], R.[[OriginalFlags]]).\n        ii. ReturnIfAbrupt(R).\n  4. Else, throw a TypeError exception.\n\n21.2.5.2.1 Runtime Semantics: RegExpExec ( R, S ) - Replace step 6 with:\n  6.  If R has [[OriginalSource]] and [[OriginalFlags]] internal slots, then\n    a.  If R does not have a [[RegExpMatcher]] internal slot, then\n        i.  Let R be RegExpCreate(R.[[OriginalSource]], R.[[OriginalFlags]]).\n        ii. ReturnIfAbrupt(R).\n  7. Else, throw a TypeError exception.\n\n5) Change 21.2.5 Properties of the RegExp Prototype Object, from:\n     > It is not a RegExp instance and does not have a [[RegExpMatcher]] internal slot or any of the other internal slots of RegExp instance objects.\n   to:\n     > It is not a RegExp instance and does not have a [[RegExpMatcher]] internal slot. However, it has [[OriginalSource]] and [[OriginalFlags]] internal slots.\n     > The value of the [[OriginalSource]] and [[OriginalFlags]] internal slot is the empty string.\n\n6) Change 21.2.3.1 RegExp - Replace step 5 with:\n  5.  If Type(pattern) is Object and pattern has [[OriginalSource]] and [[OriginalFlags]] internal slots, then\n\n7) Change 7.2.8 IsRegExp - Replace step 5 with:\n  5.  If argument has [[OriginalSource]] and [[OriginalFlags]] internal slots, return true.\n\n8) Change B.2.5.1 RegExp.prototype.compile (pattern, flags ) - Replace step 3 with:\n  3.  If Type(pattern) is Object and pattern has [[OriginalSource]] and [[OriginalFlags]] internal slots, then"},{"commentid":13393,"comment_count":1,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-26 10:25:18 -0800","thetext":"Legacy compat for these built-in prototypes is something we have been approaching on an asymptotically good-enough basis. It isn't clear whether or not using RegExp.prototype as the argument to those string methods are inside or beyond the good=enough line.\n\nIf we really found we needed to push legacy compatibility to include them it would probably be better to simply revert to %RegExpPrototype% being a fully configured RegExp instance with all the appropriately initialized internal slots."},{"commentid":13399,"comment_count":2,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-02-26 13:58:58 -0800","thetext":"I consider the current workarounds in RegExp.prototype.exec and RegExp.prototype.test [1] to be half-baked solutions. If compatibility is needed for %RegExpPrototype%, it should be present for every legacy API - that includes the String.prototype methods. \n\n[1] RegExp.prototype.test doesn't even need to special case %RegExpPrototype% !\n\n\n(In reply to Allen Wirfs-Brock from comment #1)\n> If we really found we needed to push legacy compatibility to include them it\n> would probably be better to simply revert to %RegExpPrototype% being a fully\n> configured RegExp instance with all the appropriately initialized internal\n> slots.\n\nThat's the alternative solution. The only reason why I'm proposing to add just [[OriginalSource]] and [[OriginalFlags]], is the RegExp.prototype.compile issue described in [2]. If %RegExpPrototype% is reverted to a normal RegExp instance, RegExp.prototype.compile needs to handle %RegExpPrototype% (for the current and foreign realms; looking at you, V8! [3]).\n\n[2] https://mail.mozilla.org/pipermail/es-discuss/2015-February/041656.html\n[3] https://github.com/v8/v8-git-mirror/blob/27a3879617245f347213a739eee3727e24a0c608/src/regexp.js#L63-L67"},{"commentid":13400,"comment_count":3,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-02-26 14:00:30 -0800","thetext":"Cc'ing Kyle Simpson.\nMaybe he can share some use cases where RegExp.prototype is used as a RegExp instance?"},{"commentid":13401,"comment_count":4,"who":{"uid":"d","name":"Domenic Denicola"},"bug_when":"2015-02-26 14:12:01 -0800","thetext":"I think these changes should be reverted. We do not yet have compelling evidence that this will break enough sites to cause browser game theory to make it un-implementable."},{"commentid":13409,"comment_count":5,"who":{"uid":"getify","name":"getify@gmail.com"},"bug_when":"2015-02-26 15:24:05 -0800","thetext":"As I've said on es-discuss, my primary usage pattern is, in order, `Function.prototype`, `Array.prototype`, and to a much lesser (but non-zero) extent, `RegExp.prototype`. I have never relied on `String.prototype` being a String, `Number.prototype` being a Number, or `Boolean.prototype` being a Boolean. `Object.prototype` is a non-issue since it was already a plain object, and I've never cared about its `instanceof` behavior.\n\nWe've already discussed `Function.prototype` and why it had to be rolled back. I also provided some evidence for `Array.prototype` being rolled back.\n\nAs for `RegExp.prototype`, the only place I ever used this was as a default value for a parameter to a function utility, something similar to this:\n\n\nfunction lookForAllMatches(str,re) {\n   str = str || \"\";\n   re = re || RegExp.prototype;\n   if (!re.global) re = new RegExp(re.source,\"g\");\n   return str.match(re);\n}\n\n\nCould I have done just `/(?:)/` instead of `RegExp.prototype`? Of course. But there was no compelling reason back then, nor was there any sense or signal that such a fundamental and simple thing would ever be changed.\n\nThat's it, that's my only evidence.\n\n-------\n\nThat evidence is not, admittedly, very compelling. But I would submit that the evidence for the change (making RegExp.prototype not a regex) is equally uncompelling, perhaps even less so. I really can't imagine any scenarios where people will be confused by `RegExp.prototype` being `instanceof RegExp`. I think that's just academic fodder.\n\nOne other tiny point in favor is keeping consistency with `Function.prototype` and `Array.prototype`, since all 3 of these have at least some demonstrated utility as default \"empties\" of their respective types.\n\nBut to boil it all down, I won't lose any sleep if `RegExp.prototype` changes. I would be vehemently opposed (not that that matters) to `Function.prototype` or `Array.prototype` changing."},{"commentid":13465,"comment_count":6,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-04 18:24:39 -0800","thetext":"fixed in rev35\n\nI reverted the %RegExpPrototype% test in the exec and test methods. I think they are two much of a mack to standardize.\n\nFor, for now at least RegExp.prototype is an ordinary object that doesn't have any  RegExp internal slots and no special legacy compat. recognition.\n\nI think we may still end up  revert it to being a RegExp instance, but not in this draft."},{"commentid":13539,"comment_count":7,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-04 18:58:21 -0800","thetext":"fixed in rev35"}]}}
---
