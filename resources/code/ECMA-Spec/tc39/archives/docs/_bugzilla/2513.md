---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":2513,"creation_ts":"2014-02-07 15:12:00 -0800","short_desc":"25.4.5.3 Promise.prototype.then uses constructor, not [[PromiseConstructor]]","delta_ts":"2015-02-02 16:13:06 -0800","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 22: January 20, 2014 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"enhancement","everconfirmed":true,"reporter":{"uid":"ecmascript","name":"C. Scott Ananian"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":"d","long_desc":[{"commentid":7212,"comment_count":0,"who":{"uid":"ecmascript","name":"C. Scott Ananian"},"bug_when":"2014-02-07 15:12:16 -0800","thetext":"Other Promise methods use the value of the internal [[PromiseConstructor]] slot.  The definition of Promise.prototype.then uses ordinary (mutable) \"constructor\" instead, in step 3.  That should probably be changed to use the [[PromiseConstructor]] slot for consistency.\n\nRe: http://people.mozilla.org/~jorendorff/es6-draft.html#sec-promise.prototype.then"},{"commentid":7282,"comment_count":1,"who":{"uid":"d","name":"Domenic Denicola"},"bug_when":"2014-02-12 17:30:35 -0800","thetext":"This is as intended. The only other \"methods\" that use [[PromiseConstructor]] are `Promise.cast` (now `Promise.resolve`), which is specifically designed for allowing tamper-proof casting via private slots. `then` should use normal publicly-accessibly properties; compare e.g. `Array.prototype.map`."},{"commentid":7284,"comment_count":2,"who":{"uid":"ecmascript","name":"C. Scott Ananian"},"bug_when":"2014-02-12 19:13:11 -0800","thetext":"Promise#then uses Promise Resolution Handler which uses [[PromiseConstructor]], is this expected to change?\n\nIn particular, for a has-resolution promise 'p', where p.[[PromiseConstructor]] = A and p.constructor = B and the resolved value is a thenable t:\n\np.then() will return a new promise 'b' of type B, then immediately enqueue a task which will create a promise 'a' of type A.  It will then call t.then(resolve-of-a, reject-of-a) and a.then(resolve-of-b, reject-of-b).\n\nI guess this makes sense, if you think of the public constructor property as \"what type of promise do I want to return from then()\" and the internal [[PromiseConstructor]] as \"what type of promise do I want to create internally to handle promise chaining\".\n\nJust checking that this behavior is intentional."},{"commentid":7287,"comment_count":3,"who":{"uid":"ecmascript","name":"C. Scott Ananian"},"bug_when":"2014-02-12 20:26:24 -0800","thetext":"Don't mean to be a pest, reopening just to ensure that domenic sees that Promise.then is actually specified currently to use *both* constructor *and* [[PromiseConstructor]].  Double-checking that this is intentional; feel free to close again if this really is the desired behavior.\n\nhttps://github.com/domenic/promises-unwrapping/issues/73 might be related; perhaps the trusted \"PromiseThen\" implementation would use [[PromiseConstructor]] here?"},{"commentid":7289,"comment_count":4,"who":{"uid":"d","name":"Domenic Denicola"},"bug_when":"2014-02-13 01:50:19 -0800","thetext":"That is a great point. Thanks for reopening. I will have to investigate further and make sure we have a consistent model here.\n\nMy guess is we will move to using `constructor` in the Promise Resolution Handler functions. But I will need to devote more time to it, soon."},{"commentid":11741,"comment_count":5,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-01-28 14:30:21 -0800","thetext":"Domenic,\n\nDo you have an additional response to this, particularly given the availability of @@species.\n\nI'd like to get this closed before wrapping up E6."},{"commentid":11871,"comment_count":6,"who":{"uid":"d","name":"Domenic Denicola"},"bug_when":"2015-02-02 09:32:51 -0800","thetext":"Thanks for the ping.\n\nIt looks to me after re-tracing the spec that the inconsistency here has been eliminated, probably via some of the refactorings that have happened over time.\n\nThe [[PromiseConstructor]] now only appear in the one place I thought it did (viz. Promise.resolve). And just to be sure, I also traced through the logic in comment #2 and found that these days only type B is involved---no promise of type A is created.\n\nSo I think this can be closed."},{"commentid":11891,"comment_count":7,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-02 16:13:06 -0800","thetext":"fixed sometime in 2014"}]}}
---
