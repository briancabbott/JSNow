---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":3684,"creation_ts":"2015-01-28 16:22:00 -0800","short_desc":"9.2.3 [[Construct]], step 14: Handle explicit return with no value for derived constructor","delta_ts":"2015-02-12 12:17:38 -0800","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 31: January 15, 2015 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":{"uid":"claude.pache","name":"Claude Pache"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":"andrebargull","long_desc":[{"commentid":11742,"comment_count":0,"who":{"uid":"claude.pache","name":"Claude Pache"},"bug_when":"2015-01-28 16:22:06 -0800","thetext":"If I follow the algorithms correctly, when the body of a derived constructor is terminated with a bare `return` (without value), a TypeError is thrown at step 14.c, instead of returning the this-binding.\n\nA step should added before that step (imitating step 16):\n\n  14.c If kind is \"derived\" and result.[[value]] is undefined, return the result of calling the GetThisBinding concrete method of.envRec’s with no arguments."},{"commentid":11746,"comment_count":1,"who":{"uid":"claude.pache","name":"Claude Pache"},"bug_when":"2015-01-28 19:41:08 -0800","thetext":"(hum...)\n\n... the GetThisBinding concrete method of envRec with no arguments.\n\n(also to be corrected in step 16)"},{"commentid":11748,"comment_count":2,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-01-29 02:35:45 -0800","thetext":"The proposed change and tail-call semantics may not play along nicely. If OrdinaryCallEvaluateBody returns from a tail-call, calleeContext is no longer the current execution context and any resource tied to calleeContext has been released (or reused) [14.6.3 PrepareForTailCall]. I'd say the environment record is a resource which is tied to an execution context and therefore it's not valid to access `envRec` in step 14."},{"commentid":11750,"comment_count":3,"who":{"uid":"claude.pache","name":"Claude Pache"},"bug_when":"2015-01-29 04:16:19 -0800","thetext":"(In reply to André Bargull from comment #2)\n> The proposed change and tail-call semantics may not play along nicely.\n\nYes, you're right: it will break in case of:\n\n    return functionThatReturnsUndefined()\n\nSo, here is another solution I've thought of: It consists of redefining the semantics of:\n\n    ReturnStatement : return ;\n\n(in section 13.9.1 The Return Statement / Runtime semantics), so that `return;` becomes equivalent to `return this;` when we are running a constructor.\n\nConcretely, the runtime semantics of `return;` would be approximately modified as follows:\n\n1. Let envRec be the environment record of the current execution context's VariableEnvironment (if any).\n2. If envRec.[[NewTarget]] is not null,\n  a. Let result be envRec.GetThisBinding().\n  b. ReturnIfAbrupt(result).\n  c. Return Completion{[[type]]: return, [[value]]: result, [[target]]: empty}.\n3. Return Completion{[[type]]: return, [[value]]: undefined, [[target]]: empty}."},{"commentid":12200,"comment_count":4,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-06 16:58:17 -0800","thetext":"I think what this really is pointing out is that you can't do a tail call from a [[Construct]] invocation because there is always constructor specific processing that needs to be done after returning from the call in the return statement.\n\nThis was true, even before the recent changes.  The real bug is that the spec. was allowing such tail calls."},{"commentid":12201,"comment_count":5,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-06 17:35:16 -0800","thetext":"fixed in rev33 editor's draft\n\nfixed the return undefined base for derived constructors\n\nnew and super() expressions are no longer tail calls."},{"commentid":12426,"comment_count":6,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-12 12:17:38 -0800","thetext":"fixed in rev33"}]}}
---
