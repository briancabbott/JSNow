---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":4004,"creation_ts":"2015-02-18 15:07:00 -0800","short_desc":"22.2.3.22.1 %TypedArray%.prototype.set: Remove length integer validation and use ToLength ?","delta_ts":"2015-02-19 19:10:51 -0800","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 33: February 12, 2015 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"enhancement","everconfirmed":true,"reporter":{"uid":"andrebargull","name":"André Bargull"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"long_desc":[{"commentid":12932,"comment_count":0,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-02-18 15:07:30 -0800","thetext":"22.2.3.22.1 %TypedArray%.prototype.set\n\nSteps 18-22\n\nMaybe change to:\n---\nLet srcLength be ToLength(Get(src, \"length\")).\nReturnIfAbrupt(srcLength).\n---\n\nfor consistency with other %TypedArray% methods which access \"length\" on an input value."},{"commentid":12947,"comment_count":1,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-18 16:09:40 -0800","thetext":"ToLength would loose the <0 exception in step 22.\n\nHowever, it does appear that the numerLength != srcLength isn't wanted, so I fixed that"},{"commentid":12949,"comment_count":2,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-02-18 16:23:00 -0800","thetext":"(In reply to Allen Wirfs-Brock from comment #1)\n> ToLength would loose the <0 exception in step 22.\n\nWhy is it important to handle negative length values in this method? For example when you call `new Int8Array({length: -10})` the negative length is simply clamped to zero."},{"commentid":12952,"comment_count":3,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-18 16:34:58 -0800","thetext":"(In reply to André Bargull from comment #2)\n> (In reply to Allen Wirfs-Brock from comment #1)\n> > ToLength would loose the <0 exception in step 22.\n> \n> Why is it important to handle negative length values in this method? For\n> example when you call `new Int8Array({length: -10})` the negative length is\n> simply clamped to zero.\n\nHere's what I get in FF:\n\n new Int8Array({length: -10});\n/*\nException: size and count too large\n@Scratchpad/1:1:2\n*/\n\nwhich suggests it is doing a ToUint32 conversion on length\n\nIf it really is interop crazy land out there WRT these things, maybe we can consistently use the ToLength conversion"},{"commentid":12960,"comment_count":4,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-02-19 03:49:00 -0800","thetext":"(In reply to Allen Wirfs-Brock from comment #3)\n> If it really is interop crazy land out there WRT these things, maybe we can\n> consistently use the ToLength conversion\n\nJavaScriptCore and SpiderMonkey use ToUint32:\nhttps://github.com/WebKit/webkit/blob/d8a2db3a06fee9ea133698eaad030f3a9d7b2cb2/Source/JavaScriptCore/runtime/JSGenericTypedArrayViewPrototypeInlines.h#L59\nhttps://dxr.mozilla.org/mozilla-central/source/js/src/vm/TypedArrayCommon.h#695-697\n\nV8 uses... err nothing?\nhttps://github.com/v8/v8-git-mirror/blob/64a2717529e2197f3a789adabf86ca36f5eb764c/src/typedarray.js#L275-L288\nhttps://github.com/v8/v8-git-mirror/blob/64a2717529e2197f3a789adabf86ca36f5eb764c/src/typedarray.js#L190-L201\n\nFrom the v8 shell:\nd8> new Int8Array(10).set({length: {valueOf: function(){ print(\"aah\"); return 5; }}})\naah\naah\naah\naah\naah\naah\naah"},{"commentid":12977,"comment_count":5,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-19 11:47:27 -0800","thetext":"in rev34 editor's draft\n\nswitched to ToLength."},{"commentid":13002,"comment_count":6,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-19 19:10:51 -0800","thetext":"fixed in rev34"}]}}
---
