---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":3778,"creation_ts":"2015-02-05 14:03:00 -0800","short_desc":"25.4.4.1.1 PerformPromiseAll: Change to full completion record access ?","delta_ts":"2015-02-12 12:17:35 -0800","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 32: February 2, 2015 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":{"uid":"andrebargull","name":"André Bargull"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":"d","long_desc":[{"commentid":12148,"comment_count":0,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-02-05 14:03:14 -0800","thetext":"25.4.4.1.1 PerformPromiseAll( iterator, constructor, resultCapability) Abstract Operation\n\nStep 7.c.ii.3.\n\n> , return NormalCompletion(resolveResult).\n\n\nImplicit access to the [[value]] field of completion records is typically only used for normal completions. For abrupt completions the `.[[value]]` syntax is used instead.\n\nMaybe change to `NormalCompletion(resolveResult.[[value]])` ?\n\n\nAlso cc'ed Domenic to check the new semantic for PerformPromiseAll when the call to [[Resolve]] in step 7.c.ii.2 results in an abrupt completion."},{"commentid":12149,"comment_count":1,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-02-05 14:10:30 -0800","thetext":"Test case for the changed semantics:\n---\nfunction P(executor) {\n  executor(() => { throw \"hi!\" }, () => {});\n}\nconsole.log(Promise.all.call(P, [])); // Prints \"hi!\".\n---"},{"commentid":12176,"comment_count":2,"who":{"uid":"d","name":"Domenic Denicola"},"bug_when":"2015-02-05 19:34:26 -0800","thetext":"Yes, this does look suspicious, and against the original design of Promise.all. I think that step should just be ReturnIfAbrupt(resolveResult). Allen, any reason for this change, or was it just a refactoring issue?"},{"commentid":12179,"comment_count":3,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-05 20:58:34 -0800","thetext":"(In reply to Domenic Denicola from comment #2)\n> Yes, this does look suspicious, and against the original design of\n> Promise.all. I think that step should just be ReturnIfAbrupt(resolveResult).\n> Allen, any reason for this change, or was it just a refactoring issue?\n\nWhat this all trying to do is avoid the IteratorClose call in 25.4.4.1 step 11.a when an exception occurs in 7.c.ii.3 (after the iteral is has been drained).\n\nThe normal completion causes steps 11.a and 11.b to be skipped.\n\nAnd the value return in step 12 is the original resolveResult abrupt completion from 7.c.ii.3 -- effectively the same as the ReturnIfAbrupt that used to there\n\nAdmittedly this is playing fast and loose with completion record conventions, but that it almost does what I want..."},{"commentid":12180,"comment_count":4,"who":{"uid":"d","name":"Domenic Denicola"},"bug_when":"2015-02-05 21:03:13 -0800","thetext":"Oh, I think I see... it's a normal completion whose .[[value]] is an abrupt completion?!? So comment #1's test case isn't quite correct?\n\nSneaky.\n\n(I still don't understand why iterator.close() isn't called at the end of every for-on loop, but instead only for abrupt completions... but that's my problem.)"},{"commentid":12181,"comment_count":5,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-02-06 02:51:03 -0800","thetext":"(In reply to Allen Wirfs-Brock from comment #3)\n> Admittedly this is playing fast and loose with completion record\n> conventions, but that it almost does what I want...\n\nJust like Domenic said, that's sneaky! Fortunately completion records don't allow this construction. ([[value]] is restricted to ECMAScript language values or empty.)"},{"commentid":12184,"comment_count":6,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-06 08:56:48 -0800","thetext":"fixed in rev33 editor's draft\n\nOk, took away the cleverness (never a good idea in a specification) and made it explicit"},{"commentid":12396,"comment_count":7,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-12 12:17:35 -0800","thetext":"fixed in rev33"}]}}
---
