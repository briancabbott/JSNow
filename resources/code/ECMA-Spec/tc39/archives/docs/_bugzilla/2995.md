---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":2995,"creation_ts":"2014-06-23 00:41:00 -0700","short_desc":"15.2.5.2.3 UpdateLinkSetOnLoad 5 startingLoad can be undefined","delta_ts":"2015-03-16 14:33:01 -0700","product":"Draft for 6th Edition","component":"deferred features","version":"Rev 25: May 22, 2014 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"WONTFIX","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":{"uid":"guybedford","name":"Guy Bedford"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":["dherman","jorendorff","samth"],"long_desc":[{"commentid":9068,"comment_count":0,"who":{"uid":"guybedford","name":"Guy Bedford"},"bug_when":"2014-06-23 00:41:41 -0700","thetext":"This has been a very hard bug to track down that's caused loading stalling for quite some time in roughly once every 30 runs of the loader polyfill test cases.\n\nThe scenario happens when updateLinkSetOnLoad triggers linking of LinkSets one by one.\n\nBasically, it is possible for a LinkSet to be cleared of loads through finishLoad, where the linkSet itself has not resolved yet, making the linkSet startingLoad in updateLinkSetOnLoad undefined, resolving the linkSet to resolve to undefined, resulting in LoadModule returning an undefined load record.\n\nI've described the test case below. There is certainly a simpler example than this, but this is the one that I've actually been able to catch.\n\nConsider a tree where A depends on D, B depends on A, C depends on B.\n\nThe Linksets when almost fully loaded look like:\n\nload record: linkSets\nA: {A D} {C B A D} {C A D}\nB: {B A D} {C B A D}\nC: {C B A D}\nD: {A D} {C B A D} {B A D}\n\nA, B, C have all called LoadSucceeded in the above, and UpdateLinkSetOnLoad. That is, we are just waiting on D to finish the load.\n\nD hits LoadSucceeded, and has no dependencies to contribute.\n\nIt then runs UpdateLinkSetOnLoad for each of its linksets, cloning this list before running it.\n\nIt first runs UpdateLinkSetOnLoad for the linkset {A D} resulting in this linkset linking and removing its records from the list through a finishLoad call for both A and D, thus we now have:\n\nload record: linkSets\nA: {C B} {C}\nB: {B} {C B}\nC: {C B}\nD: {C B} {B}\n\nWe now run UpdateLinkSetOnLoad for {C B} resulting in calling finishLoad for both C and B. We have now cleared all the linksets.\n\nFinally, we get to our last linkSet in the cloned list to run UpdateLinkSetOnLoad, which was {B} above, but it has been cleared already since B has finished loading.\n\nBut LinkSets resolve to their starting load, so we resolve this linkset to undefined.\n\nAs a result, System.import(\"B\"), which has run LoadModule, gets an undefined load record back for its promise though AsyncStartLoadPartwayThrough resolving to this linkSet.\n\n---\n\nIn terms of a fix, not clearing the first load of a linkSet in finishLoad seems to resolve the issue.\n\nThat is, in 15.2.5.2.5 4.a, ensure that load is not the first element of linkSet.[[Loads]] first.\n\nThis fix is by no means ideal and it breaks the final assertion in UpdateLinkSetOnLoad that the loads have been cleared.\n\nThere is most likely a better fix. As mentioned I'd be happy to assist, just let me what I can do further to help."},{"commentid":9069,"comment_count":1,"who":{"uid":"guybedford","name":"Guy Bedford"},"bug_when":"2014-06-23 00:48:30 -0700","thetext":"A better fix is to store linkSet.startingLoad during createLinkSet, and to use this instead of linkSet.loads[0] in UpdateLinkSetOnLoad.\n\nNote that we should be careful not to try to link an empty linkSet then too."},{"commentid":13758,"comment_count":2,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-16 14:33:01 -0700","thetext":"concerns old module spec."}]}}
---
