---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":264,"creation_ts":"2012-02-10 23:52:00 -0800","short_desc":"Support for changing the prototype of an object using `Object.setPrototypeOf`","delta_ts":"2013-10-10 13:13:15 -0700","product":"Harmony","component":"Suggestions","version":"unspecified","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"enhancement","everconfirmed":true,"reporter":{"uid":"aaditmshah","name":"Aadit M Shah"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":["bluepx+ecmascriptBugs","dave","ecmascript.org","ivan4th"],"long_desc":[{"commentid":637,"comment_count":0,"attachid":"9","who":{"uid":"aaditmshah","name":"Aadit M Shah"},"bug_when":"2012-02-10 23:52:43 -0800","thetext":"Created attachment 9\nDemo of the advantages of being able to explicitly set the prototype of an object.\n\nBrowsers support a non-standard deprecated property called `__proto__` on objects. This property points to the prototype of the object, and it's both readable and writable.\n\nSince the `__proto__` property deprecated, JavaScript engines like Rhino don't support it. Instead they support a method `Object.getPrototypeOf` to get the prototype of an object.\n\nHowever, Rhino doesn't allow the prototype of an object to be changed. To do so I suggest the implementation of a method `Object.setPrototypeOf` which would allow the internal `[[proto]]` property of an object to be changed iff it's not sealed or frozen.\n\nSyntax: `Object.setPrototypeOf(object, prototype)`\n\nBeing able to change the internal `[[proto]]` property of an object has many advantages. For example, in some cases it's necessary to return functions from constructors. This is only possible in JavaScript if we use the constructor as a factory. However since the factory returns a function it wouldn't be an instance of the constructor, and wouldn't be able to share methods on its prototype:\n\n    Counter.prototype = function () {};              // Allow `instanceof Function` to return `true`, as well as `call`, `apply`, etc to be used.\n    Counter.prototype.constructor = Counter;         // Reset the `constructor` property of the prototype to point to the constructor `Counter`.\n    Counter.prototype.reset = function () {\n        while (this() < this.max);\n    };\n    \n    var counter = new Counter(3);\n    \n    alert(counter());                                // 1\n    counter.reset();\n    \n    alert(counter());                                // 1\n    alert(counter());                                // 2\n    counter.reset();\n    \n    alert(counter());                                // 1\n    alert(counter());                                // 2\n    alert(counter());                                // 3\n    \n    function Counter(max) {\n        var count = 0;\n    \n        counter.max = Math.abs(parseInt(max)) || 1; \n    \n        counter.__proto__ = Counter.prototype;       // Setting the internal `[[proto]]` property of the function being returned to the prototype of the constructor.\n    \n        return counter;\n    \n        function counter() {\n            if (count < counter.max) return ++count;\n            else return count = 1;\n        }\n    }\n\nThis program will not work on Rhino because on line 6 we are setting `counter.__proto__` to `Counter.prototype`. However since the `__proto__` property is not supported in Rhino, the prototype of `Counter` is never added to the prototype chain. Hence calling `counter.reset` would throw a `TypeError` since we are attempting to invoke `undefined`. To solve this problem we should use `Object.setPrototypeOf`:\n\n    Counter.prototype = function () {};                    // Allow `instanceof Function` to return `true`, as well as `call`, `apply`, etc to be used.\n    Counter.prototype.constructor = Counter;               // Reset the `constructor` property of the prototype to point to the constructor `Counter`.\n    Counter.prototype.reset = function () {\n        while (this() < this.max);\n    };\n    \n    var counter = new Counter(3);\n    \n    print(counter());                                      // 1\n    counter.reset();\n    \n    print(counter());                                      // 1\n    print(counter());                                      // 2\n    counter.reset();\n    \n    print(counter());                                      // 1\n    print(counter());                                      // 2\n    print(counter());                                      // 3\n    \n    function Counter(max) {\n        var count = 0;\n    \n        counter.max = Math.abs(parseInt(max)) || 1; \n    \n        Object.setPrototypeOf(counter, Counter.prototype); // Setting the internal `[[proto]]` property of the function being returned to the prototype of the constructor.\n    \n        return counter;\n    \n        function counter() {\n            if (count < counter.max) return ++count;\n            else return count = 1;\n        }\n    }\n\nI sincerely hope this proposal will be taken into consideration. Being able to set the prototype of an object has a lot of uses. Allow programmers all over the world to make the best possible use of this new feature."},{"commentid":638,"comment_count":1,"who":{"uid":"aaditmshah","name":"Aadit M Shah"},"bug_when":"2012-02-11 00:05:22 -0800","thetext":"http://stackoverflow.com/q/9238737/783743"},{"commentid":662,"comment_count":2,"who":{"uid":"ecmascript.org","name":"Ovidiu"},"bug_when":"2012-02-24 08:21:11 -0800","thetext":"I can confirm this would be very useful. Another reason to add it is that developers might want to extend a class that's not yet defined. For example:\n\ndefine B\n\ndefine A\n\nextend B from A\n\nWhich is easily achievable with __proto__"},{"commentid":663,"comment_count":3,"who":{"uid":"bluepx+ecmascriptBugs","name":"Daniel"},"bug_when":"2012-02-24 08:30:15 -0800","thetext":"This is also the only way to set up circular prototype chains, e.g. the way the classes Object and Function inherit each other in EcmaScript."},{"commentid":749,"comment_count":4,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2012-03-12 17:41:52 -0700","thetext":"Moved to Harmony Product because this isn't a bug in the ES5/5.1 spec. Intead, this is a request for a new feature."},{"commentid":951,"comment_count":5,"who":{"uid":"dave","name":"David Rees"},"bug_when":"2012-05-19 18:02:37 -0700","thetext":"Another use case is when working with JSON and DB/PubSub libraries that sit on it. People commonly turn around and copy the structure again just to get it into an object with behavior. Simply swapping the initial object's proto would be much faster/cleaner."},{"commentid":5891,"comment_count":6,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2013-10-10 13:13:15 -0700","thetext":"Object.setPrototypeOf is included in ES6"}],"attachment":[{"_attributes":{"isobsolete":"0","ispatch":"0"},"attachid":"9","date":"2012-02-10 23:52:00 -0800","delta_ts":"2012-02-10 23:52:43 -0800","desc":"Demo of the advantages of being able to explicitly set the prototype of an object.","filename":"counter.html","type":"text/html","size":"1610","attacher":{"_attributes":{"name":"Aadit M Shah"},"_text":"aaditmshah"},"data":{"_attributes":{"encoding":"base64"},"_text":"PCFET0NUWVBFIGh0bWw+DQo8aHRtbCBsYW5nPSJlbiI+DQogIDxoZWFkPg0KICAgIDxtZXRhIGNo\nYXJzZXQ9IlVURi04Ii8+DQogICAgPHRpdGxlPkNvdW50ZXI8L3RpdGxlPg0KICAgIDxzY3JpcHQ+\nDQogICAgICAgIENvdW50ZXIucHJvdG90eXBlID0gZnVuY3Rpb24gKCkge307ICAgICAgICAgICAg\nICAvLyBBbGxvdyBgaW5zdGFuY2VvZiBGdW5jdGlvbmAgdG8gcmV0dXJuIGB0cnVlYCwgYXMgd2Vs\nbCBhcyBgY2FsbGAsIGBhcHBseWAsIGV0YyB0byBiZSB1c2VkLg0KICAgICAgICBDb3VudGVyLnBy\nb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENvdW50ZXI7ICAgICAgICAgLy8gUmVzZXQgdGhlIGBjb25z\ndHJ1Y3RvcmAgcHJvcGVydHkgb2YgdGhlIHByb3RvdHlwZSB0byBwb2ludCB0byB0aGUgY29uc3Ry\ndWN0b3IgYENvdW50ZXJgLg0KICAgICAgICBDb3VudGVyLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0\naW9uICgpIHsNCiAgICAgICAgICAgIHdoaWxlICh0aGlzKCkgPCB0aGlzLm1heCk7DQogICAgICAg\nIH07DQogICAgICAgIA0KICAgICAgICB2YXIgY291bnRlciA9IG5ldyBDb3VudGVyKDMpOw0KICAg\nICAgICANCiAgICAgICAgYWxlcnQoY291bnRlcigpKTsgICAgICAgICAgICAgICAgICAgICAgICAg\nICAgICAgIC8vIDENCiAgICAgICAgY291bnRlci5yZXNldCgpOw0KICAgICAgICANCiAgICAgICAg\nYWxlcnQoY291bnRlcigpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDENCiAg\nICAgICAgYWxlcnQoY291bnRlcigpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8v\nIDINCiAgICAgICAgY291bnRlci5yZXNldCgpOw0KICAgICAgICANCiAgICAgICAgYWxlcnQoY291\nbnRlcigpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDENCiAgICAgICAgYWxl\ncnQoY291bnRlcigpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDINCiAgICAg\nICAgYWxlcnQoY291bnRlcigpKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDMN\nCiAgICAgICAgDQogICAgICAgIGZ1bmN0aW9uIENvdW50ZXIobWF4KSB7DQogICAgICAgICAgICB2\nYXIgY291bnQgPSAwOw0KICAgICAgICANCiAgICAgICAgICAgIGNvdW50ZXIubWF4ID0gTWF0aC5h\nYnMocGFyc2VJbnQobWF4KSkgfHwgMTsgDQogICAgICAgIA0KICAgICAgICAgICAgY291bnRlci5f\nX3Byb3RvX18gPSBDb3VudGVyLnByb3RvdHlwZTsgICAgICAgLy8gU2V0dGluZyB0aGUgaW50ZXJu\nYWwgYFtbcHJvdG9dXWAgcHJvcGVydHkgb2YgdGhlIGZ1bmN0aW9uIGJlaW5nIHJldHVybmVkIHRv\nIHRoZSBwcm90b3R5cGUgb2YgdGhlIGNvbnN0cnVjdG9yLg0KICAgICAgICANCiAgICAgICAgICAg\nIHJldHVybiBjb3VudGVyOw0KICAgICAgICANCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvdW50ZXIo\nKSB7DQogICAgICAgICAgICAgICAgaWYgKGNvdW50IDwgY291bnRlci5tYXgpIHJldHVybiArK2Nv\ndW50Ow0KICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIGNvdW50ID0gMTsNCiAgICAgICAgICAg\nIH0NCiAgICAgICAgfQ0KICAgIDwvc2NyaXB0Pg0KICA8L2hlYWQ+DQogIDxib2R5Pg0KICA8L2Jv\nZHk+DQo8L2h0bWw+DQo=\n"}}]}}
---
