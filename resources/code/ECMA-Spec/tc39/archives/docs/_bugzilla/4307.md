---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":4307,"creation_ts":"2015-04-16 14:52:00 -0700","short_desc":"9.2.5 ResolveLocale","delta_ts":"2015-04-29 09:05:55 -0700","product":"Internationalization - ECMA-402","component":"Specification","version":"Edition 2.0 drafts","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":{"uid":"andrebargull","name":"André Bargull"},"assigned_to":{"uid":"waldron.rick","name":"Rick Waldron"},"cc":"waldron.rick","long_desc":[{"commentid":14262,"comment_count":0,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-04-16 14:52:28 -0700","thetext":"9.2.5 ResolveLocale (availableLocales, requestedLocales, options, relevantExtensionKeys,\nlocaleData)\n\n\nStep 6.c: Unsafe use of %StringProto_split%, user code may have added a custom `String.prototype[Symbol.split]` function.\n\nI don't know an elegant way to resolve this, the ugly workaround is:\n\n> Let strExtension be StringCreate(extension, null).\n> Perform CreateDataProperty(strExtension, %StringProto_toString%).\n> Let extensionSubtags be Call(%StringProto_split%, strExtension, «\"-\"»).\n\n\nStep 6.d: Unnecessary ToObject call, invalid CreateArrayFromList call.\nStep 6.d: Change \").\" to normal instead bold font.\n\nStep 11: Unnecessary ToObject call\nStep 11: Typo \"ArrayCreateFromList\" -> \"CreateArrayFromList\"\n\nStep 12: Unnecessary ReturnIfAbrupt, CreateArrayFromList is not fallible.\n\nStep 13: Change \").\"  to normal instead bold font.\n\nSteps 13-14: Merge steps\n> Let len be ToLength(Get(rExtensionKeys, \"length\")).\n\n\nStep 15.j.i: Typo \"%StringProto_indexOf%\" -> \"%ArrayProto_indexOf%\" (`extensionSubtags` is an Array object).\n\nStep 15.j.ii.1: This Get() call only needs to happen if `keyPos + 1 < extensionSubtagsLength`, otherwise an index greater than the array length is accessed which is observable if accessor properties on Array.prototype or anywhere along the prototype chain are present.\n\nStep 15.j.ii.2: Change `extensionSubtagsKeyPos` to italic font.\n\nStep 15.j.ii.3.b: Unsafe use of %StringProto_includes%, user code may have added `String.prototype[Symbol.match]`.\n\nStep 15.j.ii.4: Unsafe use of %StringProto_includes%, user code may have added `String.prototype[Symbol.match]`.\nStep 15.j.ii.4: Duplicate comma\n\nStep 15.k.iii: Unsafe use of %StringProto_includes%, user code may have added `String.prototype[Symbol.match]`.\n\nStep 16: Invalid use of CreateArrayFromList\n> 16. If the number of elements in supportedExtension is greater than 2, then"},{"commentid":14276,"comment_count":1,"who":{"uid":"waldron.rick","name":"Rick Waldron"},"bug_when":"2015-04-16 20:16:35 -0700","thetext":"This requires a lot of changes to this operation that I'm not comfortable making this late in process. All the \"unsafe\" markings don't make sense considering they are defined as the \"initial value\"—it's just a specification mechanism, so it doesn't matter if user code changes anything. This practice is something that Allen and I discussed at length before I started incorporating it into the document. I'm going to fix the typos and smaller technical corrections, but I'm not going to rewrite all the uses of intrinsics."},{"commentid":14277,"comment_count":2,"who":{"uid":"waldron.rick","name":"Rick Waldron"},"bug_when":"2015-04-16 20:30:49 -0700","thetext":">Step 6.d: Unnecessary ToObject call, invalid CreateArrayFromList call.\n>Step 6.d: Change \").\" to normal instead bold font.\n>Step 11: Unnecessary ToObject call\n>Step 11: Typo \"ArrayCreateFromList\" -> \"CreateArrayFromList\"\n>Step 12: Unnecessary ReturnIfAbrupt, CreateArrayFromList is not fallible.\n>Step 13: Change \").\"  to normal instead bold font.\n> Steps 13-14: Merge steps\n> Let len be ToLength(Get(rExtensionKeys, \"length\")).\n> Step 15.j.i: Typo \"%StringProto_indexOf%\" -> \"%ArrayProto_indexOf%\" \n> (`extensionSubtags` is an Array object).\n\n>Step 15.j.ii.1: This Get() call only needs to happen if `keyPos + 1 < extensionSubtagsLength`, otherwise an index greater than the array length is accessed which is observable if accessor properties on Array.prototype or anywhere along the prototype chain are present.\n\n> Step 16: Invalid use of CreateArrayFromList\n> 16. If the number of elements in supportedExtension is greater than 2, then\n\nFixed.\n\n\n\nArrayProto_indexOf added to well known intrinsics extensions table."},{"commentid":14333,"comment_count":3,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-04-29 09:05:55 -0700","thetext":"(In reply to Rick Waldron from comment #1)\n> This requires a lot of changes to this operation that I'm not comfortable\n> making this late in process. All the \"unsafe\" markings don't make sense\n> considering they are defined as the \"initial value\"—it's just a\n> specification mechanism, so it doesn't matter if user code changes anything.\n> This practice is something that Allen and I discussed at length before I\n> started incorporating it into the document. I'm going to fix the typos and\n> smaller technical corrections, but I'm not going to rewrite all the uses of\n> intrinsics.\n\n9.2.5 ResolveLocale calls %StringProto_split% with Type(extension) = String.\n\nES2015, rev38, 21.1.3.17 String.prototype.split, step 3:\n---\n3. If separator is not undefined, then\n  a. Let splitter be GetMethod(separator, @@split).\n  b. ReturnIfAbrupt(splitter).\n  c. If splitter is not undefined , then\n    i. Return Call(splitter, separator, «‍O, limit»).\n---\n\nSo the String.prototype.split `separator` parameter is a string value. If a user has added `String.prototype[Symbol.split] = () => []`, step 3.a returns that arrow function and step 3.a.i is executed. That means the `extensionSubtags` variable in ResolveLocale is always an empty array - independent of its input parameters. \n\n\nAnd I was wrong about %StringProto_includes%: %StringProto_includes% is safe to use, I didn't check that IsRegExp returns false for non-object types."}]}}
---
