---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":1898,"creation_ts":"2013-09-13 10:20:00 -0700","short_desc":"Provide separation of global this and global object","delta_ts":"2015-12-04 15:54:30 -0800","product":"Draft for 7th Edition","component":"Deferred from 6th edition","version":"unspecified","rep_platform":"All","op_sys":"All","bug_status":"CONFIRMED","priority":"Normal","bug_severity":"enhancement","everconfirmed":true,"reporter":{"uid":"annevk","name":"Anne van Kesteren"},"assigned_to":{"uid":"d","name":"Domenic Denicola"},"cc":["bzbarsky","d","dherman","ian","m.goleb","mathias","till"],"long_desc":[{"commentid":5394,"comment_count":0,"who":{"uid":"annevk","name":"Anne van Kesteren"},"bug_when":"2013-09-13 10:20:35 -0700","thetext":"Currently HTML overrides ES to say that this is WindowProxy whereas the global object is Window. If this is made configurable for realms we'd have one less issue there.\n\nRelated to bug 78 per Brendan."},{"commentid":8113,"comment_count":1,"who":{"uid":"till","name":"Till Schneidereit"},"bug_when":"2014-05-04 10:39:08 -0700","thetext":"The latest draft adds the ability to pass a proxy target and handler into the Realm constructor. If that is done, a proxy is created as the global object instead of a normal object. Is that enough to cover the requirements here, or is a WindowProxy sufficiently different from an ES Proxy that more is needed?"},{"commentid":8150,"comment_count":2,"who":{"uid":"annevk","name":"Anne van Kesteren"},"bug_when":"2014-05-06 05:09:53 -0700","thetext":"Ian or Boris may be able to answer that question."},{"commentid":8151,"comment_count":3,"who":{"uid":"annevk","name":"Anne van Kesteren"},"bug_when":"2014-05-06 05:14:15 -0700","thetext":"Figuring out the answer to the question in comment 1 does seem important before we declare all this stable."},{"commentid":8670,"comment_count":4,"who":{"uid":"dherman","name":"Dave Herman"},"bug_when":"2014-05-29 14:35:53 -0700","thetext":"OK I educated myself. Here's the gist of it: a single frame can navigate from one page to another, and those pages can call each others' global functions, even if some of the pages are not the active page in the frame. All of those pages actually have the *same* (===) global `this` object, which acts like a proxy to whatever the current active page in the frame is. But unbound variables are always interpreted relative to the page they came from. So calling a function on an inactive page can get divergent behavior between the global `this` and global variables. Here's an example:\n\nhttps://gist.github.com/dherman/82ca22b2ecc506d01182\n\nThe current realm API is almost sufficient to reflect all this, except that it doesn't let you specify a distinct `this` object. I think the fix here is, basically as Anne says, to allow you to independently specify a second object that acts as the global `this`. Currently the Realm constructor takes unnamed optional arguments for creating a global proxy, and we now need an optional `this` object (which should default to whatever the global object is), so I think we probably need to go back to named arguments, something like:\n\nnew Realm({\n  target: globalProxyTarget,\n  handler: globalProxyHandler,\n  this: globalThis\n})\n\nAFAICT the only implication this degree of flexibility has for engine implementations is that global `this` (which is trivially statically recognizable) gets pointed to a different object, so I don't think it should cause any implementation difficulties.\n\nDave"},{"commentid":8687,"comment_count":5,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-05-30 00:37:22 -0700","thetext":"(In reply to comment #4)\n> OK I educated myself. Here's the gist of it: a single frame can navigate from\n> one page to another, and those pages can call each others' global functions,\n> even if some of the pages are not the active page in the frame. All of those\n> pages actually have the *same* (===) global `this` object, which acts like a\n> proxy to whatever the current active page in the frame is. But unbound\n> variables are always interpreted relative to the page they came from. So\n> calling a function on an inactive page can get divergent behavior between the\n> global `this` and global variables. Here's an example:\n\nTo clarify, are you saying that:\n\nvar activePageObj = new this.Object;//creates a new object\n                                    // in the Realm of active page\n\nvar currentFrameObj = new Object; //create a new object\n                                  // in the Realm of the current frame\n\n\nIn other words, all global identifier bindings (including the default globals) are resolved using the Realm of the referencing code and that those bindings are not necessarily the same as the properties of the global this that is visible to that code.\n\nAnother example:\n\nif ('foo' in this ===undefined) this.foo = \"defined\";\nconsole.log(foo===undefined);  //may be either true or false depending upon\n                               //the relationship of globalThis and global env\n\n> \n> \n> new Realm({\n>   target: globalProxyTarget,\n>   handler: globalProxyHandler,\n>   this: globalThis\n> })\n> \n> AFAICT the only implication this degree of flexibility has for engine\n> implementations is that global `this` (which is trivially statically\n> recognizable) gets pointed to a different object, so I don't think it should\n> cause any implementation difficulties.\n> \n> Dave\n\nNote that RealmRecord (the spec. abstraction that backs Realm objects) http://people.mozilla.org/~jorendorff/es6-draft.html#table-20 already capture both a [[globalThis]] references and a [[globalEnv]] reference where [[globalEnv]] is  GlobalEnvironmentReport that is used to capture and resolve global declarations from within the  Realm. \n\nHowever, [[globalEnv]] is currently always initialized (http://people.mozilla.org/~jorendorff/es6-draft.html#sec-setrealmglobalobj) to use the value of [[globalThis]] as the object component of the [[globalEnv]].  It sounds like that may need  to  changed."},{"commentid":12553,"comment_count":6,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-13 10:09:46 -0800","thetext":"deferred to ES7\n\nThe whole window/windowProxy thing..."}]}}
---
