---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":3025,"creation_ts":"2014-07-22 02:18:00 -0700","short_desc":"9.5.12 [[OwnPropertyKeys]]: Mutable keys array can violate object invariants","delta_ts":"2014-08-25 08:29:30 -0700","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 26: July 18, 2014 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":{"uid":"andrebargull","name":"André Bargull"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":["erights","tomvc.be"],"long_desc":[{"commentid":9456,"comment_count":0,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2014-07-22 02:18:49 -0700","thetext":"9.5.12  [[OwnPropertyKeys]] ( )\n\nThe array returned from ownKeys() can be mutated after all invariant checks were performed in 9.5.12. That way it is still possible to violate the object invariants from 6.1.7.3.\n\n\nTest case:\n---\nlet o = Object.defineProperty({}, \"prop\", {value: 123, configurable: false});\nlet p = new Proxy(o, {\n  ownKeys() {\n    return Object.defineProperty([], \"0\", {\n      get() {\n        // Alternatively return a different property name here.\n        this.length = 0;\n        return \"prop\";\n      }, configurable: true\n    });\n  }\n});\nprint(\"own-names:\", Object.getOwnPropertyNames(p));\n---"},{"commentid":9477,"comment_count":1,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-07-22 11:03:41 -0700","thetext":"Tom, Mark\nWhat do you think?\n\nThe cleanest way I can think of for fixing this would be to respecify [[OwnPropertyKey]] as returning a List rather than an array. Of course a trap handler would still return an Array but Proxy [[OwnPropertyKey]] would convert it to a List before performing its other invariant checks.\n\nThe array to list conversion could also be used to enforce  the invariant the elements are all valid property keys (strings or symbols). Se Bug 3026"},{"commentid":9480,"comment_count":2,"who":{"uid":"erights","name":"Mark Miller"},"bug_when":"2014-07-22 11:17:07 -0700","thetext":"(In reply to Allen Wirfs-Brock from comment #1)\n> Tom, Mark\n> What do you think?\n> \n> The cleanest way I can think of for fixing this would be to respecify\n> [[OwnPropertyKey]] as returning a List rather than an array. Of course a\n> trap handler would still return an Array but Proxy [[OwnPropertyKey]] would\n> convert it to a List before performing its other invariant checks.\n> \n> The array to list conversion could also be used to enforce  the invariant\n> the elements are all valid property keys (strings or symbols). Se Bug 3026\n\nThat seems reasonable to me. What are the possible downsides or alternatives that would still fix the problem?"},{"commentid":9481,"comment_count":3,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-07-22 11:37:53 -0700","thetext":"(In reply to Mark Miller from comment #2)\n> \n> That seems reasonable to me. What are the possible downsides or alternatives\n> that would still fix the problem?\n\nWe'd  have to validate that now of the array indexed properties (or the 'length') property of the trap result are accessor properties. (we already forbid it being a Proxy, but that restriction could be eliminated if we to List conversion) \n\nUsing a List means that identify of the result array is not preserved from the trap call through a Object.getOwnPropertyKeys call. Requires copying, while the validation approach could be done in place. Passing the same object from handler to getOwnPropertyKeys caller also means that the result array as a communications channel for additional information from handler to caller (and possibly back)."},{"commentid":9482,"comment_count":4,"who":{"uid":"erights","name":"Mark Miller"},"bug_when":"2014-07-22 12:42:22 -0700","thetext":"(In reply to Allen Wirfs-Brock from comment #3)\n> (In reply to Mark Miller from comment #2)\n> > \n> > That seems reasonable to me. What are the possible downsides or alternatives\n> > that would still fix the problem?\n> \n> We'd  have to validate that now of the array indexed properties (or the\n> 'length') property of the trap result are accessor properties. (we already\n> forbid it being a Proxy, but that restriction could be eliminated if we to\n> List conversion) \n> \n> Using a List means that identify of the result array is not preserved from\n> the trap call through a Object.getOwnPropertyKeys call. Requires copying,\n> while the validation approach could be done in place. Passing the same\n> object from handler to getOwnPropertyKeys caller also means that the result\n> array as a communications channel for additional information from handler to\n> caller (and possibly back).\n\nAll this makes me even more convinced of the List approach. This is all very parallel to the issues around the descriptor returned by getOwnPropertyDescriptor, in which we avoided the similar accidental communications channel issue."},{"commentid":9532,"comment_count":5,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-07-24 12:15:40 -0700","thetext":"fixed in rev26 editor's draft\n\nMade the result of [[OwnPropertyKeys]] a List"},{"commentid":9534,"comment_count":6,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-07-24 12:17:52 -0700","thetext":"(In reply to Allen Wirfs-Brock from comment #5)\n> fixed in rev26 editor's draft\n> \n\nuh, rev27"},{"commentid":9545,"comment_count":7,"who":{"uid":"tomvc.be","name":"Tom Van Cutsem"},"bug_when":"2014-07-24 22:23:06 -0700","thetext":"Yes, +1 for either returning a List or having [[OwnPropertyKeys]] reconstruct an Array from scratch.\n\nInterestingly, the latter is what I already did for my harmony-reflect shim. And as was mentioned, this also allows us to make sure the result contains only Strings and Symbols."},{"commentid":9960,"comment_count":8,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-08-25 08:29:30 -0700","thetext":"fixed in rev27 draft"}]}}
---
