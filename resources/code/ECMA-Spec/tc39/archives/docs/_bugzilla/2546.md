---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":2546,"creation_ts":"2014-02-12 19:58:00 -0800","short_desc":"Array.prototype.copyWithin specifies two differerent default values for 'end'","delta_ts":"2014-04-06 11:31:29 -0700","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 22: January 20, 2014 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"enhancement","everconfirmed":true,"reporter":{"uid":"ecmascript","name":"C. Scott Ananian"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":"andrebargull","long_desc":[{"commentid":7285,"comment_count":0,"who":{"uid":"ecmascript","name":"C. Scott Ananian"},"bug_when":"2014-02-12 19:58:01 -0800","thetext":"The (non-normative?) text at the top of 22.1.3.3 Array.prototype.copyWithin states \"(target, start, end = this.length)\" and \"The end argument is optional with the length of the this object as its default value.\".\n\nHowever, the actual algorithm sets end to ToLength(ToObject(this).length) not this.length.  In particular, if this.length is negative, ToLength will make it zero, so there will be two different values for `end` depending on whether you think it is given its default value before executing the algorithm or not.  (Aka, whether you pay attention to the method signature and first paragraph, or just pay attention to the algorithm as stated.)\n\nThe easiest fix is just to eliminate the `= this.length` from the signature and possibly `with the length of the this object as its default value` from the second sentence.  That's assuming the algorithm is correct.\n\nIf instead the heading and paragraph text is correct, then step 12 should read:\n\n\"If end is undefined, let relativeEnd be ToInteger(lenVal); else let relativeEnd be ToInteger(end).\"\n\nThat is, refer to lenVal, not len, and perform ToInteger instead of ToLength."},{"commentid":7291,"comment_count":1,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-02-13 08:52:26 -0800","thetext":"The algorithm is always normative.\n\nAs for any method that deals with generic array-like objects, \"the length of the Array\" should be be interpreted as meaning the result of applying ToLength to the value of the array's 'length' property. \n\nThe signature line isn't intended to be normative, but just a sort hand description of typical usage.\n\nI'm somewhat conflicted about whether I should change the heading signature line.  Clearly it caused some confusion for you and we what to avoid creating that sort of confusion. On the other hand, saying copyWithin(target, start [, end]) would be a less informative summary of the intended usage. \n\nI probably should say somewhere that heading signatures like this are non-normative, but not everybody will read that so the source of potential confusion will still be there."},{"commentid":7293,"comment_count":2,"who":{"uid":"ecmascript","name":"C. Scott Ananian"},"bug_when":"2014-02-13 13:20:27 -0800","thetext":"I wonder what the impact of actually changing the algorithm to use ToInteger for the end parameter would be?  This is totally a corner case, you'd only see it if you had an object with a negative length property.  But it would eliminate the possible confusion, and allow us to use the more descriptive signature without caveats."},{"commentid":7294,"comment_count":3,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2014-02-13 13:59:52 -0800","thetext":"It's still necessary to say that default parameter expressions are not normative and are not supposed to be evaluated. This is required because the default expression may contain code which executes side effects, in this case, for example, `this.length` may execute arbitrary code if there is a getter for the \"length\" property on the thisValue object."},{"commentid":7353,"comment_count":4,"who":{"uid":"ecmascript","name":"C. Scott Ananian"},"bug_when":"2014-02-17 14:31:16 -0800","thetext":"Discussion in http://esdiscuss.org/topic/changing-behavior-of-array-copywithin-when-used-on-array-like-with-negative-length\n\nAndré Bargull proposes a concrete diff at https://gist.github.com/anba/6c75c34c72d4ffaa8de7\nwhich avoids double-invocation of `valueOf`/etc side-effects in case `this.length` is object-valued.\n\nA quick audit of the spec shows that `Array#fill` might have the same issue. `Array#lastIndexOf` also uses `ToLength` instead of `ToInteger` but it uses ES5-style default parameters.  The spec text can probably be made consistent without affecting actual behavior.\n\nThe `copyWithin`, `fill`, `lastIndexOf`, and `subarray` methods of `%TypedArray%.prototype` are spec'ed with default arguments equal to `this.length`, but there's no way `length` can be negative for a typed array."},{"commentid":7369,"comment_count":5,"who":{"uid":"ecmascript","name":"C. Scott Ananian"},"bug_when":"2014-02-18 12:54:03 -0800","thetext":"Claude Pache points out that `Array#slice` also contains a similar default for `end`."},{"commentid":7452,"comment_count":6,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-03-19 12:48:42 -0700","thetext":"Fixed in rev23 editor's draft.\n\nRemoved all \"default value\"notation usage in function signatures so there is no confusion with the  normative algorithm texts.\n\nadded Bug 2582 for a abstract operation for converting relative index positions to absolute"},{"commentid":7605,"comment_count":7,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-04-06 11:31:29 -0700","thetext":"fixed in rev23 draft"}]}}
---
