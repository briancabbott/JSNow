---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":3256,"creation_ts":"2014-10-02 17:20:00 -0700","short_desc":"New Array.prototype behavior of returning an instance of `this.constructor` breaks Zepto.","delta_ts":"2014-12-07 14:35:03 -0800","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 27: August 24, 2014 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":{"uid":"brterlso","name":"Brian Terlson"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"long_desc":[{"commentid":10261,"comment_count":0,"who":{"uid":"brterlso","name":"Brian Terlson"},"bug_when":"2014-10-02 17:20:56 -0700","thetext":"We have discovered a breaking change in ES6 that has significant impact on the web (especially the mobile web). Zepto is affected and possibly other libraries that depend on similar patterns.\n\nThe problem arises because Array.prototype methods now attempt to construct an instance of this.constructor rather than Array. This is obviously beneficial for some cases, but has extremely bad behavior for libraries like Zepto that detach methods from Array.prototype and apply them to objects whose only constructor property is found on Object.prototype.\n\nThe min repro case is something like this:\n\nvar obj = [1,2,3];\nobj.__proto__ = { slice: Array.prototype.slice };\nvar res = obj.slice(2);\nArray.isArray(res); // true in ES5, false in ES6.\n\nKey pieces of code:\n\nZepto prototype object: https://github.com/madrobby/zepto/blob/master/src/zepto.js#L389-L796\n(note lack of constructor property)\n\nZepto \"wrapper\": https://github.com/madrobby/zepto/blob/master/src/zepto.js#L157-L162\n\nExample isArray check that often fails in practice with ES6 semantics: https://github.com/madrobby/zepto/blob/master/src/zepto.js#L198\n\nThe scope of this breakage seems very large. If at all possible we should update the semantics to preserve backwards compat for Zepto."},{"commentid":10262,"comment_count":1,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-10-02 18:01:16 -0700","thetext":"If we only have to worry about implicit inheritance of \"constructor\" from Object.prototype we can probably fix it by inserting an additional step between 14.c.ii (which is itself an hack to fix an earlier compat issue) and 14.c.ii.1. The new line is an additional guard on using C as the constructor:\n     If SameValue(C, %Object%) is false, then\n            (existing line 14.c.ii.1)\n \nThis takes care of the sloppy code like what you presented that \"accidentally\" returns %Object% as the value of obj.constructor.  It would still break anybody who setups a well formed \"class\" using array methods and then did the same sort of dunder proto hacking to turn exotic array instances into instances of that class.\n\nI think I have a fix for that case too, but it would require exposing an additional @@method.  I not yet sure we really need it.\n\nHere is a sketch of the fix:\nDefine a new \"static\" accessor property on Array whose getter is essentintially:\n   function () {return this}.\n\nAll occurenencnce in Array.prototype methods of sequences that look like:\n4.\tIf O is an exotic Array object, then\n  a.\t  Let C be Get(O, \"constructor\").\n  b.  \t  ReturnIfAbrupt(C).\n  c.\t  If IsConstructor(C) is true, then\n    i.\t    Let thisRealm be the running execution context’s Realm.\n    ii.\t    If SameValue(thisRealm, GetFunctionRealm(C)) is true, then\n      1.\tLet A be the result of calling the [[Construct]] internal method of C with argument (0).\n5.\tIf A is undefined, then\na.\t  Let A be ArrayCreate(0).\n\nwould be replaced by:\n4.\tLet C be Get(O, \"constructor\").\n5.  \tReturnIfAbrupt(C).\n6.\tIf IsConstructor(C) is true, then\n  a.      Let species be Get(O, @@species);\n  b.      If IsConstructor(species) is true, then\n    i.      Let C be species.\n  c.      Else, let C be undefined.\n7.\tIf IsConstructor(C) is true, then\n  a.\t  Let thisRealm be the running execution context’s Realm.\n  b.\t  If SameValue(thisRealm, GetFunctionRealm(C)) is true, then\n    i.\t    Let A be the result of calling the [[Construct]] internal method of C with argument (0).\n8.\tIf A is undefined, then\n  a.\t  Let A be ArrayCreate(0).\n\nThis approach actually is more backwards compatible and also provides greater flexibility for ES6 level programmers who what to wire together new kinds of pseudo-array classes and reuse Array prototype methods."},{"commentid":10263,"comment_count":2,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-10-04 08:23:43 -0700","thetext":"(In reply to Allen Wirfs-Brock from comment #1)\n\nBug fixed in line 6a below\n\n> \n> \n> would be replaced by:\n> 4.\tLet C be Get(O, \"constructor\").\n> 5.  \tReturnIfAbrupt(C).\n> 6.\tIf IsConstructor(C) is true, then\n>   a.      Let species be Get(C, @@species);\n>   b.      If IsConstructor(species) is true, then\n>     i.      Let C be species.\n>   c.      Else, let C be undefined.\n> 7.\tIf IsConstructor(C) is true, then\n>   a.\t  Let thisRealm be the running execution context’s Realm.\n>   b.\t  If SameValue(thisRealm, GetFunctionRealm(C)) is true, then\n>     i.\t    Let A be the result of calling the [[Construct]] internal method\n> of C with argument (0).\n> 8.\tIf A is undefined, then\n>   a.\t  Let A be ArrayCreate(0).\n>"},{"commentid":10270,"comment_count":3,"who":{"uid":"brterlso","name":"Brian Terlson"},"bug_when":"2014-10-07 16:08:45 -0700","thetext":"Here's a slightly refactored version that should be semantically identical (except for the added ReturnIfAbrupt check after getting @@species from C).\n\n4. Let C be Get(O, \"constructor\").\n5. ReturnIfAbrupt(C).\n6. If IsConstructor(C) is true, then\n   a. Let species be Get(C, @@species);\n   b. ReturnIfAbrupt(species)\n   c. If IsConstructor(species) is true, then\n      i.  let thisRealm be the running execution context’s Realm.\n      ii. If SameValue(thisRealm, GetFunctionRealm(C)) is true, then\n          1. Let A be the result of calling the [[Construct]] internal method of species with argument (0).\n7. If A is undefined, then\n  a. Let A be ArrayCreate(0).\n\nAllen currently investigating whether the realm check needs to be moved to 6.a before checking species."},{"commentid":10680,"comment_count":4,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-11-24 14:03:49 -0800","thetext":"fixed in rev29 editor's draft"},{"commentid":10870,"comment_count":5,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-12-07 14:35:03 -0800","thetext":"fixed in rev29"}]}}
---
