---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":2603,"creation_ts":"2014-04-01 07:38:00 -0700","short_desc":"AddLoadToLinkSet should add \"loading\" dependencies, not just \"loaded\" dependencies","delta_ts":"2015-03-16 14:40:37 -0700","product":"Draft for 6th Edition","component":"deferred features","version":"Rev 22: January 20, 2014 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"WONTFIX","priority":"Normal","bug_severity":"enhancement","everconfirmed":true,"reporter":{"uid":"jorendorff","name":"Jason Orendorff"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":["dherman","guybedford","jorendorff","samth"],"long_desc":[{"commentid":7496,"comment_count":0,"who":{"uid":"jorendorff","name":"Jason Orendorff"},"bug_when":"2014-04-01 07:38:16 -0700","thetext":"Guy Bedford discovered this.\n\nThe invariant is that while a LinkSet is in flight, its [[Loads]] list contains all in-flight Load Records that the LinkSet depends on.\n\nThis naturally includes both Loads that are still loading and Loads that have loaded and are waiting to be linked.\n\nProposed fix: in \"15.2.5.2.2 AddLoadToLinkSet(linkSet, load) Abstract Operation\", change step 3.c. from\n\n>     c. If load.[[Status]] is \"loaded\", then \n\nto\n\n>     c. If load.[[Status]] is either \"loading\" or \"loaded\", then"},{"commentid":7497,"comment_count":1,"who":{"uid":"jorendorff","name":"Jason Orendorff"},"bug_when":"2014-04-01 08:00:38 -0700","thetext":"Guy, can we add further assertions to make the intent/invariants clearer?\n\nHere are some of the design invariants I have in my head.\n\nFor any given Loader,\nlet L = the set of Load Records in loader.[[Loads]], and\nlet LS = the set {linkset | linkset in load.[[LinkSets]], load in L}.\n\n  - Each Load in L is either \"loading\" or \"loaded\".\n\n  - For each linkset in LS, \n    linkset.[[Loads]] is a subset of loader.[[Loads]].\n\n    Together, these two imply that every Load in L and every LinkSet\n    in LS is still viable; if one fails, it and all its dependencies\n    must be removed from the loader's lists.\n\n  - For each load in L, for each linkset in LS,\n    load.[[LinkSets]] contains linkset iff linkset.[[Loads]] contains load.\n\n  - For each load in L, load.[[LinkSets]] is nonempty.\n\n  - For each linkset in LS,\n    if a Load Record j is a direct or indirect dependency\n    of any Load Record k in linkset.[[Loads]], then\n    j is also in linkset.[[Loads]].\n\nThese invariants should hold after every microtask. Guy, can you write a function to test them, call it from lots of places, and see if it shakes out more bugs?"},{"commentid":7973,"comment_count":2,"who":{"uid":"guybedford","name":"Guy Bedford"},"bug_when":"2014-04-29 16:33:41 -0700","thetext":"I've added this invariant checking to the current polyfill implementation and everything worked out fine. See https://github.com/ModuleLoader/es6-module-loader/commit/f98950c3721f9c998f96ac5c0920c83a20854e5d for the code and test examples.\n\nNote that the last invariant is not true. The linkSet retains the unlinked dependency graph only, clearing after each load. So I had to remove this check.\n\nThis fact is what can be (should be) exploited in the group linking algorithms since we know that the linkSet is basically our unlinked dependency graph, so we just have to consider those load records."},{"commentid":13770,"comment_count":3,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-16 14:40:37 -0700","thetext":"concerns old module spec."}]}}
---
