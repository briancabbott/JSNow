---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":4126,"creation_ts":"2015-03-06 08:20:00 -0800","short_desc":"Completion reform missing pieces","delta_ts":"2015-03-17 16:57:04 -0700","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 35: March 4, 2015 Release Candidate 2","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"major","everconfirmed":true,"reporter":{"uid":"andrebargull","name":"André Bargull"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":"jmdyck","long_desc":[{"commentid":13599,"comment_count":0,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-03-06 08:20:02 -0800","thetext":"Completion reform changes are still incomplete. I've tried to fill in the missing pieces, but I'm not sure whether or not I've covered everything (e.g. completion values for loops with break/continue).\n\n\nCompletion semantics in rev35:\nhttps://gist.github.com/anba/2288c4501bf3799c44a1\n\nCompletion semantics with completion reform applied:\nhttps://gist.github.com/anba/24438972880d30327480\n\nDiff:\nhttps://gist.github.com/anba/d1671fc7deff21a4ead9"},{"commentid":13600,"comment_count":1,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-03-06 08:22:22 -0800","thetext":"I've also removed a few LoopContinues calls, because there are currently not needed and complicate things."},{"commentid":13601,"comment_count":2,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-06 08:38:12 -0800","thetext":"I which of the algorithms are the changes  specifically covering cases that were missing?"},{"commentid":13604,"comment_count":3,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-06 08:58:27 -0800","thetext":"I'm trying to avoid unnecessary churn and want to focus on things that are missing or buggy."},{"commentid":13605,"comment_count":4,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-03-06 09:01:44 -0800","thetext":"- Finally block completion values should be ignored (except for throw and return).\n- CaseBlockEvaluation is a complete mess, e.g.\n  Completion value for this switch statement is empty:\n    `switch(1){ case 1: ; }`\n  Completion value for this switch statement is `undefined`:\n    `switch(1){ case 0: ; default: ; case 1: ; }`\n- break with and without labels, e.g.\n  Completion value is empty:\n    `var i=0; L: do { if(++i==2)break L; i; } while (1);`\n  Completion value is `undefined`:\n    `var i=0; do { if(++i==2)break; i; } while (1);`\n\nGeneral question:\n```\nvar i = 0;\nwhile (true) {\n  if (++i == 2) break;\n  42;\n}\n```\n\nWhat is the expected completion value for the while loop according to the completion reform - `42` or `undefined`? With the rev35 semantics it's `undefined`."},{"commentid":13606,"comment_count":5,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-03-06 09:06:21 -0800","thetext":"Unfortunately completion value semantics aren't really popular, so there is little to no interest to review this part of the spec. And \nhttp://wiki.ecmascript.org/doku.php?id=harmony:completion_reform doesn't provide enough information to say how things should work. :-("},{"commentid":13609,"comment_count":6,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-03-06 09:48:27 -0800","thetext":"This is a less invasive patch to handle finally-blocks and labeled statements, remove dead steps with LoopContinues and CaseSelectorEvaluation, and fix an empty completion value issue in CaseBlockEvaluation:\n\nhttps://gist.github.com/anba/03e1aa285ca8808d149d\n\n\nThose changes don't handle loops and empty completions values from break/continue."},{"commentid":13623,"comment_count":7,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-07 10:46:20 -0800","thetext":"(In reply to André Bargull from comment #4)\n\n> \n> General question:\n> ```\n> var i = 0;\n> while (true) {\n>   if (++i == 2) break;\n>   42;\n> }\n> ```\n> \n> What is the expected completion value for the while loop according to the\n> completion reform - `42` or `undefined`? With the rev35 semantics it's\n> `undefined`.\n\nMy call is undefined:  Because we have started evaluation of the statement block, the completion value of the previous evaluation is irrelevant.  However, at the point of the break, the completion value of the statement list is empty.  Because the while statement under completion reform never produces an empty completion value, the empty is transformed into undefined."},{"commentid":13637,"comment_count":8,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-07 17:43:11 -0800","thetext":"(In reply to André Bargull from comment #4)\n> - Finally block completion values should be ignored (except for throw and\n> return).\n\nwhy do you think this should be the case.  consider\n\nwhile (true) \n   try {1} finally{2; break};\n// we reach here because the finally took over exit control\n// completion value: 1 or 2?\n\nWhy should the completion value be 1? By executing a break (or throw/return/continue) the finally block has taken control completely away from the try block. why should that transfer of the locus of control also imply a transfer of the responsibility of providing the return value?"},{"commentid":13640,"comment_count":9,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-03-08 04:09:53 -0700","thetext":"(In reply to Allen Wirfs-Brock from comment #8)\n> (In reply to André Bargull from comment #4)\n> > - Finally block completion values should be ignored (except for throw and\n> > return).\n> \n> why do you think this should be the case.  consider\n> \n\n\"Additional changes\" from http://wiki.ecmascript.org/doku.php?id=harmony:completion_reform describes this semantics."},{"commentid":13641,"comment_count":10,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-03-08 04:14:32 -0700","thetext":"(In reply to Allen Wirfs-Brock from comment #7)\n> (In reply to André Bargull from comment #4)\n> \n> > \n> > General question:\n> > ```\n> > var i = 0;\n> > while (true) {\n> >   if (++i == 2) break;\n> >   42;\n> > }\n> > ```\n> > \n> > What is the expected completion value for the while loop according to the\n> > completion reform - `42` or `undefined`? With the rev35 semantics it's\n> > `undefined`.\n> \n> My call is undefined:  Because we have started evaluation of the statement\n> block, the completion value of the previous evaluation is irrelevant. \n> However, at the point of the break, the completion value of the statement\n> list is empty.  Because the while statement under completion reform never\n> produces an empty completion value, the empty is transformed into undefined.\n\n```\nvar i = 0;\nwhile (i < 2) {\n  if (++i == 2) continue;\n  42;\n}\n```\n\nAnd here? Currently it's `42`."},{"commentid":13642,"comment_count":11,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-08 09:47:41 -0700","thetext":"(In reply to André Bargull from comment #9)\n> (In reply to Allen Wirfs-Brock from comment #8)\n> > (In reply to André Bargull from comment #4)\n> > > - Finally block completion values should be ignored (except for throw and\n> > > return).\n> > \n> > why do you think this should be the case.  consider\n> > \n> \n> \"Additional changes\" from\n> http://wiki.ecmascript.org/doku.php?id=harmony:completion_reform describes\n> this semantics.\n\nYes, but that and the es-scuss message it references only talks about normal completion of the finally block. I don't see anything from (the very limited  discussion) or from legacy ES that suggests that the completion value of a break/continue in a finally block should be ignored.\n\nFrom the perspective of the try statement such a break/continue is an abnormal exit just like return or throw."},{"commentid":13702,"comment_count":12,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-03-11 18:16:33 -0700","thetext":"(In reply to Allen Wirfs-Brock from comment #11)\n> Yes, but that and the es-scuss message it references only talks about normal\n> completion of the finally block. I don't see anything from (the very limited\n> discussion) or from legacy ES that suggests that the completion value of a\n> break/continue in a finally block should be ignored.\n\n(Unfortunately) the es-discuss message doesn't event get into the details of normal and abrupt completions, so it's more or less open for interpretation what he meant when he said \"without changing the completion value of the expression\". The same goes for the initial revision of http://wiki.ecmascript.org/doku.php?id=harmony:completion_reform&rev=1321054410. \n\nI interpreted the sentence:\n> should make the completion of a try-finally be the result of the try block\n\nthat completion values from break/continue abrupt completions should be dropped. \n\nIf completion values from break/continue abrupt completions are not dropped, implementations will need to store the try-block's completion value somehow in case the finally block returns with a normal completion. Correct?\n\nExample:\n---\nL: try {\n  1;\n} finally {\n  2;\n  if (cond) break L;\n}\n---\n\nIf [cond = false], the completion value is `1`.\nIf [cond = true], the completion value is `2`."},{"commentid":13704,"comment_count":13,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-11 18:30:40 -0700","thetext":"(In reply to André Bargull from comment #12)\n...\n> \n> If completion values from break/continue abrupt completions are not dropped,\n> implementations will need to store the try-block's completion value somehow\n> in case the finally block returns with a normal completion. Correct?\n> \n> Example:\n> ---\n> L: try {\n>   1;\n> } finally {\n>   2;\n>   if (cond) break L;\n> }\n> ---\n> \n> If [cond = false], the completion value is `1`.\n> If [cond = true], the completion value is `2`.\n\nAlready have to do that for return and throw:\n\ntry {\n   return 1}\n} finally {\n   if (cond) return 2\n}"},{"commentid":13706,"comment_count":14,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2015-03-12 06:52:33 -0700","thetext":"(In reply to Allen Wirfs-Brock from comment #13)\n> Already have to do that for return and throw:\n\nYes, in function contexts. I don't know how engines (other than my own) implement script completion values. Therefore I wanted to make it clear that completion values need to be stored temporarily, so other implementors are aware of this change. It may not be a change within the spec, but definitely for implementations:\n\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=819125\nhttps://code.google.com/p/v8/issues/detail?id=2446"},{"commentid":13714,"comment_count":15,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-12 11:51:17 -0700","thetext":"(In reply to André Bargull from comment #14)\n> (In reply to Allen Wirfs-Brock from comment #13)\n> > Already have to do that for return and throw:\n> \n> Yes, in function contexts. I don't know how engines (other than my own)\n> implement script completion values. Therefore I wanted to make it clear that\n> completion values need to be stored temporarily, so other implementors are\n> aware of this change. It may not be a change within the spec, but definitely\n> for implementations:\n> \n> https://bugzilla.mozilla.org/show_bug.cgi?id=819125\n> https://code.google.com/p/v8/issues/detail?id=2446\n\nyes, they're all buggy according to ES specs going back to ES3 when try-catch was added.\n\nIt probably doesn't make much difference today, but if we add do expressions in ES7 it will become more easily observable so now might be a good time for implementations to start thinking about fixing it."},{"commentid":13729,"comment_count":16,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-15 11:11:22 -0700","thetext":"fixed in rev36 editor's draft"},{"commentid":13806,"comment_count":17,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-17 16:57:04 -0700","thetext":"in rev36"}]}}
---
