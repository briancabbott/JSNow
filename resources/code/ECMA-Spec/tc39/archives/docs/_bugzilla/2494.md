---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":2494,"creation_ts":"2014-02-03 06:48:00 -0800","short_desc":"Add hooks for CSP","delta_ts":"2015-03-15 13:04:30 -0700","product":"Draft for 6th Edition","component":"new feature","version":"Rev 21: November 8, 2013 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"WORKSFORME","priority":"Normal","bug_severity":"enhancement","everconfirmed":true,"reporter":{"uid":"annevk","name":"Anne van Kesteren"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":["bruant.d","d","dherman","getify","mathias","mkwst","till"],"long_desc":[{"commentid":7173,"comment_count":0,"who":{"uid":"annevk","name":"Anne van Kesteren"},"bug_when":"2014-02-03 06:48:41 -0800","thetext":"http://w3c.github.io/webappsec/specs/content-security-policy/csp-specification.dev.html#script-src modifies the way eval() and new Function() work. That should not be done in that way but rather there should be some way for the host environment to influence execution of those features.\n\nI guess if we really rely on that being a DOMException whose name is \"SecurityError\" it would be best if the host environment could define the exception object to be thrown.\n\n(This setup seems rather wonky, I wonder if this was ever passed by TC39 for review before it get widely deployed...)"},{"commentid":7177,"comment_count":1,"who":{"uid":"mkwst","name":"Mike West"},"bug_when":"2014-02-03 17:10:53 -0800","thetext":"What about the setup is wonky? What can we do to unwonk it?"},{"commentid":7189,"comment_count":2,"who":{"uid":"annevk","name":"Anne van Kesteren"},"bug_when":"2014-02-05 05:14:06 -0800","thetext":"Having ES features throw non-ES exception objects. I'm waiting for Allen to weigh in as what would be the best way forward here given the status quo."},{"commentid":7190,"comment_count":3,"who":{"uid":"mkwst","name":"Mike West"},"bug_when":"2014-02-05 05:27:31 -0800","thetext":"Status quo (CSP 1.0) says \"must throw a security exception\", which I suppose isn't much better.\n\nWould changing the spec to EvalError (which I believe is defined, but unused in ES6) be better? If not, what would you prefer?"},{"commentid":7193,"comment_count":4,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-02-05 08:45:51 -0800","thetext":"(In reply to comment #3)\n> Status quo (CSP 1.0) says \"must throw a security exception\", which I suppose\n> isn't much better.\n> \n> Would changing the spec to EvalError (which I believe is defined, but unused in\n> ES6) be better? If not, what would you prefer?\n\nWhich exception is thrown is probably the least of my concerns but EvalError seems like a good choice.  It is no longer used by the ES spec. but this usage is similar to what it was originally intended for.\n\nRegarding the ES specification, the hooks necessary to implement CSP seem trivial.\n\nNow for bigger issues:\n\n1) Is there really any point is trying to restrict the use of eval and the function constructor? Assume the a bad guy understands compilers. If his script has access to some JS source code that it might want to eval (or Function construct) he could provide his own eval/Function.  All it takes is the inclusion in his script of a JS parser/interpreter, implemented in JS (consider http://sns.cs.princeton.edu/2012/04/javascript-in-javascript-js-js-sandboxing-third-party-scripts/ but with the sandboxing removed).  I believe that using this technique it is possible to recreate a fully functional eval/Function so what has the restriction accomplished?\n\n2) In ES6 there are going to be a number of new ways to evaluate source code. You will need to take those into account in your spec.  \n\n3)ES6 is providing new mechanisms (Loaders and Realms) with hooks for controlling capabilities such as eval and directly supporting sandboxing including iframes. It would seem that evolution of CSP needs to take these emerging capabilities into account and also should provide feedback into the ES6 design. (for a start see http://wiki.ecmascript.org/doku.php?id=harmony:module_loaders and https://github.com/ModuleLoader/es6-module-loader )"},{"commentid":7196,"comment_count":5,"who":{"uid":"mkwst","name":"Mike West"},"bug_when":"2014-02-06 04:03:10 -0800","thetext":"(In reply to comment #4)\n> Which exception is thrown is probably the least of my concerns but EvalError\n> seems like a good choice.  It is no longer used by the ES spec. but this usage\n> is similar to what it was originally intended for.\n\nGreat. https://github.com/w3c/webappsec/commit/d310910445161163ccc4d5b612c04962ec8412ab\n\n> Regarding the ES specification, the hooks necessary to implement CSP seem\n> trivial.\n\nAlso great! I'm happy to poke at the CSP spec in whatever way would make that simplest for you folks.\n\n> 1) Is there really any point is trying to restrict the use of eval and the\n> function constructor? ... I believe that using this technique it is\n> possible to recreate a fully functional eval/Function so what has the\n> restriction accomplished?\n\nYou're entirely correct.\n\nThat said, one goal of CSP is to _mitigate_ the risk of cross-site scripting and other content injection attacks. It's certainly going to be much more difficult for an attacker to inject a JavaScript compiler than it would be for her to exploit an author's unconsidered use of `eval()` (or similar) with data that the attacker might be able to control. Giving authors the ability to turn off the potentially problematic bits of JavaScript that do the magic of converting text to execution is valuable, though I'd agree that it's nowhere near a 100% promise that no attacker-provided text can be evaluated.\n\n> 2) In ES6 there are going to be a number of new ways to evaluate source code.\n> You will need to take those into account in your spec.\n\nCan you point me at some of them? Or, better, can we work out a way that CSP can hook into those methods in a generic way so that the CSP spec can avoid leaving obvious holes with new revisions of the ES spec?\n \n> 3)ES6 is providing new mechanisms (Loaders and Realms) with hooks for\n> controlling capabilities such as eval and directly supporting sandboxing\n> including iframes. It would seem that evolution of CSP needs to take these\n> emerging capabilities into account and also should provide feedback into the\n> ES6 design. (for a start see\n> http://wiki.ecmascript.org/doku.php?id=harmony:module_loaders and\n> https://github.com/ModuleLoader/es6-module-loader )\n\nI spoke with Alex Russell briefly (though I can't seem to CC him here...) about some of these types of concerns a week or two ago, and I agree that it would be a good idea to review these features to see how they interact with CSP. I haven't found time to read the linked documents yet, but they're on my list. :)"},{"commentid":13738,"comment_count":6,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-15 13:04:30 -0700","thetext":"Resolving this for ES6, as I believe there is sufficient language in the ES6 spec. to handle the current CSP use cases WRT the eval features that a present in ES6.  If you disagree you can open an ES7 bug.\n\nThe contemplate new eval-like features didn't make it into ES6.  But you should continue to track ES7 work and in particular, the ongoing work to define the browser module loader and loader API"}]}}
---
