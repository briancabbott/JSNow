---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":1786,"creation_ts":"2013-08-16 03:27:00 -0700","short_desc":"10.2.1.2.2, 10.2.1.4.16, 10.2.1.4.17: Invalid assertions","delta_ts":"2013-08-23 08:21:57 -0700","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 16: July 15, 2013 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":{"uid":"andrebargull","name":"André Bargull"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"long_desc":[{"commentid":4925,"comment_count":0,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2013-08-16 03:27:22 -0700","thetext":"10.2.1.2.2, step 3:\n> 3.  Assert: The result of HasProperty(bindings, N) is false .\n\n10.2.1.4.16, step 3:\n> 3.  Assert: The result of calling envRec’s CanDeclareGlobalVar concrete method with argument N is true.\n\n10.2.1.4.17, step 3, step 8:\n> 3.  Assert: The result of calling envRec’s CanDeclareGlobalFunction concrete method with argument N is true.\n> 8.  NOTE  The assertion in step 3 means that the above [[DefineOwnProperty]] calls will never return false or an abrupt completion.\n\n\nThese assertions are no longer true because of Proxies and modifiable [[Prototype]]. \n\n(BTW: Should assertions ever call user code? I don't think so...)\n\n\ntest cases:\n---\nfunction triggerAssertion(global, callCounter, code) {\n  Object.setPrototypeOf(global, new Proxy(Object.create(null), {\n    has(t, pk) {\n      if (pk == \"foo\" && callCounter > 0 && --callCounter == 0) {\n        Object.preventExtensions(global);\n        return true;\n      }\n      return false;\n    }\n  }));\n  (1,eval)(`eval(\"${code}\")`)\n}\n\n// 10.2.1.2.2, step 3\ntriggerAssertion(this, 4, \"var foo = 0\")\n\n// 10.2.1.4.16, step 3\ntriggerAssertion(this, 1, \"var foo = 0\")\n\n// 10.2.1.4.17\ntriggerAssertion(this, 1, \"function foo(){}\")\n---"},{"commentid":4929,"comment_count":1,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2013-08-16 10:10:50 -0700","thetext":"fixed in rev17 editor's draft"},{"commentid":5018,"comment_count":2,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2013-08-23 08:21:57 -0700","thetext":"fixed in rev17, August 23, 2013 draft"}]}}
---
