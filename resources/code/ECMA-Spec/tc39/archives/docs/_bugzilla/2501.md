---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":2501,"creation_ts":"2014-02-04 13:52:00 -0800","short_desc":"Map.prototype.set, [[MapComparator]], SameValueZero, and forEach","delta_ts":"2014-04-06 11:31:17 -0700","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 22: January 20, 2014 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"enhancement","everconfirmed":true,"reporter":{"uid":"ecmascript","name":"C. Scott Ananian"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"long_desc":[{"commentid":7184,"comment_count":0,"who":{"uid":"ecmascript","name":"C. Scott Ananian"},"bug_when":"2014-02-04 13:52:00 -0800"},{"commentid":7185,"comment_count":1,"who":{"uid":"ecmascript","name":"C. Scott Ananian"},"bug_when":"2014-02-04 14:04:04 -0800","thetext":"See https://github.com/paulmillr/es6-shim/pull/200\n\n1) The spec for Map.prototype.set (23.1.3.9) still mentions [[MapComparator]].  This should be removed, IIUC.\n\n2) What is this code expected to do?\n\nvar m = new Map();\nm.set(-0, 'a');\nm.forEach(function(v,k) { console.log(1/k); });\nm.set(1, 'b')\nm.set(0, 'c');\nm.forEach(function(v,k) { console.log(1/k); });\n\nCurrent Firefox prints \"Infinity\", \"Infinity, \"1\".  That is, the \"-0\" key is converted to +0 before being added to the Map.  This seems to be wrong according to the spec (but I'd like to confirm that).\n\nI expect this code to print \"-Infinity\", \"-Infinity\", \"1\".  That is, the key stored in the set is -0, and since SameValueZero(0, -0) is true, the key is not updated by the final set operation, nor is the insertion order changed.\n\nA similar issue applies to Set -- according to the spec I expect this to print \"-Infinity\":\n\nvar s = new Set();\ns.add(-0);\ns.add(0);\ns.forEach(function(v) { console.log(1/v); });\n\nIf the current spec is correct, then Map and Set are inconsistent with how objects store fields.  This is the equivalent code using an object as a map:\n\nvar o = Object.create(null);\no[-0] = 'a'\nObject.keys(o).forEach(function(k) { console.log(1/k); });\no[1] = 'b'\no[0] = 'c'\nObject.keys(o).forEach(function(k) { console.log(1/k); });\n\nThis code emits \"Infinity\", \"Infinity\", \"1\" like Firefox's current Map implementation (but *not* like the current Map specification)."},{"commentid":7187,"comment_count":2,"who":{"uid":"ecmascript","name":"C. Scott Ananian"},"bug_when":"2014-02-04 14:44:18 -0800","thetext":"Item #1 in comment #1 seems to be addressed by bug 2496.  So let's focus this bug on whether Map/Set should coerce -0 to +0 when used as a key, in the same way -0 is coerced (via ToString conversion to \"0\") when it is used as an object property key."},{"commentid":7188,"comment_count":3,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-02-04 15:49:40 -0800","thetext":"fixed in rev23 editor's draft\n\nyes, for Map and Set to work consistently, -0 has to be normalized to +0 in Map.prototype.set and Set.prototype.add"},{"commentid":7595,"comment_count":4,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-04-06 11:31:17 -0700","thetext":"fixed in rev23 draft"}]}}
---
