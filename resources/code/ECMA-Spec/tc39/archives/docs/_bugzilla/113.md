---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":113,"creation_ts":"2011-06-25 09:05:00 -0700","short_desc":"Faster browser runner","delta_ts":"2014-08-18 04:53:54 -0700","product":"Test262","component":"Test262 website","version":"unspecified","rep_platform":"PC","op_sys":"Linux","bug_status":"CONFIRMED","bug_severity":"enhancement","everconfirmed":true,"reporter":{"uid":"bruant.d","name":"David Bruant"},"assigned_to":{"uid":"dfugate","name":"Dave Fugate"},"cc":["brterlso","sam.mikes"],"long_desc":[{"commentid":241,"comment_count":0,"attachid":"2","who":{"uid":"bruant.d","name":"David Bruant"},"bug_when":"2011-06-25 09:05:38 -0700","thetext":"Created attachment 2\nfaster sth.js file\n\nI've spent some time reading and trying to improve sth.js.\nThe main improvement I have made is changing how tests are inserted in the iframe. Currently, an iframe is created, its document is opened and HTML <script> elements are inserted on-the-fly (I will refer to it as the \"Doc Stream\" method). I have taken the following approach: create a document fragment, create script elements (with document.createElement). When all scripts are here, append the document fragment to the iframe document (later references as \"Doc Fragment\").\n\nHere are my results (local copy of the website run on Firefox 5):\nDoc Stream:\nTotal Tests Ran: 10865 | Pass: 10587 | Fail: 278 | Failed To Load: 0\nTime: 1130551ms (~18m50s)\n\nDoc fragment: \nTotal Tests Ran: 10865 | Pass: 10585 | Fail: 280 | Failed To Load: 2\nTime: 669876ms (~11m06s) (~41% improvement, YAY!)\n(measurements have been done only once in an always active tab)\n\nI haven't checked every single test id, but it seems that the failures (and consequently passes) in both approach are the same on FF5.\nThe only difference is the \"Failed To Load: 2\". The 2 tests are S15.7.3.2_A1 and S15.9.3.2_A1_T1. After some research, I have noticed that these two tests are the only one triggering the synchronous AJAX load to retrive includes (sth.js ~l100-120). Tests using the same includes, but getting them from the cache (\"scriptCache\" variable) are not affected. My personal guess is that it's a Firefox-specific bug, because it cannot really be a coincidence.\n\n\nOther minor changes:\n- Now, sth.js requires \"textContent\" which takes IE8 out of the game. If we really care about making the test suite run on IE8, maybe that \"innerText\" can be used as fallback.\n- the \"iframe\" variable has been moved to this.run making \"testFinished\" independent of how tests are run. The iframe is now removed from the tree in the this.run function\n- The \"testFinished\" function was previously called from the iframe via an additional script. I took rid of it and call the function from the main window (because it doesn't make any difference).\n- Previously: var win = window.frames[window.frames.length - 1];\nNow: var win = iframe.contentWindow;\nExact same object, but now retrieved in a way that is independent of where the iframe is on the DOM tree (because it doesn't matter).\n\nPlease, can you test on other browsers and tell me if it works and if there is a performance win."},{"commentid":242,"comment_count":1,"who":{"uid":"bruant.d","name":"David Bruant"},"bug_when":"2011-06-25 11:37:12 -0700","thetext":"After test, Opera 11.11 and Chrome 12 aren't affected by an inability to load the 2 tests, confirming the idea that it would be Firefox-specific."},{"commentid":243,"comment_count":2,"who":{"uid":"bruant.d","name":"David Bruant"},"bug_when":"2011-06-25 14:21:33 -0700","thetext":"To follow progress on Firefox bug fixing: https://bugzilla.mozilla.org/show_bug.cgi?id=667227"},{"commentid":252,"comment_count":3,"attachid":"3","who":{"uid":"bruant.d","name":"David Bruant"},"bug_when":"2011-07-03 13:26:16 -0700","thetext":"Created attachment 3\nfaster sth.js file"},{"commentid":253,"comment_count":4,"who":{"uid":"bruant.d","name":"David Bruant"},"bug_when":"2011-07-03 13:34:04 -0700","thetext":"About https://bugzilla.mozilla.org/show_bug.cgi?id=667227 , it turns out it's an issue with about:blank iframes and synchronous xhr. It's being worked on at https://bugzilla.mozilla.org/show_bug.cgi?id=543435\nMeanwhile, the new attachment has a workaround (doing the include loadng before creating the iframe which doesn't change anything functionnally speaking).\n\nI have done more performance measures:\n-----\nOn FFAurora (6)\nDocstream: 254504\nDocfrag: 215367\n\nOn Chrome 12:\nDocstream: (1) 445254 - (2) 389022\nDocfrag: (1) 390611 - (2) 393119\n\nOpera 11.11\nDocstream: 1185647\nDocfrag: 720235\n-----\nChrome is not very convincing. The second run even showed the docstream method being slightly faster.\n\nI have no way to prove it, but I'm under the impression that the garbage collector has an important influence on the actual performance.\n\nThis is not very formal measurements, but seems to give a tendency anyway of the docfrag method being faster."},{"commentid":9802,"comment_count":5,"who":{"uid":"sam.mikes","name":"Sam Mikes"},"bug_when":"2014-08-17 23:45:41 -0700","thetext":"This seems like a quite useful idea, so I implemented this change, and tested it in modern browsers (Chrome 36, FF 31, IE 11).\n\nI do not see a meaningful speed improvement; either the script loaders have been improved or the current version of sth.js negates the effect of this improvement.\n\nRecommend Resolve - Wontfix"},{"commentid":9803,"comment_count":6,"who":{"uid":"sam.mikes","name":"Sam Mikes"},"bug_when":"2014-08-18 04:53:54 -0700","thetext":"Actually, the picture is more complicated than my previous post suggests.\n\nRunning more thorough tests, I find\n\n- a large speedup (0.6 mins -> 0.1 mins) with FF\n- a moderate speedup (0.3 mins -> 0.2 mins) with IE11\n- a slight slowdown (0.2 mins -> 0.3 mins) with Chrome\n\nI have been using ch08, ch09, ch10 (about 700 tests) as my benchmark."}],"attachment":[{"_attributes":{"isobsolete":"1","ispatch":"0"},"attachid":"2","date":"2011-06-25 09:05:00 -0700","delta_ts":"2011-07-03 13:26:16 -0700","desc":"faster sth.js file","filename":"sthDocfrag.js","type":"application/javascript","size":"17524","attacher":{"_attributes":{"name":"David Bruant"},"_text":"bruant.d"},"data":{"_attributes":{"encoding":"base64"},"_text":"77u/Ly8vIENvcHlyaWdodCAoYykgMjAwOSBNaWNyb3NvZnQgQ29ycG9yYXRpb24gDQovLy8gDQov\nLy8gUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0\naCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZA0KLy8vIHRo\nYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6IA0KLy8vICAgICogUmVkaXN0cmli\ndXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90\naWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQNCi8vLyAgICAgIHRoZSBmb2xsb3dpbmcg\nZGlzY2xhaW1lci4gDQovLy8gICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVz\ndCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25k\naXRpb25zIGFuZCANCi8vLyAgICAgIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9j\ndW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3Ry\naWJ1dGlvbi4gIA0KLy8vICAgICogTmVpdGhlciB0aGUgbmFtZSBvZiBNaWNyb3NvZnQgbm9yIHRo\nZSBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvDQovLy8gICAgICBlbmRv\ncnNlIG9yIHByb21vdGUgcHJvZHVjdHMgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91\ndCBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uDQovLy8gDQovLy8gVEhJUyBTT0ZU\nV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9S\nUyAiQVMgSVMiIEFORCBBTlkgRVhQUkVTUyBPUg0KLy8vIElNUExJRUQgV0FSUkFOVElFUywgSU5D\nTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEIFdBUlJBTlRJRVMgT0YgTUVS\nQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTDQovLy8gRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFS\nRSBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIE9XTkVSIE9SIENP\nTlRSSUJVVE9SUyBCRSBMSUFCTEUNCi8vLyBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lE\nRU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNM\nVURJTkcsIEJVVCBOT1QNCi8vLyBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRF\nIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVT\nSU5FU1MNCi8vLyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZ\nIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwNCi8v\nLyBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4g\nQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGDQovLy8gQURW\nSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuIA0KDQoNCi8qDQogKiBSdW4g\nYSB0ZXN0IGluIHRoZSBicm93c2VyLiBXb3JrcyBieSBpbmplY3RpbmcgYW4gaWZyYW1lIHdpdGgg\ndGhlIHRlc3QgY29kZS4NCiAqDQogKiBQdWJsaWMgTWV0aG9kczoNCiAqICogcnVuKGlkLCB0ZXN0\nKTogUnVucyB0aGUgdGVzdCBzcGVjaWZpZWQuDQogKg0KICogQ2FsbGJhY2tzOg0KICogKiBvbkNv\nbXBsZXRlKHRlc3QpOiBDYWxsZWQgd2hlbiB0aGUgdGVzdCBpcyBydW4uIFRlc3Qgb2JqZWN0IGNv\nbnRhaW5zIHJlc3VsdCBhbmQgZXJyb3Igc3RyaW5ncyBkZXNjcmliaW5nIGhvdyB0aGUNCiAqICAg\nICAgICAgICAgICAgICAgICAgdGVzdCByYW4uDQogKi8NCmZ1bmN0aW9uIEJyb3dzZXJSdW5uZXIo\nKSB7DQogICAgdmFyIGN1cnJlbnRUZXN0LCAgICAgICAgLy8gQ3VycmVudCB0ZXN0IGJlaW5nIHJ1\nbi4NCiAgICAgICAgc2NyaXB0Q2FjaGUgPSB7fSwgICAvLyBIb2xkcyB0aGUgdmFyaW91cyBpbmNs\ndWRlcyByZXF1aXJlZCB0byBydW4gY2VydGFpbiBzcHV0bmlrIHRlc3RzLg0KICAgICAgICBpbnN0\nYW5jZSAgICA9IHRoaXM7DQoNCiAgICAvKiBDYWxsZWQgYnkgdGhlIGNoaWxkIHdpbmRvdyB0byBu\nb3RpZnkgdGhhdCB0aGUgdGVzdCBoYXMgZmluaXNoZWQuIFRoaXMgZnVuY3Rpb24gY2FsbCBpcyBw\ndXQgaW4gYSBzZXBhcmF0ZSBzY3JpcHQNCiAgICAgKiBibG9jayBhdCB0aGUgZW5kIG9mIHRoZSBw\nYWdlIHNvIGVycm9ycyBpbiB0aGUgdGVzdCBzY3JpcHQgYmxvY2sgc2hvdWxkIG5vdCBwcmV2ZW50\nIHRoaXMgZnVuY3Rpb24gZnJvbSBiZWluZw0KICAgICAqIGNhbGxlZC4NCiAgICAgKi8NCiAgICBm\ndW5jdGlvbiB0ZXN0RmluaXNoZWQoKSB7DQogICAgICAgIGlmKHR5cGVvZiBjdXJyZW50VGVzdC5y\nZXN1bHQgPT09ICJ1bmRlZmluZWQiKSB7DQogICAgICAgICAgICAvLyBXZSBkaWRuJ3QgZ2V0IGEg\nY2FsbCB0byB0ZXN0UnVuLCB3aGljaCBsaWtlbHkgbWVhbnMgdGhlIHRlc3QgZmFpbGVkIHRvIGxv\nYWQuDQogICAgICAgICAgICBjdXJyZW50VGVzdC5yZXN1bHQgPSAiZmFpbCI7DQogICAgICAgICAg\nICBjdXJyZW50VGVzdC5lcnJvciAgPSAiRmFpbGVkIHRvIExvYWQiOw0KICAgICAgICB9IGVsc2Ug\naWYodHlwZW9mIGN1cnJlbnRUZXN0LmVycm9yICE9PSAidW5kZWZpbmVkIikgew0KICAgICAgICAg\nICAgLy8gV2UgaGF2ZSBhbiBlcnJvciBsb2dnZWQgZnJvbSB0ZXN0UnVuLg0KICAgICAgICAgICAg\naWYoY3VycmVudFRlc3QuZXJyb3IgaW5zdGFuY2VvZiBTcHV0bmlrRXJyb3IpIHsNCiAgICAgICAg\nICAgICAgICBjdXJyZW50VGVzdC5lcnJvciA9IGN1cnJlbnRUZXN0Lm1lc3NhZ2U7DQogICAgICAg\nICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGN1cnJlbnRUZXN0LmVycm9yID0gY3VycmVu\ndFRlc3QuZXJyb3IubmFtZSArICI6ICIgKyBjdXJyZW50VGVzdC5lcnJvci5tZXNzYWdlDQogICAg\nICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBpbnN0YW5jZS5vbkNvbXBsZXRlKGN1cnJl\nbnRUZXN0KTsNCiAgICB9DQoNCiAgICAvKiBDYWxsZWQgZnJvbSB0aGUgY2hpbGQgd2luZG93IGFm\ndGVyIHRoZSB0ZXN0IGhhcyBydW4uICovDQogICAgZnVuY3Rpb24gdGVzdFJ1bihpZCwgcGF0aCwg\nZGVzY3JpcHRpb24sIGNvZGVTdHJpbmcsIHByZWNvbmRpdGlvblN0cmluZywgcmVzdWx0LCBlcnJv\ncikgew0KICAgICAgICBjdXJyZW50VGVzdC5pZCA9IGlkOw0KICAgICAgICBjdXJyZW50VGVzdC5w\nYXRoID0gcGF0aDsNCiAgICAgICAgY3VycmVudFRlc3QuZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlv\nbjsNCiAgICAgICAgY3VycmVudFRlc3QucmVzdWx0ID0gcmVzdWx0Ow0KICAgICAgICBjdXJyZW50\nVGVzdC5lcnJvciA9IGVycm9yOw0KICAgICAgICBjdXJyZW50VGVzdC5jb2RlID0gY29kZVN0cmlu\nZzsNCiAgICAgICAgY3VycmVudFRlc3QucHJlID0gcHJlY29uZGl0aW9uU3RyaW5nOw0KICAgIH0N\nCg0KDQogICAgLyogUnVuIHRoZSB0ZXN0LiAqLw0KICAgIHRoaXMucnVuID0gZnVuY3Rpb24oaWQs\nIGNvZGUpIHsNCiAgICAgICAgdmFyIGlmcmFtZTsNCiAgICAgICAgdmFyIGluY2x1ZGVzID0gY29k\nZS5tYXRjaCgvXCRJTkNMVURFXCgoW15cKV0rKVwpL2cpLCAvLyBmaW5kIGFsbCBvZiB0aGUgJElO\nQ0xVREUgc3RhdGVtZW50cw0KICAgICAgICAgICAgaW5jbHVkZTsNCg0KICAgICAgICBjdXJyZW50\nVGVzdCA9IHtpZDogaWR9OyAvLyBkZWZhdWx0IHRlc3QsIGluIGNhc2UgaXQgZG9lc24ndCBnZXQg\ncmVnaXN0ZXJlZC4NCg0KICAgICAgICBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJp\nZnJhbWUiKTsNCiAgICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgic3R5bGUiLCAiZGlzcGxheTpu\nb25lIik7DQogICAgICAgIGlmcmFtZS5zZXRBdHRyaWJ1dGUoImlkIiwgInJ1bm5lcklmcmFtZSIp\nOw0KDQogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaWZyYW1lKTsNCg0KICAgICAg\nICB2YXIgd2luID0gaWZyYW1lLmNvbnRlbnRXaW5kb3c7IA0KICAgICAgICB2YXIgaWZyYW1lRG9j\nID0gd2luLmRvY3VtZW50Ow0KICAgICAgICANCiAgICAgICAgdmFyIHNjcmlwdHMgPSBpZnJhbWVE\nb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOw0KDQogICAgICAgIGZ1bmN0aW9uIGFkZFNjcmlw\ndChjb2RlKXsNCiAgICAgICAgICB2YXIgc2NyaXB0RWxlbWVudCA9IGlmcmFtZURvYy5jcmVhdGVF\nbGVtZW50KCdzY3JpcHQnKTsNCiAgICAgICAgICBzY3JpcHRFbGVtZW50LnR5cGUgPSAndGV4dC9q\nYXZhc2NyaXB0JzsNCiAgICAgICAgICBzY3JpcHRFbGVtZW50LnRleHRDb250ZW50ID0gY29kZTsN\nCiAgICAgICAgICBzY3JpcHRzLmFwcGVuZENoaWxkKHNjcmlwdEVsZW1lbnQpOyAvLyBBcHBlbmRp\nbmcgYXQgdGhlIGVuZCB0byByZXNwZWN0IHNjcmlwdCBpbnNlcnRpb24gb3JkZXINCiAgICAgICAg\nfQ0KDQogICAgICAgIC8vIFNldCB1cCBzb21lIGdsb2JhbHMuDQogICAgICAgIHdpbi50ZXN0UnVu\nID0gdGVzdFJ1bjsNCiAgICAgICAgDQogICAgICAgIC8vVE9ETzogdGhlc2Ugc2hvdWxkIGJlIG1v\ndmVkIHRvIHN0YS5qcw0KICAgICAgICB3aW4uU3B1dG5pa0Vycm9yID0gU3B1dG5pa0Vycm9yOw0K\nICAgICAgICB3aW4uJEVSUk9SID0gJEVSUk9SOw0KICAgICAgICB3aW4uJEZBSUwgID0gJEZBSUw7\nDQogICAgICAgIHdpbi4kUFJJTlQgPSBmdW5jdGlvbiAoKSB7fTsNCiAgICAgICAgd2luLiRJTkNM\nVURFID0gZnVuY3Rpb24oKSB7fTsNCg0KICAgICAgICBpZihpbmNsdWRlcyAhPT0gbnVsbCkgew0K\nICAgICAgICAgICAgLy8gV2UgaGF2ZSBzb21lIGluY2x1ZGVzLCBzbyBsb29wIHRocm91Z2ggZWFj\naCBpbmNsdWRlIGFuZCBwdWxsIGluIHRoZSBkZXBlbmRlbmNpZXMuDQogICAgICAgICAgICBmb3Io\ndmFyIGkgPSAwOyBpIDwgaW5jbHVkZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICBp\nbmNsdWRlID0gaW5jbHVkZXNbaV0ucmVwbGFjZSgvLipcKCgnfCIpKC4qKSgnfCIpXCkvLCAiJDIi\nKTsNCg0KICAgICAgICAgICAgICAgIC8vIEZpcnN0IGNoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIHRo\naXMgc2NyaXB0IGNhY2hlZCBhbHJlYWR5LCBhbmQgaWYgbm90LCBncmFiIGl0Lg0KICAgICAgICAg\nICAgICAgIGlmKHR5cGVvZiBzY3JpcHRDYWNoZVtpbmNsdWRlXSA9PT0gInVuZGVmaW5lZCIpIHsN\nCiAgICAgICAgICAgICAgICAgICAgJC5hamF4KHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGFz\neW5jOiBmYWxzZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogJ3Jlc291cmNlcy9zY3Jp\ncHRzL2dsb2JhbC8nICsgaW5jbHVkZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6\nIGZ1bmN0aW9uKHMpIHsgc2NyaXB0Q2FjaGVbaW5jbHVkZV0gPSBzOyB9DQogICAgICAgICAgICAg\nICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAg\nICAgICAgICAvLyBGaW5hbGx5LCB3cml0ZSB0aGUgcmVxdWlyZWQgc2NyaXB0IHRvIHRoZSB3aW5k\nb3cuDQogICAgICAgICAgICAgICAgYWRkU2NyaXB0KHNjcmlwdENhY2hlW2luY2x1ZGVdKTsNCiAg\nICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICAgICANCiAgICAgICAgLy9Xcml0ZSBvdXQg\nYWxsIG9mIG91ciBoZWxwZXIgZnVuY3Rpb25zDQogICAgICAgIGFkZFNjcmlwdChQaWNrbGVkU2lt\ncGxlVGVzdEFQSXMpOw0KICAgICAgICANCiAgICAgICAgLy8tLVNjZW5hcmlvIDE6IHdlJ3JlIGRl\nYWxpbmcgd2l0aCBhIGdsb2JhbCBzY29wZSB0ZXN0IGNhc2UNCiAgICAgICAgaWYgKEdsb2JhbFNj\nb3BlVGVzdHNbaWRdIT09dW5kZWZpbmVkKSB7DQogICAgICAgICAgICB3aW4uaWZyYW1lRXJyb3Ig\nPSB1bmRlZmluZWQ7DQogICAgICAgICAgICB3aW4ub25lcnJvciA9IHVuZGVmaW5lZDsNCiAgICAg\nICAgICAgIHdpbi5vbkVycm9ySGFjayA9IHVuZGVmaW5lZDsNCg0KICAgICAgICAgICAgLy9BZGQg\nYW4gZXJyb3IgaGFuZGxlcg0KICAgICAgICAgICAgYWRkU2NyaXB0KCJ3aW5kb3cub25lcnJvciA9\nIGZ1bmN0aW9uKGVycm9yTXNnLCB1cmwsIGxpbmVOdW1iZXIpIHt3aW5kb3cuaWZyYW1lRXJyb3Ig\nPSBlcnJvck1zZzt9OyIpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICAvL1BhcnNlIGFuZCBl\neGVjdXRlIHRoZSBjb2RlDQogICAgICAgICAgICBhZGRTY3JpcHQoIm9uRXJyb3JIYWNrID0gdHJ1\nZTt0cnl7IiArIGNvZGUgKyAifWNhdGNoKHRlc3QyNjJSdW50aW1lRXJyb3Ipe3dpbmRvdy5pZnJh\nbWVFcnJvcj10ZXN0MjYyUnVudGltZUVycm9yLm1lc3NhZ2UgfHwgJ05vbmUnO30iKTsNCiAgICAg\nICAgfQ0KICAgICAgICAvLy0tU2NlbmFyaW8gMjogIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIG5vcm1h\nbCBwb3NpdGl2ZSg/KSB0ZXN0IGNhc2UNCiAgICAgICAgZWxzZSB7DQogICAgICAgIA0KICAgICAg\nICAgICAgLy8gV3JpdGUgRVM1SGFybmVzcy5yZWdpc3RlclRlc3QgYW5kIGZuR2xvYmFsT2JqZWN0\nLCB3aGljaCByZXR1cm5zIHRoZSBnbG9iYWwgb2JqZWN0LCBhbmQgdGhlIHRlc3RGaW5pc2hlZCBj\nYWxsLg0KICAgICAgICAgICAgYWRkU2NyaXB0KCJFUzVIYXJuZXNzID0ge307IiArDQogICAgICAg\nICAgICAgICAgICAgICAgIkVTNUhhcm5lc3MucmVnaXN0ZXJUZXN0ID0gZnVuY3Rpb24odGVzdCkg\neyIgKw0KICAgICAgICAgICAgICAgICAgICAgICIgIHZhciBlcnJvcjsiICsNCiAgICAgICAgICAg\nICAgICAgICAgICAiICBpZih0ZXN0LnByZWNvbmRpdGlvbiAmJiAhdGVzdC5wcmVjb25kaXRpb24o\nKSkgeyIgKw0KICAgICAgICAgICAgICAgICAgICAgICIgICAgdGVzdFJ1bih0ZXN0LmlkLCB0ZXN0\nLnBhdGgsIHRlc3QuZGVzY3JpcHRpb24sIHRlc3QudGVzdC50b1N0cmluZygpLHR5cGVvZiB0ZXN0\nLnByZWNvbmRpdGlvbiAhPT0gJ3VuZGVmaW5lZCcgPyB0ZXN0LnByZWNvbmRpdGlvbi50b1N0cmlu\nZygpIDogJycsICdmYWlsJywgJ1ByZWNvbmRpdGlvbiBGYWlsZWQnKTsiICsNCiAgICAgICAgICAg\nICAgICAgICAgICAiICB9IGVsc2UgeyIgKw0KICAgICAgICAgICAgICAgICAgICAgICIgICAgdmFy\nIHRlc3RUaGlzID0gdGVzdC5zdHJpY3Q9PT11bmRlZmluZWQgPyB3aW5kb3cgOiB1bmRlZmluZWQ7\nIiArDQogICAgICAgICAgICAgICAgICAgICAgIiAgICB0cnkgeyB2YXIgcmVzID0gdGVzdC50ZXN0\nLmNhbGwodGVzdFRoaXMpOyB9IGNhdGNoKGUpIHsgcmVzID0gJ2ZhaWwnOyBlcnJvciA9IGU7IH0i\nICsNCiAgICAgICAgICAgICAgICAgICAgICAiICAgIHZhciByZXRWYWwgPSAvXnMvaS50ZXN0KHRl\nc3QuaWQpID8gKHJlcyA9PT0gdHJ1ZSB8fCB0eXBlb2YgcmVzID09PSAndW5kZWZpbmVkJyA/ICdw\nYXNzJyA6ICdmYWlsJykgOiAocmVzID09PSB0cnVlID8gJ3Bhc3MnIDogJ2ZhaWwnKTsiICsNCiAg\nICAgICAgICAgICAgICAgICAgICAiICAgIHRlc3RSdW4odGVzdC5pZCwgdGVzdC5wYXRoLCB0ZXN0\nLmRlc2NyaXB0aW9uLCB0ZXN0LnRlc3QudG9TdHJpbmcoKSwgdHlwZW9mIHRlc3QucHJlY29uZGl0\naW9uICE9PSAndW5kZWZpbmVkJyA/IHRlc3QucHJlY29uZGl0aW9uLnRvU3RyaW5nKCkgOiAnJywg\ncmV0VmFsLCBlcnJvcik7IiArDQogICAgICAgICAgICAgICAgICAgICAgIiAgfSIgKw0KICAgICAg\nICAgICAgICAgICAgICAgICJ9Iik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGFkZFNjcmlw\ndChjb2RlKTsgICAgIA0KICAgICAgICB9DQoNCiAgICAgICAgaWZyYW1lRG9jLmhlYWQuYXBwZW5k\nQ2hpbGQoc2NyaXB0cyk7IC8vIEFwcGVuZGluZyB0aGUgZG9jdW1lbnQgZnJhZ21lbnQgdG8gbG9h\nZCBhbGwgc2NyaXB0cyBhdCBvbmNlLg0KDQogICAgICAgIGlmIChHbG9iYWxTY29wZVRlc3RzW2lk\nXSE9PXVuZGVmaW5lZCkgeyAvLyBHYXRoZXIgcmVzdWx0cw0KICAgICAgICAgICAgdmFyIHRlc3RE\nZXNjcmlwID0gR2xvYmFsU2NvcGVUZXN0c1tpZF07DQogICAgICAgICAgICANCiAgICAgICAgICAg\nIGlmICh0ZXN0RGVzY3JpcC5uZWdhdGl2ZSE9PXVuZGVmaW5lZCkgeyAgLy9BbiBleGNlcHRpb24g\naXMgZXhwZWN0ZWQNCiAgICAgICAgICAgICAgICBpZiAod2luLm9uRXJyb3JIYWNrPT09dW5kZWZp\nbmVkKSB7ICAvL0hhY2sgZm9yIGJyb3dzZXJzIG5vdCBzdXBwb3J0aW5nIHdpbmRvdy5vbmVycm9y\nIFdSVCBlYXJseSBwYXJzZSBlcnJvcnMNCiAgICAgICAgICAgICAgICAgICAgdGVzdFJ1bih0ZXN0\nRGVzY3JpcC5pZCwgdGVzdERlc2NyaXAucGF0aCwgdGVzdERlc2NyaXAuZGVzY3JpcHRpb24sIGNv\nZGUsIHR5cGVvZiB0ZXN0RGVzY3JpcC5wcmVjb25kaXRpb24gIT09ICd1bmRlZmluZWQnID8gdGVz\ndERlc2NyaXAucHJlY29uZGl0aW9uLnRvU3RyaW5nKCkgOiAnJywgDQogICAgICAgICAgICAgICAg\nICAgICAgICAgICAgJ3Bhc3MnLCAnTm90IHBhcnNhYmxlJyk7DQogICAgICAgICAgICAgICAgfQ0K\nICAgICAgICAgICAgICAgIGVsc2UgaWYgKHdpbi5pZnJhbWVFcnJvcj09PXVuZGVmaW5lZCkgeyAv\nL25vIGV4Y2VwdGlvbiB3YXMgdGhyb3duDQogICAgICAgICAgICAgICAgICAgIHRlc3RSdW4odGVz\ndERlc2NyaXAuaWQsIHRlc3REZXNjcmlwLnBhdGgsIHRlc3REZXNjcmlwLmRlc2NyaXB0aW9uLCBj\nb2RlLCB0eXBlb2YgdGVzdERlc2NyaXAucHJlY29uZGl0aW9uICE9PSAndW5kZWZpbmVkJyA/IHRl\nc3REZXNjcmlwLnByZWNvbmRpdGlvbi50b1N0cmluZygpIDogJycsIA0KICAgICAgICAgICAgICAg\nICAgICAgICAgICAgICdmYWlsJywgJ05vIEV4Y2VwdGlvbiBUaHJvd24nKTsNCiAgICAgICAgICAg\nICAgICB9IGVsc2UgaWYoISAobmV3IFJlZ0V4cCh0ZXN0RGVzY3JpcC5uZWdhdGl2ZSwgImkiKS50\nZXN0KHdpbi5pZnJhbWVFcnJvcikpKSB7ICAvL3dyb25nIHR5cGUgb2YgZXhjZXB0aW9uIHRocm93\nbg0KICAgICAgICAgICAgICAgICAgICB0ZXN0UnVuKHRlc3REZXNjcmlwLmlkLCB0ZXN0RGVzY3Jp\ncC5wYXRoLCB0ZXN0RGVzY3JpcC5kZXNjcmlwdGlvbiwgY29kZSwgdHlwZW9mIHRlc3REZXNjcmlw\nLnByZWNvbmRpdGlvbiAhPT0gJ3VuZGVmaW5lZCcgPyB0ZXN0RGVzY3JpcC5wcmVjb25kaXRpb24u\ndG9TdHJpbmcoKSA6ICcnLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZmFpbCcsICdX\ncm9uZyBUeXBlIG9mIEV4Y2VwdGlvbiBUaHJvd24nKTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ug\new0KICAgICAgICAgICAgICAgICAgICB0ZXN0UnVuKHRlc3REZXNjcmlwLmlkLCB0ZXN0RGVzY3Jp\ncC5wYXRoLCB0ZXN0RGVzY3JpcC5kZXNjcmlwdGlvbiwgY29kZSwgdHlwZW9mIHRlc3REZXNjcmlw\nLnByZWNvbmRpdGlvbiAhPT0gJ3VuZGVmaW5lZCcgPyB0ZXN0RGVzY3JpcC5wcmVjb25kaXRpb24u\ndG9TdHJpbmcoKSA6ICcnLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncGFzcycsIHVu\nZGVmaW5lZCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSBlbHNlIGlmICh3aW4u\naWZyYW1lRXJyb3IhPT11bmRlZmluZWQpIHsgIC8vRXhjZXB0aW9uIHdhcyBub3QgZXhwZWN0ZWQg\ndG8gYmUgdGhyb3duDQogICAgICAgICAgICAgICAgdGVzdFJ1bih0ZXN0RGVzY3JpcC5pZCwgdGVz\ndERlc2NyaXAucGF0aCwgdGVzdERlc2NyaXAuZGVzY3JpcHRpb24sIGNvZGUsIHR5cGVvZiB0ZXN0\nRGVzY3JpcC5wcmVjb25kaXRpb24gIT09ICd1bmRlZmluZWQnID8gdGVzdERlc2NyaXAucHJlY29u\nZGl0aW9uLnRvU3RyaW5nKCkgOiAnJywgDQogICAgICAgICAgICAgICAgICAgICAgICAnZmFpbCcs\nICdVbmV4cGVjdGVkIEV4Y2VwdGlvbicpOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAg\nICAgICAgICB0ZXN0UnVuKHRlc3REZXNjcmlwLmlkLCB0ZXN0RGVzY3JpcC5wYXRoLCB0ZXN0RGVz\nY3JpcC5kZXNjcmlwdGlvbiwgY29kZSwgdHlwZW9mIHRlc3REZXNjcmlwLnByZWNvbmRpdGlvbiAh\nPT0gJ3VuZGVmaW5lZCcgPyB0ZXN0RGVzY3JpcC5wcmVjb25kaXRpb24udG9TdHJpbmcoKSA6ICcn\nLCANCiAgICAgICAgICAgICAgICAgICAgICAgICdwYXNzJywgdW5kZWZpbmVkKTsNCiAgICAgICAg\nICAgIH0NCiAgICAgICAgfQ0KIA0KICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGlm\ncmFtZSk7DQogICAgICAgIHRlc3RGaW5pc2hlZCgpOw0KICAgIH0NCn0NCg0KLyogTG9hZHMgdGVz\ndHMgZnJvbSB0aGUgc2VjdGlvbnMgc3BlY2lmaWVkIGluIHRlc3RjYXNlc2xpc3QuanNvbi4NCiAq\nIFB1YmxpYyBNZXRob2RzOg0KICogKiBnZXROZXh0VGVzdCgpIC0gU3RhcnQgbG9hZGluZyB0aGUg\nbmV4dCB0ZXN0Lg0KICogKiByZXNldCgpIC0gU3RhcnQgb3ZlciBhdCB0aGUgZmlyc3QgdGVzdC4N\nCiAqDQogKiBDYWxsYmFja3M6DQogKiAqIG9uTG9hZGluZ05leHRTZWN0aW9uKHBhdGgpOiBDYWxs\nZWQgYWZ0ZXIgYSByZXF1ZXN0IGlzIHNlbnQgZm9yIHRoZSBuZXh0IHNlY3Rpb24geG1sLCB3aXRo\nIHRoZSBwYXRoIHRvIHRoYXQgeG1sLg0KICogKiBvbkluaXRpYWxpemVkKHRvdGFsVGVzdHMsIHZl\ncnNpb24sIGRhdGUpOiBDYWxsZWQgYWZ0ZXIgdGhlIHRlc3RjYXNlc2xpc3QueG1sIGlzIGxvYWRl\nZCBhbmQgcGFyc2VkLg0KICogKiBvblRlc3RSZWFkeShpZCwgY29kZSk6IENhbGxlZCB3aGVuIGEg\ndGVzdCBpcyByZWFkeSB3aXRoIHRoZSB0ZXN0J3MgaWQgYW5kIGNvZGUuDQogKiAqIG9uVGVzdHNF\neGhhdXN0ZWQoKTogQ2FsbGVkIHdoZW4gdGhlcmUgYXJlIG5vIG1vcmUgdGVzdHMgdG8gcnVuLg0K\nICovDQpmdW5jdGlvbiBUZXN0TG9hZGVyKCkgew0KICAgIHZhciB0ZXN0R3JvdXBzICAgICAgID0g\nW10sDQogICAgICAgIHRlc3RHcm91cEluZGV4ICAgPSAwLA0KICAgICAgICBjdXJyZW50VGVzdElu\nZGV4ID0gMCwNCiAgICAgICAgbG9hZGVyICAgICAgICAgICA9IHRoaXM7DQoNCiAgICB0aGlzLnZl\ncnNpb24gICAgPSB1bmRlZmluZWQ7DQogICAgdGhpcy5kYXRlICAgICAgID0gdW5kZWZpbmVkOw0K\nICAgIHRoaXMudG90YWxUZXN0cyA9IDA7DQoNCiAgICAvKiBHZXQgdGhlIFhNTCBmb3IgdGhlIG5l\neHQgc2VjdGlvbiAqLw0KICAgIGZ1bmN0aW9uIGdldE5leHRYTUwoKSB7DQogICAgICAgIHZhciBn\ncm91cCA9IHRlc3RHcm91cHNbdGVzdEdyb3VwSW5kZXhdOw0KICAgICAgICBjdXJyZW50VGVzdElu\nZGV4ID0gMDsNCg0KICAgICAgICBpZihncm91cC50ZXN0cy5sZW5ndGggPiAwKSB7DQogICAgICAg\nICAgICAvLyBhbHJlYWR5IGxvYWRlZCB0aGlzIHNlY3Rpb24uDQogICAgICAgICAgICBsb2FkZXIu\nZ2V0TmV4dFRlc3QoKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICAk\nLmFqYXgoe3VybDogZ3JvdXAucGF0aCwgZGF0YVR5cGU6ICdqc29uJywgc3VjY2VzczogZnVuY3Rp\nb24oZGF0YSkgew0KICAgICAgICAgICAgZ3JvdXAudGVzdHMgPSBkYXRhLnRlc3RzQ29sbGVjdGlv\nbi50ZXN0czsNCiAgICAgICAgICAgIGxvYWRlci5nZXROZXh0VGVzdCgpOw0KICAgICAgICB9LAkN\nCgllcnJvcjogZnVuY3Rpb24gKFhNTEh0dHBSZXF1ZXN0LCB0ZXh0U3RhdHVzLCBlcnJvclRocm93\nbikgew0KCQkvL2FsZXJ0KFhNTEh0dHBSZXF1ZXN0KTsgDQoJfQ0KDQoJfSk7DQoNCiAgICAgICAg\nbG9hZGVyLm9uTG9hZGluZ05leHRTZWN0aW9uKGdyb3VwLnBhdGgpOw0KICAgIH0NCg0KICAgIC8q\nIEdldCB0aGUgdGVzdCBsaXN0IHhtbCAqLw0KICAgIGZ1bmN0aW9uIGxvYWRUZXN0WE1MKCkgew0K\nICAgICAgICB2YXIgdGVzdHNMaXN0TG9hZGVyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7DQoNCiAg\nICAgICAgJC5hamF4KHt1cmw6IFRFU1RfTElTVF9QQVRILCBkYXRhVHlwZTogJ2pzb24nLCBzdWNj\nZXNzOiBmdW5jdGlvbihkYXRhKSB7DQogICAgICAgICAgICB2YXIgdGVzdFN1aXRlID0gZGF0YS50\nZXN0U3VpdGU7DQoNCiAgICAgICAgICAgIGxvYWRlci52ZXJzaW9uICAgID0gZGF0YS52ZXJzaW9u\nOw0KICAgICAgICAgICAgbG9hZGVyLmRhdGUgICAgICAgPSBkYXRhLmRhdGU7DQogICAgICAgICAg\nICBsb2FkZXIudG90YWxUZXN0cyA9IGRhdGEubnVtVGVzdHM7ICAgICAgICAgICAgICAgDQoNCiAg\nICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGVzdFN1aXRlLmxlbmd0aDsgaSsrKSB7DQog\nICAgICAgICAgICAgICAgdGVzdEdyb3Vwc1tpXSA9IHsNCiAgICAgICAgICAgICAgICAgICAgcGF0\naDogdGVzdFN1aXRlW2ldLA0KICAgICAgICAgICAgICAgICAgICB0ZXN0czogW10NCiAgICAgICAg\nICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBsb2FkZXIub25Jbml0aWFsaXpl\nZChsb2FkZXIudG90YWxUZXN0cywgbG9hZGVyLnZlcnNpb24sIGxvYWRlci5kYXRlKTsNCiAgICAg\nICAgICAgIGdldE5leHRYTUwoKTsNCiAgICAgICAgfX0pOw0KICAgIH0NCg0KICAgIC8qIE1vdmUg\nb24gdG8gdGhlIG5leHQgdGVzdCAqLw0KICAgIHRoaXMuZ2V0TmV4dFRlc3QgPSBmdW5jdGlvbigp\nIHsNCiAgICAgICAgaWYodGVzdEdyb3Vwcy5sZW5ndGggPT0gMCkgew0KICAgICAgICAgICAgLy8g\nSW5pdGlhbGl6ZS4NCiAgICAgICAgICAgIGxvYWRUZXN0WE1MKCk7DQogICAgICAgIH0gZWxzZSBp\nZihjdXJyZW50VGVzdEluZGV4IDwgdGVzdEdyb3Vwc1t0ZXN0R3JvdXBJbmRleF0udGVzdHMubGVu\nZ3RoKSB7DQogICAgICAgICAgICAvLyBXZSBoYXZlIHRlc3RzIGxlZnQgaW4gdGhpcyB0ZXN0IGdy\nb3VwLg0KICAgICAgICAgICAgdmFyIHRlc3QgPSB0ZXN0R3JvdXBzW3Rlc3RHcm91cEluZGV4XS50\nZXN0c1tjdXJyZW50VGVzdEluZGV4KytdOw0KCSAgICB2YXIgc2NyaXB0Q29kZSA9IHRlc3QuY29k\nZTsNCiAgICAgICAgICAgIC8vdmFyIHNjcmlwdENvZGUgPSAodGVzdC5maXJzdENoaWxkLnRleHQg\nIT0gdW5kZWZpbmVkKSA/IHRlc3QuZmlyc3RDaGlsZC50ZXh0IDogdGVzdC5maXJzdENoaWxkLnRl\neHRDb250ZW50Ow0KDQogICAgICAgICAgICBsb2FkZXIub25UZXN0UmVhZHkodGVzdC5pZCwgJC5i\nYXNlNjREZWNvZGUoc2NyaXB0Q29kZSkpOw0KICAgICAgICB9IGVsc2UgaWYodGVzdEdyb3VwSW5k\nZXggPCB0ZXN0R3JvdXBzLmxlbmd0aCAtIDEpIHsNCiAgICAgICAgICAgIC8vIFdlIGRvbid0IGhh\ndmUgdGVzdHMgbGVmdCBpbiB0aGlzIHRlc3QgZ3JvdXAsIHNvIG1vdmUgb24gdG8gdGhlIG5leHQu\nDQogICAgICAgICAgICB0ZXN0R3JvdXBJbmRleCsrOw0KICAgICAgICAgICAgZ2V0TmV4dFhNTCgp\nOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgLy8gV2UncmUgZG9uZS4NCiAgICAgICAg\nICAgIGxvYWRlci5vblRlc3RzRXhoYXVzdGVkKCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICAv\nKiBTdGFydCBvdmVyIGF0IHRoZSBiZWdpbm5pbmcgKi8NCiAgICB0aGlzLnJlc2V0ID0gZnVuY3Rp\nb24oKSB7DQogICAgICAgIGN1cnJlbnRUZXN0SW5kZXggPSAwOw0KICAgICAgICB0ZXN0R3JvdXBJ\nbmRleCA9IDA7DQogICAgfQ0KfQ0KDQovKiBDb250cm9scyB0ZXN0IGdlbmVyYXRpb24gYW5kIHJ1\nbm5pbmcsIGFuZCBzZW5kcyByZXN1bHRzIHRvIHRoZSBwcmVzZW50ZXIuICovDQpmdW5jdGlvbiBD\nb250cm9sbGVyKCkgew0KICAgIHZhciBzdGF0ZSAgPSAnc3RvcHBlZCc7DQogICAgdmFyIHJ1bm5l\nciA9IG5ldyBCcm93c2VyUnVubmVyKCk7DQogICAgdmFyIGxvYWRlciA9IG5ldyBUZXN0TG9hZGVy\nKCk7DQogICAgdmFyIGNvbnRyb2xsZXIgPSB0aGlzOw0KICAgIHZhciBzdGFydFRpbWU7DQogICAg\ndmFyIGVsYXBzZWQgPSAwOw0KDQogICAgcnVubmVyLm9uQ29tcGxldGUgPSBmdW5jdGlvbih0ZXN0\nKSB7DQogICAgICAgIHByZXNlbnRlci5hZGRUZXN0UmVzdWx0KHRlc3QpOw0KDQogICAgICAgIGlm\nKHN0YXRlID09PSAncnVubmluZycpDQogICAgICAgICAgICBzZXRUaW1lb3V0KGxvYWRlci5nZXRO\nZXh0VGVzdCwgMTApOw0KICAgIH0NCg0KICAgIGxvYWRlci5vbkluaXRpYWxpemVkID0gZnVuY3Rp\nb24odG90YWxUZXN0cywgdmVyc2lvbiwgZGF0ZSkgew0KICAgICAgICBwcmVzZW50ZXIuc2V0VmVy\nc2lvbih2ZXJzaW9uKTsNCiAgICAgICAgcHJlc2VudGVyLnNldERhdGUoZGF0ZSk7DQogICAgICAg\nIHByZXNlbnRlci5zZXRUb3RhbFRlc3RzKHRvdGFsVGVzdHMpOw0KICAgIH0NCg0KICAgIGxvYWRl\nci5vbkxvYWRpbmdOZXh0U2VjdGlvbiA9IGZ1bmN0aW9uKHBhdGgpIHsNCiAgICAgICAgcHJlc2Vu\ndGVyLnVwZGF0ZVN0YXR1cygiTG9hZGluZzogIiArIHBhdGgpOw0KICAgIH0NCg0KICAgIGxvYWRl\nci5vblRlc3RSZWFkeSA9IGZ1bmN0aW9uKGlkLCB0ZXN0KSB7DQogICAgICAgIHByZXNlbnRlci51\ncGRhdGVTdGF0dXMoIkV4ZWN1dGluZyBUZXN0OiAiICsgaWQpOw0KICAgICAgICBydW5uZXIucnVu\nKGlkLCB0ZXN0KTsNCiAgICB9DQoNCiAgICBsb2FkZXIub25UZXN0c0V4aGF1c3RlZCA9IGZ1bmN0\naW9uKCkgew0KICAgICAgICBzdGF0ZSA9ICdzdG9wcGVkJzsNCiAgICAgICAgZWxhcHNlZCArPSBu\nZXcgRGF0ZSgpIC0gc3RhcnRUaW1lOw0KICAgICAgICBlbGFwc2VkID0gZWxhcHNlZC8oMTAwMCo2\nMCk7ICAvL21pbnV0ZXMNCiAgICAgICAgZWxhcHNlZCA9IGVsYXBzZWQudG9GaXhlZCgxKTsNCiAg\nICAgICAgcHJlc2VudGVyLmZpbmlzaGVkKGVsYXBzZWQpOw0KICAgIH0NCg0KICAgIHRoaXMuc3Rh\ncnQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgc3RhdGUgPSAncnVubmluZyc7DQogICAgICAgIHN0\nYXJ0VGltZSA9IG5ldyBEYXRlKCk7DQogICAgICAgIGxvYWRlci5nZXROZXh0VGVzdCgpOw0KICAg\nICAgICBwcmVzZW50ZXIuc3RhcnRlZCgpOw0KICAgIH0NCiAgICANCiAgICB0aGlzLnBhdXNlID0g\nZnVuY3Rpb24oKSB7DQogICAgICAgIGVsYXBzZWQgKz0gbmV3IERhdGUoKSAtIHN0YXJ0VGltZTsN\nCiAgICAgICAgc3RhdGUgPSAncGF1c2VkJzsNCiAgICAgICAgcHJlc2VudGVyLnBhdXNlZCgpOw0K\nICAgIH0NCg0KICAgIHRoaXMucmVzZXQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgc3RhcnRUaW1l\nID0gbmV3IERhdGUoKTsNCiAgICAgICAgZWxhcHNlZCA9IDA7DQogICAgICAgIGxvYWRlci5yZXNl\ndCgpOw0KICAgICAgICBwcmVzZW50ZXIucmVzZXQoKTsNCiAgICB9DQoNCiAgICB0aGlzLnRvZ2ds\nZSA9IGZ1bmN0aW9uKCkgew0KICAgICAgICBpZihzdGF0ZSA9PT0gJ3J1bm5pbmcnKSB7DQogICAg\nICAgICAgICBjb250cm9sbGVyLnBhdXNlKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAg\nICBjb250cm9sbGVyLnN0YXJ0KCk7DQogICAgICAgIH0NCiAgICB9DQp9DQoNCnZhciBjb250cm9s\nbGVyID0gbmV3IENvbnRyb2xsZXIoKQ0KDQovKiBIZWxwZXIgZnVuY3Rpb24gd2hpY2ggc2hvd3Mg\naWYgd2UncmUgaW4gdGhlICdkZWJ1ZycgbW9kZSBvZiB0aGUgVGVzdDI2MiBzaXRlLg0KICAgVGhp\ncyBtb2RlIGlzIG9ubHkgdXNlZnVsIGZvciBkZWJ1Z2dpbmcgaXNzdWVzIHdpdGggdGhlIHRlc3Qg\naGFybmVzcyBhbmQgDQogICB3ZWJzaXRlLiAqLw0KZnVuY3Rpb24gaXNTaXRlRGVidWdNb2RlKCkg\new0KICAgIHZhciBzdHI9d2luZG93LmxvY2F0aW9uLmhyZWYuc3Vic3RyaW5nKHdpbmRvdy5sb2Nh\ndGlvbi5ocmVmLmluZGV4T2YoIj8iKSsxKQ0KICAgIGlmKHN0ci5pbmRleE9mKCJzaXRlZGVidWci\nKSA+IC0xKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICBlbHNlIHsNCiAgICAg\nICAgcmV0dXJuIGZhbHNlOw0KICAgIH0NCn0NCg0KDQokKGZ1bmN0aW9uICgpIHsNCiAgICBwcmVz\nZW50ZXIuc2V0dXAoKTsNCg0KICAgICQoJy5jb250ZW50LWhvbWUnKS5zaG93KCk7DQogICAgLy8g\nQWRkaW5nIGF0dHJpYnV0ZSB0byB0aGUgdGFicyAoZS5nLiBIb21lLCBSdW4gZXRjLikgYW5kIGF0\ndGFjaGluZyB0aGUgY2xpY2sgZXZlbnQgb24gYnV0dG9ucyAoZS5nLiBSZXNldCwgU3RhcnQgZXRj\nLikNCiAgICAkKCcubmF2LWxpbmsnKS5lYWNoKGZ1bmN0aW9uIChpbmRleCkgew0KICAgICAgICAv\nL0FkZGluZyAidGFyZ2V0RGl2IiBhdHRyaWJ1dGUgdG8gdGhlIGhlYWRlciB0YWIgYW5kIG9uIHRo\nYXQgYmFzaXMgdGhlIGRpdiByZWxhdGVkIHRvIGhlYWRlciB0YWJzIGFyZSBkaXNwbGF5ZWQNCiAg\nICAgICAgaWYgKGluZGV4ID09PSAwKSB7DQogICAgICAgICAgICAkKHRoaXMpLmF0dHIoJ3Rhcmdl\ndERpdicsICcuY29udGVudC1ob21lJyk7DQogICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPT09IDEp\nIHsNCiAgICAgICAgICAgICQodGhpcykuYXR0cigndGFyZ2V0RGl2JywgJy5jb250ZW50LXRlc3Rz\nJyk7DQogICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPT09IDIpIHsNCiAgICAgICAgICAgICQodGhp\ncykuYXR0cigndGFyZ2V0RGl2JywgJy5jb250ZW50LXJlc3VsdHMnKTsNCiAgICAgICAgICAgICQo\ndGhpcykuYXR0cigndGVzdFJ1bm5pbmcnLCAnZmFsc2UnKTsNCiAgICAgICAgfSBlbHNlIGlmIChp\nbmRleCA9PT0gMykgew0KICAgICAgICAgICAgJCh0aGlzKS5hdHRyKCd0YXJnZXREaXYnLCAnLmNv\nbnRlbnQtZGV2Jyk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAkKHRo\naXMpLmF0dHIoJ3RhcmdldERpdicsICcuY29udGVudC1icm93c2VycycpOw0KICAgICAgICB9DQoN\nCiAgICAgICAgLy9BdHRhY2hpbmcgdGhlIGNsaWNrIGV2ZW50IHRvIHRoZSBoZWFkZXIgdGFiIHRo\nYXQgc2hvd3MgdGhlIHJlc3BlY3RpdmUgZGl2IG9mIGhlYWRlciAgICAgICAgICAgIA0KICAgICAg\nICAkKHRoaXMpLmNsaWNrKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciB0YXJnZXQgPSAk\nKHRoaXMpLmF0dHIoJ3RhcmdldERpdicpOw0KICAgICAgICAgICAgJCgnI2NvbnRlbnRDb250YWlu\nZXIgPiBkaXY6dmlzaWJsZScpLmhpZGUoKTsNCiAgICAgICAgICAgICQoJy5uYXZCYXIgLnNlbGVj\ndGVkJykudG9nZ2xlQ2xhc3MoJ3NlbGVjdGVkJyk7DQogICAgICAgICAgICAkKHRoaXMpLmFkZENs\nYXNzKCdzZWxlY3RlZCcpOw0KICAgICAgICAgICAgJCh0YXJnZXQpLnNob3coKTsNCg0KICAgICAg\nICAgICAgLy9JZiBjbGlja2VkIHRhYiBpcyBSZXN1bHQsIGl0IGdlbmVyYXRlcyB0aGUgcmVzdWx0\ncy4NCiAgICAgICAgICAgIGlmICgkKHRhcmdldCkuaGFzQ2xhc3MoJ2NvbnRlbnQtcmVzdWx0cycp\nKSB7DQogICAgICAgICAgICAgICAgcHJlc2VudGVyLnJlZnJlc2goKTsNCiAgICAgICAgICAgIH0N\nCiAgICAgICAgfSk7DQogICAgfSk7DQoNCiAgICAvL0F0dGFjaCB0aGUgY2xpY2sgZXZlbnQgdG8g\ndGhlIHN0YXJ0IGJ1dHRvbi4gSXQgc3RhcnRzLCBzdG9wcyBhbmQgcGF1c2VzIHRoZSB0ZXN0cw0K\nICAgICQoJy5idXR0b24tc3RhcnQnKS5jbGljayhmdW5jdGlvbiAoKSB7DQogICAgICAgIGNvbnRy\nb2xsZXIudG9nZ2xlKCk7DQogICAgfSk7DQoNCiAgICAvL0F0dGFjaCB0aGUgY2xpY2sgZXZlbnQg\ndG8gdGhlIHJlc2V0IGJ1dHRvbi4gSXQgcmVzZXQgYWxsIHRoZSB0ZXN0IHRvIHplcm8NCiAgICAk\nKCcuYnV0dG9uLXJlc2V0JykuY2xpY2soZnVuY3Rpb24gKCkgew0KICAgICAgICBjb250cm9sbGVy\nLnJlc2V0KCk7DQogICAgfSk7DQp9KTsNCg==\n"}},{"_attributes":{"isobsolete":"0","ispatch":"0"},"attachid":"3","date":"2011-07-03 13:26:00 -0700","delta_ts":"2011-07-03 13:26:16 -0700","desc":"faster sth.js file","filename":"sthDocfrag.js","type":"application/javascript","size":"18262","attacher":{"_attributes":{"name":"David Bruant"},"_text":"bruant.d"},"data":{"_attributes":{"encoding":"base64"},"_text":"77u/Ly8vIENvcHlyaWdodCAoYykgMjAwOSBNaWNyb3NvZnQgQ29ycG9yYXRpb24gDQovLy8gDQov\nLy8gUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0\naCBvciB3aXRob3V0IG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZA0KLy8vIHRo\nYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6IA0KLy8vICAgICogUmVkaXN0cmli\ndXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90\naWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQNCi8vLyAgICAgIHRoZSBmb2xsb3dpbmcg\nZGlzY2xhaW1lci4gDQovLy8gICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVz\ndCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25k\naXRpb25zIGFuZCANCi8vLyAgICAgIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9j\ndW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3Ry\naWJ1dGlvbi4gIA0KLy8vICAgICogTmVpdGhlciB0aGUgbmFtZSBvZiBNaWNyb3NvZnQgbm9yIHRo\nZSBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvDQovLy8gICAgICBlbmRv\ncnNlIG9yIHByb21vdGUgcHJvZHVjdHMgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91\ndCBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uDQovLy8gDQovLy8gVEhJUyBTT0ZU\nV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9S\nUyAiQVMgSVMiIEFORCBBTlkgRVhQUkVTUyBPUg0KLy8vIElNUExJRUQgV0FSUkFOVElFUywgSU5D\nTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEIFdBUlJBTlRJRVMgT0YgTUVS\nQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTDQovLy8gRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFS\nRSBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQ09QWVJJR0hUIE9XTkVSIE9SIENP\nTlRSSUJVVE9SUyBCRSBMSUFCTEUNCi8vLyBGT1IgQU5ZIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lE\nRU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIChJTkNM\nVURJTkcsIEJVVCBOT1QNCi8vLyBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRF\nIEdPT0RTIE9SIFNFUlZJQ0VTOyBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVT\nSU5FU1MNCi8vLyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTiBBTlkgVEhFT1JZ\nIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwNCi8v\nLyBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4g\nQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGDQovLy8gQURW\nSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuIA0KDQoNCi8qDQogKiBSdW4g\nYSB0ZXN0IGluIHRoZSBicm93c2VyLiBXb3JrcyBieSBpbmplY3RpbmcgYW4gaWZyYW1lIHdpdGgg\ndGhlIHRlc3QgY29kZS4NCiAqDQogKiBQdWJsaWMgTWV0aG9kczoNCiAqICogcnVuKGlkLCB0ZXN0\nKTogUnVucyB0aGUgdGVzdCBzcGVjaWZpZWQuDQogKg0KICogQ2FsbGJhY2tzOg0KICogKiBvbkNv\nbXBsZXRlKHRlc3QpOiBDYWxsZWQgd2hlbiB0aGUgdGVzdCBpcyBydW4uIFRlc3Qgb2JqZWN0IGNv\nbnRhaW5zIHJlc3VsdCBhbmQgZXJyb3Igc3RyaW5ncyBkZXNjcmliaW5nIGhvdyB0aGUNCiAqICAg\nICAgICAgICAgICAgICAgICAgdGVzdCByYW4uDQogKi8NCmZ1bmN0aW9uIEJyb3dzZXJSdW5uZXIo\nKSB7DQogICAgdmFyIGN1cnJlbnRUZXN0LCAgICAgICAgLy8gQ3VycmVudCB0ZXN0IGJlaW5nIHJ1\nbi4NCiAgICAgICAgc2NyaXB0Q2FjaGUgPSB7fSwgICAvLyBIb2xkcyB0aGUgdmFyaW91cyBpbmNs\ndWRlcyByZXF1aXJlZCB0byBydW4gY2VydGFpbiBzcHV0bmlrIHRlc3RzLg0KICAgICAgICBpbnN0\nYW5jZSAgICA9IHRoaXM7DQoNCiAgICAvKiBDYWxsZWQgYnkgdGhlIGNoaWxkIHdpbmRvdyB0byBu\nb3RpZnkgdGhhdCB0aGUgdGVzdCBoYXMgZmluaXNoZWQuIFRoaXMgZnVuY3Rpb24gY2FsbCBpcyBw\ndXQgaW4gYSBzZXBhcmF0ZSBzY3JpcHQNCiAgICAgKiBibG9jayBhdCB0aGUgZW5kIG9mIHRoZSBw\nYWdlIHNvIGVycm9ycyBpbiB0aGUgdGVzdCBzY3JpcHQgYmxvY2sgc2hvdWxkIG5vdCBwcmV2ZW50\nIHRoaXMgZnVuY3Rpb24gZnJvbSBiZWluZw0KICAgICAqIGNhbGxlZC4NCiAgICAgKi8NCiAgICBm\ndW5jdGlvbiB0ZXN0RmluaXNoZWQoKSB7DQogICAgICAgIGlmKHR5cGVvZiBjdXJyZW50VGVzdC5y\nZXN1bHQgPT09ICJ1bmRlZmluZWQiKSB7DQogICAgICAgICAgICAvLyBXZSBkaWRuJ3QgZ2V0IGEg\nY2FsbCB0byB0ZXN0UnVuLCB3aGljaCBsaWtlbHkgbWVhbnMgdGhlIHRlc3QgZmFpbGVkIHRvIGxv\nYWQuDQogICAgICAgICAgICBjdXJyZW50VGVzdC5yZXN1bHQgPSAiZmFpbCI7DQogICAgICAgICAg\nICBjdXJyZW50VGVzdC5lcnJvciAgPSAiRmFpbGVkIHRvIExvYWQiOw0KICAgICAgICB9IGVsc2Ug\naWYodHlwZW9mIGN1cnJlbnRUZXN0LmVycm9yICE9PSAidW5kZWZpbmVkIikgew0KICAgICAgICAg\nICAgLy8gV2UgaGF2ZSBhbiBlcnJvciBsb2dnZWQgZnJvbSB0ZXN0UnVuLg0KICAgICAgICAgICAg\naWYoY3VycmVudFRlc3QuZXJyb3IgaW5zdGFuY2VvZiBTcHV0bmlrRXJyb3IpIHsNCiAgICAgICAg\nICAgICAgICBjdXJyZW50VGVzdC5lcnJvciA9IGN1cnJlbnRUZXN0Lm1lc3NhZ2U7DQogICAgICAg\nICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGN1cnJlbnRUZXN0LmVycm9yID0gY3VycmVu\ndFRlc3QuZXJyb3IubmFtZSArICI6ICIgKyBjdXJyZW50VGVzdC5lcnJvci5tZXNzYWdlDQogICAg\nICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBpbnN0YW5jZS5vbkNvbXBsZXRlKGN1cnJl\nbnRUZXN0KTsNCiAgICB9DQoNCiAgICAvKiBDYWxsZWQgZnJvbSB0aGUgY2hpbGQgd2luZG93IGFm\ndGVyIHRoZSB0ZXN0IGhhcyBydW4uICovDQogICAgZnVuY3Rpb24gdGVzdFJ1bihpZCwgcGF0aCwg\nZGVzY3JpcHRpb24sIGNvZGVTdHJpbmcsIHByZWNvbmRpdGlvblN0cmluZywgcmVzdWx0LCBlcnJv\ncikgew0KICAgICAgICBjdXJyZW50VGVzdC5pZCA9IGlkOw0KICAgICAgICBjdXJyZW50VGVzdC5w\nYXRoID0gcGF0aDsNCiAgICAgICAgY3VycmVudFRlc3QuZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlv\nbjsNCiAgICAgICAgY3VycmVudFRlc3QucmVzdWx0ID0gcmVzdWx0Ow0KICAgICAgICBjdXJyZW50\nVGVzdC5lcnJvciA9IGVycm9yOw0KICAgICAgICBjdXJyZW50VGVzdC5jb2RlID0gY29kZVN0cmlu\nZzsNCiAgICAgICAgY3VycmVudFRlc3QucHJlID0gcHJlY29uZGl0aW9uU3RyaW5nOw0KICAgIH0N\nCg0KDQogICAgLyogUnVuIHRoZSB0ZXN0LiAqLw0KICAgIHRoaXMucnVuID0gZnVuY3Rpb24oaWQs\nIGNvZGUpIHsNCiAgICAgICAgdmFyIGlmcmFtZTsNCiAgICAgICAgdmFyIGluY2x1ZGVzID0gY29k\nZS5tYXRjaCgvXCRJTkNMVURFXCgoW15cKV0rKVwpL2cpLCAvLyBmaW5kIGFsbCBvZiB0aGUgJElO\nQ0xVREUgc3RhdGVtZW50cw0KICAgICAgICAgICAgaW5jbHVkZTsNCiAgICAgICAgdmFyIGluY2x1\nZGVTY3JpcHRzOw0KICAgICAgICANCiAgICAgICAgY3VycmVudFRlc3QgPSB7aWQ6IGlkfTsgLy8g\nZGVmYXVsdCB0ZXN0LCBpbiBjYXNlIGl0IGRvZXNuJ3QgZ2V0IHJlZ2lzdGVyZWQuDQogICAgICAg\nIA0KICAgICAgICAvLyBSZXRyaWV2aW5nIGluY2x1ZGVzDQogICAgICAgIC8vIERvIHRoaXMgQkVG\nT1JFIGNyZWF0aW5nIHRoZSBpZnJhbWUgaW4gb3JkZXIgdG8gYXZvaWQgaHR0cHM6Ly9idWd6aWxs\nYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjY3MjI3IG9uIGZpcmVmb3ggNCAmIDUgKCY2\nPykNCiAgICAgICAgaWYoaW5jbHVkZXMgIT09IG51bGwpIHsgDQogICAgICAgICAgICBpbmNsdWRl\nU2NyaXB0cyA9IFtdOw0KICAgICAgICAgICAgLy8gV2UgaGF2ZSBzb21lIGluY2x1ZGVzLCBzbyBs\nb29wIHRocm91Z2ggZWFjaCBpbmNsdWRlIGFuZCBwdWxsIGluIHRoZSBkZXBlbmRlbmNpZXMuDQog\nICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgaW5jbHVkZXMubGVuZ3RoOyBpKyspIHsNCiAg\nICAgICAgICAgICAgICBpbmNsdWRlID0gaW5jbHVkZXNbaV0ucmVwbGFjZSgvLipcKCgnfCIpKC4q\nKSgnfCIpXCkvLCAiJDIiKTsNCg0KICAgICAgICAgICAgICAgIC8vIEZpcnN0IGNoZWNrIHRvIHNl\nZSBpZiB3ZSBoYXZlIHRoaXMgc2NyaXB0IGNhY2hlZCBhbHJlYWR5LCBhbmQgaWYgbm90LCBncmFi\nIGl0Lg0KICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBzY3JpcHRDYWNoZVtpbmNsdWRlXSA9PT0g\nInVuZGVmaW5lZCIpIHsNCiAgICAgICAgICAgICAgICAgICAgJC5hamF4KHsNCiAgICAgICAgICAg\nICAgICAgICAgICAgIGFzeW5jOiBmYWxzZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHVybDog\nJ3Jlc291cmNlcy9zY3JpcHRzL2dsb2JhbC8nICsgaW5jbHVkZSwNCiAgICAgICAgICAgICAgICAg\nICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHMpIHsgc2NyaXB0Q2FjaGVbaW5jbHVkZV0gPSBzOyB9\nDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAg\nICAgICAgIC8vIEZpbmFsbHksIHdyaXRlIHRoZSByZXF1aXJlZCBzY3JpcHQgdG8gdGhlIHdpbmRv\ndy4NCiAgICAgICAgICAgICAgICBpbmNsdWRlU2NyaXB0cy5wdXNoKHNjcmlwdENhY2hlW2luY2x1\nZGVdKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaW5jbHVkZVNj\ncmlwdHMgPSBpbmNsdWRlU2NyaXB0cy5qb2luKCdcbicpOw0KICAgICAgICB9DQoNCiAgICAgICAg\nLy8gQ3JlYXRpbmcgaWZyYW1lDQogICAgICAgIGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1l\nbnQoImlmcmFtZSIpOw0KICAgICAgICBpZnJhbWUuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJkaXNw\nbGF5Om5vbmUiKTsNCiAgICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgiaWQiLCAicnVubmVySWZy\nYW1lIik7DQoNCiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpZnJhbWUpOw0KDQog\nICAgICAgIHZhciB3aW4gPSBpZnJhbWUuY29udGVudFdpbmRvdzsgDQogICAgICAgIHZhciBpZnJh\nbWVEb2MgPSB3aW4uZG9jdW1lbnQ7DQogICAgICAgIA0KICAgICAgICB2YXIgc2NyaXB0cyA9IGlm\ncmFtZURvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7DQogICAgICAgIA0KICAgICAgICBmdW5j\ndGlvbiBhZGRTY3JpcHQoY29kZSl7DQogICAgICAgICAgdmFyIHNjcmlwdEVsZW1lbnQgPSBpZnJh\nbWVEb2MuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7DQogICAgICAgICAgc2NyaXB0RWxlbWVudC50\neXBlID0gJ3RleHQvamF2YXNjcmlwdCc7DQogICAgICAgICAgc2NyaXB0RWxlbWVudC50ZXh0Q29u\ndGVudCA9IGNvZGU7DQogICAgICAgICAgc2NyaXB0cy5hcHBlbmRDaGlsZChzY3JpcHRFbGVtZW50\nKTsgLy8gQXBwZW5kaW5nIGF0IHRoZSBlbmQgdG8gcmVzcGVjdCBzY3JpcHQgaW5zZXJ0aW9uIG9y\nZGVyDQogICAgICAgIH0NCg0KICAgICAgICBpZih0eXBlb2YgaW5jbHVkZVNjcmlwdHMgPT09ICdz\ndHJpbmcnKXsNCiAgICAgICAgICBhZGRTY3JpcHQoaW5jbHVkZVNjcmlwdHMpOw0KICAgICAgICB9\nDQoNCiAgICAgICAgLy8gU2V0IHVwIHNvbWUgZ2xvYmFscy4NCiAgICAgICAgd2luLnRlc3RSdW4g\nPSB0ZXN0UnVuOw0KICAgICAgICANCiAgICAgICAgLy9UT0RPOiB0aGVzZSBzaG91bGQgYmUgbW92\nZWQgdG8gc3RhLmpzDQogICAgICAgIHdpbi5TcHV0bmlrRXJyb3IgPSBTcHV0bmlrRXJyb3I7DQog\nICAgICAgIHdpbi4kRVJST1IgPSAkRVJST1I7DQogICAgICAgIHdpbi4kRkFJTCAgPSAkRkFJTDsN\nCiAgICAgICAgd2luLiRQUklOVCA9IGZ1bmN0aW9uICgpIHt9Ow0KICAgICAgICB3aW4uJElOQ0xV\nREUgPSBmdW5jdGlvbigpIHt9Ow0KICAgICAgICAgICANCiAgICAgICAgLy9Xcml0ZSBvdXQgYWxs\nIG9mIG91ciBoZWxwZXIgZnVuY3Rpb25zDQogICAgICAgIGFkZFNjcmlwdChQaWNrbGVkU2ltcGxl\nVGVzdEFQSXMpOw0KICAgICAgICANCiAgICAgICAgLy8tLVNjZW5hcmlvIDE6IHdlJ3JlIGRlYWxp\nbmcgd2l0aCBhIGdsb2JhbCBzY29wZSB0ZXN0IGNhc2UNCiAgICAgICAgaWYgKEdsb2JhbFNjb3Bl\nVGVzdHNbaWRdIT09dW5kZWZpbmVkKSB7DQogICAgICAgICAgICB3aW4uaWZyYW1lRXJyb3IgPSB1\nbmRlZmluZWQ7DQogICAgICAgICAgICB3aW4ub25lcnJvciA9IHVuZGVmaW5lZDsNCiAgICAgICAg\nICAgIHdpbi5vbkVycm9ySGFjayA9IHVuZGVmaW5lZDsNCg0KICAgICAgICAgICAgLy9BZGQgYW4g\nZXJyb3IgaGFuZGxlcg0KICAgICAgICAgICAgYWRkU2NyaXB0KCJ3aW5kb3cub25lcnJvciA9IGZ1\nbmN0aW9uKGVycm9yTXNnLCB1cmwsIGxpbmVOdW1iZXIpIHt3aW5kb3cuaWZyYW1lRXJyb3IgPSBl\ncnJvck1zZzt9OyIpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICAvL1BhcnNlIGFuZCBleGVj\ndXRlIHRoZSBjb2RlDQogICAgICAgICAgICBhZGRTY3JpcHQoIm9uRXJyb3JIYWNrID0gdHJ1ZTt0\ncnl7IiArIGNvZGUgKyAifWNhdGNoKHRlc3QyNjJSdW50aW1lRXJyb3Ipe3dpbmRvdy5pZnJhbWVF\ncnJvcj10ZXN0MjYyUnVudGltZUVycm9yLm1lc3NhZ2UgfHwgJ05vbmUnO30iKTsNCiAgICAgICAg\nfQ0KICAgICAgICAvLy0tU2NlbmFyaW8gMjogIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIG5vcm1hbCBw\nb3NpdGl2ZSg/KSB0ZXN0IGNhc2UNCiAgICAgICAgZWxzZSB7DQogICAgICAgIA0KICAgICAgICAg\nICAgLy8gV3JpdGUgRVM1SGFybmVzcy5yZWdpc3RlclRlc3QgYW5kIGZuR2xvYmFsT2JqZWN0LCB3\naGljaCByZXR1cm5zIHRoZSBnbG9iYWwgb2JqZWN0LCBhbmQgdGhlIHRlc3RGaW5pc2hlZCBjYWxs\nLg0KICAgICAgICAgICAgYWRkU2NyaXB0KCJFUzVIYXJuZXNzID0ge307IiArDQogICAgICAgICAg\nICAgICAgICAgICAgIkVTNUhhcm5lc3MucmVnaXN0ZXJUZXN0ID0gZnVuY3Rpb24odGVzdCkgeyIg\nKw0KICAgICAgICAgICAgICAgICAgICAgICIgIHZhciBlcnJvcjsiICsNCiAgICAgICAgICAgICAg\nICAgICAgICAiICBpZih0ZXN0LnByZWNvbmRpdGlvbiAmJiAhdGVzdC5wcmVjb25kaXRpb24oKSkg\neyIgKw0KICAgICAgICAgICAgICAgICAgICAgICIgICAgdGVzdFJ1bih0ZXN0LmlkLCB0ZXN0LnBh\ndGgsIHRlc3QuZGVzY3JpcHRpb24sIHRlc3QudGVzdC50b1N0cmluZygpLHR5cGVvZiB0ZXN0LnBy\nZWNvbmRpdGlvbiAhPT0gJ3VuZGVmaW5lZCcgPyB0ZXN0LnByZWNvbmRpdGlvbi50b1N0cmluZygp\nIDogJycsICdmYWlsJywgJ1ByZWNvbmRpdGlvbiBGYWlsZWQnKTsiICsNCiAgICAgICAgICAgICAg\nICAgICAgICAiICB9IGVsc2UgeyIgKw0KICAgICAgICAgICAgICAgICAgICAgICIgICAgdmFyIHRl\nc3RUaGlzID0gdGVzdC5zdHJpY3Q9PT11bmRlZmluZWQgPyB3aW5kb3cgOiB1bmRlZmluZWQ7IiAr\nDQogICAgICAgICAgICAgICAgICAgICAgIiAgICB0cnkgeyB2YXIgcmVzID0gdGVzdC50ZXN0LmNh\nbGwodGVzdFRoaXMpOyB9IGNhdGNoKGUpIHsgcmVzID0gJ2ZhaWwnOyBlcnJvciA9IGU7IH0iICsN\nCiAgICAgICAgICAgICAgICAgICAgICAiICAgIHZhciByZXRWYWwgPSAvXnMvaS50ZXN0KHRlc3Qu\naWQpID8gKHJlcyA9PT0gdHJ1ZSB8fCB0eXBlb2YgcmVzID09PSAndW5kZWZpbmVkJyA/ICdwYXNz\nJyA6ICdmYWlsJykgOiAocmVzID09PSB0cnVlID8gJ3Bhc3MnIDogJ2ZhaWwnKTsiICsNCiAgICAg\nICAgICAgICAgICAgICAgICAiICAgIHRlc3RSdW4odGVzdC5pZCwgdGVzdC5wYXRoLCB0ZXN0LmRl\nc2NyaXB0aW9uLCB0ZXN0LnRlc3QudG9TdHJpbmcoKSwgdHlwZW9mIHRlc3QucHJlY29uZGl0aW9u\nICE9PSAndW5kZWZpbmVkJyA/IHRlc3QucHJlY29uZGl0aW9uLnRvU3RyaW5nKCkgOiAnJywgcmV0\nVmFsLCBlcnJvcik7IiArDQogICAgICAgICAgICAgICAgICAgICAgIiAgfSIgKw0KICAgICAgICAg\nICAgICAgICAgICAgICJ9Iik7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGFkZFNjcmlwdChj\nb2RlKTsgICAgIA0KICAgICAgICB9DQoNCiAgICAgICAgaWZyYW1lRG9jLmhlYWQuYXBwZW5kQ2hp\nbGQoc2NyaXB0cyk7IC8vIEFwcGVuZGluZyB0aGUgZG9jdW1lbnQgZnJhZ21lbnQgdG8gbG9hZCBh\nbGwgc2NyaXB0cyBhdCBvbmNlLg0KDQogICAgICAgIGlmIChHbG9iYWxTY29wZVRlc3RzW2lkXSE9\nPXVuZGVmaW5lZCkgeyAvLyBHYXRoZXIgcmVzdWx0cw0KICAgICAgICAgICAgdmFyIHRlc3REZXNj\ncmlwID0gR2xvYmFsU2NvcGVUZXN0c1tpZF07DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlm\nICh0ZXN0RGVzY3JpcC5uZWdhdGl2ZSE9PXVuZGVmaW5lZCkgeyAgLy9BbiBleGNlcHRpb24gaXMg\nZXhwZWN0ZWQNCiAgICAgICAgICAgICAgICBpZiAod2luLm9uRXJyb3JIYWNrPT09dW5kZWZpbmVk\nKSB7ICAvL0hhY2sgZm9yIGJyb3dzZXJzIG5vdCBzdXBwb3J0aW5nIHdpbmRvdy5vbmVycm9yIFdS\nVCBlYXJseSBwYXJzZSBlcnJvcnMNCiAgICAgICAgICAgICAgICAgICAgdGVzdFJ1bih0ZXN0RGVz\nY3JpcC5pZCwgdGVzdERlc2NyaXAucGF0aCwgdGVzdERlc2NyaXAuZGVzY3JpcHRpb24sIGNvZGUs\nIHR5cGVvZiB0ZXN0RGVzY3JpcC5wcmVjb25kaXRpb24gIT09ICd1bmRlZmluZWQnID8gdGVzdERl\nc2NyaXAucHJlY29uZGl0aW9uLnRvU3RyaW5nKCkgOiAnJywgDQogICAgICAgICAgICAgICAgICAg\nICAgICAgICAgJ3Bhc3MnLCAnTm90IHBhcnNhYmxlJyk7DQogICAgICAgICAgICAgICAgfQ0KICAg\nICAgICAgICAgICAgIGVsc2UgaWYgKHdpbi5pZnJhbWVFcnJvcj09PXVuZGVmaW5lZCkgeyAvL25v\nIGV4Y2VwdGlvbiB3YXMgdGhyb3duDQogICAgICAgICAgICAgICAgICAgIHRlc3RSdW4odGVzdERl\nc2NyaXAuaWQsIHRlc3REZXNjcmlwLnBhdGgsIHRlc3REZXNjcmlwLmRlc2NyaXB0aW9uLCBjb2Rl\nLCB0eXBlb2YgdGVzdERlc2NyaXAucHJlY29uZGl0aW9uICE9PSAndW5kZWZpbmVkJyA/IHRlc3RE\nZXNjcmlwLnByZWNvbmRpdGlvbi50b1N0cmluZygpIDogJycsIA0KICAgICAgICAgICAgICAgICAg\nICAgICAgICAgICdmYWlsJywgJ05vIEV4Y2VwdGlvbiBUaHJvd24nKTsNCiAgICAgICAgICAgICAg\nICB9IGVsc2UgaWYoISAobmV3IFJlZ0V4cCh0ZXN0RGVzY3JpcC5uZWdhdGl2ZSwgImkiKS50ZXN0\nKHdpbi5pZnJhbWVFcnJvcikpKSB7ICAvL3dyb25nIHR5cGUgb2YgZXhjZXB0aW9uIHRocm93bg0K\nICAgICAgICAgICAgICAgICAgICB0ZXN0UnVuKHRlc3REZXNjcmlwLmlkLCB0ZXN0RGVzY3JpcC5w\nYXRoLCB0ZXN0RGVzY3JpcC5kZXNjcmlwdGlvbiwgY29kZSwgdHlwZW9mIHRlc3REZXNjcmlwLnBy\nZWNvbmRpdGlvbiAhPT0gJ3VuZGVmaW5lZCcgPyB0ZXN0RGVzY3JpcC5wcmVjb25kaXRpb24udG9T\ndHJpbmcoKSA6ICcnLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZmFpbCcsICdXcm9u\nZyBUeXBlIG9mIEV4Y2VwdGlvbiBUaHJvd24nKTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0K\nICAgICAgICAgICAgICAgICAgICB0ZXN0UnVuKHRlc3REZXNjcmlwLmlkLCB0ZXN0RGVzY3JpcC5w\nYXRoLCB0ZXN0RGVzY3JpcC5kZXNjcmlwdGlvbiwgY29kZSwgdHlwZW9mIHRlc3REZXNjcmlwLnBy\nZWNvbmRpdGlvbiAhPT0gJ3VuZGVmaW5lZCcgPyB0ZXN0RGVzY3JpcC5wcmVjb25kaXRpb24udG9T\ndHJpbmcoKSA6ICcnLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncGFzcycsIHVuZGVm\naW5lZCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSBlbHNlIGlmICh3aW4uaWZy\nYW1lRXJyb3IhPT11bmRlZmluZWQpIHsgIC8vRXhjZXB0aW9uIHdhcyBub3QgZXhwZWN0ZWQgdG8g\nYmUgdGhyb3duDQogICAgICAgICAgICAgICAgdGVzdFJ1bih0ZXN0RGVzY3JpcC5pZCwgdGVzdERl\nc2NyaXAucGF0aCwgdGVzdERlc2NyaXAuZGVzY3JpcHRpb24sIGNvZGUsIHR5cGVvZiB0ZXN0RGVz\nY3JpcC5wcmVjb25kaXRpb24gIT09ICd1bmRlZmluZWQnID8gdGVzdERlc2NyaXAucHJlY29uZGl0\naW9uLnRvU3RyaW5nKCkgOiAnJywgDQogICAgICAgICAgICAgICAgICAgICAgICAnZmFpbCcsICdV\nbmV4cGVjdGVkIEV4Y2VwdGlvbicpOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAg\nICAgICB0ZXN0UnVuKHRlc3REZXNjcmlwLmlkLCB0ZXN0RGVzY3JpcC5wYXRoLCB0ZXN0RGVzY3Jp\ncC5kZXNjcmlwdGlvbiwgY29kZSwgdHlwZW9mIHRlc3REZXNjcmlwLnByZWNvbmRpdGlvbiAhPT0g\nJ3VuZGVmaW5lZCcgPyB0ZXN0RGVzY3JpcC5wcmVjb25kaXRpb24udG9TdHJpbmcoKSA6ICcnLCAN\nCiAgICAgICAgICAgICAgICAgICAgICAgICdwYXNzJywgdW5kZWZpbmVkKTsNCiAgICAgICAgICAg\nIH0NCiAgICAgICAgfQ0KIA0KICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGlmcmFt\nZSk7DQogICAgICAgIHRlc3RGaW5pc2hlZCgpOw0KICAgIH0NCn0NCg0KLyogTG9hZHMgdGVzdHMg\nZnJvbSB0aGUgc2VjdGlvbnMgc3BlY2lmaWVkIGluIHRlc3RjYXNlc2xpc3QuanNvbi4NCiAqIFB1\nYmxpYyBNZXRob2RzOg0KICogKiBnZXROZXh0VGVzdCgpIC0gU3RhcnQgbG9hZGluZyB0aGUgbmV4\ndCB0ZXN0Lg0KICogKiByZXNldCgpIC0gU3RhcnQgb3ZlciBhdCB0aGUgZmlyc3QgdGVzdC4NCiAq\nDQogKiBDYWxsYmFja3M6DQogKiAqIG9uTG9hZGluZ05leHRTZWN0aW9uKHBhdGgpOiBDYWxsZWQg\nYWZ0ZXIgYSByZXF1ZXN0IGlzIHNlbnQgZm9yIHRoZSBuZXh0IHNlY3Rpb24geG1sLCB3aXRoIHRo\nZSBwYXRoIHRvIHRoYXQgeG1sLg0KICogKiBvbkluaXRpYWxpemVkKHRvdGFsVGVzdHMsIHZlcnNp\nb24sIGRhdGUpOiBDYWxsZWQgYWZ0ZXIgdGhlIHRlc3RjYXNlc2xpc3QueG1sIGlzIGxvYWRlZCBh\nbmQgcGFyc2VkLg0KICogKiBvblRlc3RSZWFkeShpZCwgY29kZSk6IENhbGxlZCB3aGVuIGEgdGVz\ndCBpcyByZWFkeSB3aXRoIHRoZSB0ZXN0J3MgaWQgYW5kIGNvZGUuDQogKiAqIG9uVGVzdHNFeGhh\ndXN0ZWQoKTogQ2FsbGVkIHdoZW4gdGhlcmUgYXJlIG5vIG1vcmUgdGVzdHMgdG8gcnVuLg0KICov\nDQpmdW5jdGlvbiBUZXN0TG9hZGVyKCkgew0KICAgIHZhciB0ZXN0R3JvdXBzICAgICAgID0gW10s\nDQogICAgICAgIHRlc3RHcm91cEluZGV4ICAgPSAwLA0KICAgICAgICBjdXJyZW50VGVzdEluZGV4\nID0gMCwNCiAgICAgICAgbG9hZGVyICAgICAgICAgICA9IHRoaXM7DQoNCiAgICB0aGlzLnZlcnNp\nb24gICAgPSB1bmRlZmluZWQ7DQogICAgdGhpcy5kYXRlICAgICAgID0gdW5kZWZpbmVkOw0KICAg\nIHRoaXMudG90YWxUZXN0cyA9IDA7DQoNCiAgICAvKiBHZXQgdGhlIFhNTCBmb3IgdGhlIG5leHQg\nc2VjdGlvbiAqLw0KICAgIGZ1bmN0aW9uIGdldE5leHRYTUwoKSB7DQogICAgICAgIHZhciBncm91\ncCA9IHRlc3RHcm91cHNbdGVzdEdyb3VwSW5kZXhdOw0KICAgICAgICBjdXJyZW50VGVzdEluZGV4\nID0gMDsNCg0KICAgICAgICBpZihncm91cC50ZXN0cy5sZW5ndGggPiAwKSB7DQogICAgICAgICAg\nICAvLyBhbHJlYWR5IGxvYWRlZCB0aGlzIHNlY3Rpb24uDQogICAgICAgICAgICBsb2FkZXIuZ2V0\nTmV4dFRlc3QoKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICAkLmFq\nYXgoe3VybDogZ3JvdXAucGF0aCwgZGF0YVR5cGU6ICdqc29uJywgc3VjY2VzczogZnVuY3Rpb24o\nZGF0YSkgew0KICAgICAgICAgICAgZ3JvdXAudGVzdHMgPSBkYXRhLnRlc3RzQ29sbGVjdGlvbi50\nZXN0czsNCiAgICAgICAgICAgIGxvYWRlci5nZXROZXh0VGVzdCgpOw0KICAgICAgICB9LAkNCgll\ncnJvcjogZnVuY3Rpb24gKFhNTEh0dHBSZXF1ZXN0LCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikg\new0KCQkvL2FsZXJ0KFhNTEh0dHBSZXF1ZXN0KTsgDQoJfQ0KDQoJfSk7DQoNCiAgICAgICAgbG9h\nZGVyLm9uTG9hZGluZ05leHRTZWN0aW9uKGdyb3VwLnBhdGgpOw0KICAgIH0NCg0KICAgIC8qIEdl\ndCB0aGUgdGVzdCBsaXN0IHhtbCAqLw0KICAgIGZ1bmN0aW9uIGxvYWRUZXN0WE1MKCkgew0KICAg\nICAgICB2YXIgdGVzdHNMaXN0TG9hZGVyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7DQoNCiAgICAg\nICAgJC5hamF4KHt1cmw6IFRFU1RfTElTVF9QQVRILCBkYXRhVHlwZTogJ2pzb24nLCBzdWNjZXNz\nOiBmdW5jdGlvbihkYXRhKSB7DQogICAgICAgICAgICB2YXIgdGVzdFN1aXRlID0gZGF0YS50ZXN0\nU3VpdGU7DQoNCiAgICAgICAgICAgIGxvYWRlci52ZXJzaW9uICAgID0gZGF0YS52ZXJzaW9uOw0K\nICAgICAgICAgICAgbG9hZGVyLmRhdGUgICAgICAgPSBkYXRhLmRhdGU7DQogICAgICAgICAgICBs\nb2FkZXIudG90YWxUZXN0cyA9IGRhdGEubnVtVGVzdHM7ICAgICAgICAgICAgICAgDQoNCiAgICAg\nICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGVzdFN1aXRlLmxlbmd0aDsgaSsrKSB7DQogICAg\nICAgICAgICAgICAgdGVzdEdyb3Vwc1tpXSA9IHsNCiAgICAgICAgICAgICAgICAgICAgcGF0aDog\ndGVzdFN1aXRlW2ldLA0KICAgICAgICAgICAgICAgICAgICB0ZXN0czogW10NCiAgICAgICAgICAg\nICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBsb2FkZXIub25Jbml0aWFsaXplZChs\nb2FkZXIudG90YWxUZXN0cywgbG9hZGVyLnZlcnNpb24sIGxvYWRlci5kYXRlKTsNCiAgICAgICAg\nICAgIGdldE5leHRYTUwoKTsNCiAgICAgICAgfX0pOw0KICAgIH0NCg0KICAgIC8qIE1vdmUgb24g\ndG8gdGhlIG5leHQgdGVzdCAqLw0KICAgIHRoaXMuZ2V0TmV4dFRlc3QgPSBmdW5jdGlvbigpIHsN\nCiAgICAgICAgaWYodGVzdEdyb3Vwcy5sZW5ndGggPT0gMCkgew0KICAgICAgICAgICAgLy8gSW5p\ndGlhbGl6ZS4NCiAgICAgICAgICAgIGxvYWRUZXN0WE1MKCk7DQogICAgICAgIH0gZWxzZSBpZihj\ndXJyZW50VGVzdEluZGV4IDwgdGVzdEdyb3Vwc1t0ZXN0R3JvdXBJbmRleF0udGVzdHMubGVuZ3Ro\nKSB7DQogICAgICAgICAgICAvLyBXZSBoYXZlIHRlc3RzIGxlZnQgaW4gdGhpcyB0ZXN0IGdyb3Vw\nLg0KICAgICAgICAgICAgdmFyIHRlc3QgPSB0ZXN0R3JvdXBzW3Rlc3RHcm91cEluZGV4XS50ZXN0\nc1tjdXJyZW50VGVzdEluZGV4KytdOw0KCSAgICB2YXIgc2NyaXB0Q29kZSA9IHRlc3QuY29kZTsN\nCiAgICAgICAgICAgIC8vdmFyIHNjcmlwdENvZGUgPSAodGVzdC5maXJzdENoaWxkLnRleHQgIT0g\ndW5kZWZpbmVkKSA/IHRlc3QuZmlyc3RDaGlsZC50ZXh0IDogdGVzdC5maXJzdENoaWxkLnRleHRD\nb250ZW50Ow0KDQogICAgICAgICAgICBsb2FkZXIub25UZXN0UmVhZHkodGVzdC5pZCwgJC5iYXNl\nNjREZWNvZGUoc2NyaXB0Q29kZSkpOw0KICAgICAgICB9IGVsc2UgaWYodGVzdEdyb3VwSW5kZXgg\nPCB0ZXN0R3JvdXBzLmxlbmd0aCAtIDEpIHsNCiAgICAgICAgICAgIC8vIFdlIGRvbid0IGhhdmUg\ndGVzdHMgbGVmdCBpbiB0aGlzIHRlc3QgZ3JvdXAsIHNvIG1vdmUgb24gdG8gdGhlIG5leHQuDQog\nICAgICAgICAgICB0ZXN0R3JvdXBJbmRleCsrOw0KICAgICAgICAgICAgZ2V0TmV4dFhNTCgpOw0K\nICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgLy8gV2UncmUgZG9uZS4NCiAgICAgICAgICAg\nIGxvYWRlci5vblRlc3RzRXhoYXVzdGVkKCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICAvKiBT\ndGFydCBvdmVyIGF0IHRoZSBiZWdpbm5pbmcgKi8NCiAgICB0aGlzLnJlc2V0ID0gZnVuY3Rpb24o\nKSB7DQogICAgICAgIGN1cnJlbnRUZXN0SW5kZXggPSAwOw0KICAgICAgICB0ZXN0R3JvdXBJbmRl\neCA9IDA7DQogICAgfQ0KfQ0KDQovKiBDb250cm9scyB0ZXN0IGdlbmVyYXRpb24gYW5kIHJ1bm5p\nbmcsIGFuZCBzZW5kcyByZXN1bHRzIHRvIHRoZSBwcmVzZW50ZXIuICovDQpmdW5jdGlvbiBDb250\ncm9sbGVyKCkgew0KICAgIHZhciBzdGF0ZSAgPSAnc3RvcHBlZCc7DQogICAgdmFyIHJ1bm5lciA9\nIG5ldyBCcm93c2VyUnVubmVyKCk7DQogICAgdmFyIGxvYWRlciA9IG5ldyBUZXN0TG9hZGVyKCk7\nDQogICAgdmFyIGNvbnRyb2xsZXIgPSB0aGlzOw0KICAgIHZhciBzdGFydFRpbWU7DQogICAgdmFy\nIGVsYXBzZWQgPSAwOw0KDQogICAgLypmdW5jdGlvbiBuZXh0VGljayhjYWxsYmFjayl7DQogICAg\nICB3aW5kb3cub25tZXNzYWdlID0gY2FsbGJhY2s7DQogICAgICB3aW5kb3cucG9zdE1lc3NhZ2Uo\nJyonLCAnKicpOw0KICAgIH0qLw0KICAgIA0KICAgIGZ1bmN0aW9uIG5leHRUaWNrKGNhbGxiYWNr\nKXsNCiAgICAgIHNldFRpbWVvdXQoY2FsbGJhY2ssIDEwKTsNCiAgICB9DQoNCiAgICBydW5uZXIu\nb25Db21wbGV0ZSA9IGZ1bmN0aW9uKHRlc3QpIHsNCiAgICAgICAgcHJlc2VudGVyLmFkZFRlc3RS\nZXN1bHQodGVzdCk7DQoNCiAgICAgICAgaWYoc3RhdGUgPT09ICdydW5uaW5nJykNCiAgICAgICAg\nICAgIG5leHRUaWNrKGxvYWRlci5nZXROZXh0VGVzdCk7IC8vIHB1dCBuZXh0IHRlc3QgaW4gZXZl\nbnQgcXVldWUgc28gdGhhdCBvdGhlciBldmVudHMgKGxpa2UgY2xpY2tzIHRvIHBhdXNlKSBjYW4g\nYmUgaGFuZGxlZA0KICAgIH0NCg0KICAgIGxvYWRlci5vbkluaXRpYWxpemVkID0gZnVuY3Rpb24o\ndG90YWxUZXN0cywgdmVyc2lvbiwgZGF0ZSkgew0KICAgICAgICBwcmVzZW50ZXIuc2V0VmVyc2lv\nbih2ZXJzaW9uKTsNCiAgICAgICAgcHJlc2VudGVyLnNldERhdGUoZGF0ZSk7DQogICAgICAgIHBy\nZXNlbnRlci5zZXRUb3RhbFRlc3RzKHRvdGFsVGVzdHMpOw0KICAgIH0NCg0KICAgIGxvYWRlci5v\nbkxvYWRpbmdOZXh0U2VjdGlvbiA9IGZ1bmN0aW9uKHBhdGgpIHsNCiAgICAgICAgcHJlc2VudGVy\nLnVwZGF0ZVN0YXR1cygiTG9hZGluZzogIiArIHBhdGgpOw0KICAgIH0NCg0KICAgIGxvYWRlci5v\nblRlc3RSZWFkeSA9IGZ1bmN0aW9uKGlkLCB0ZXN0KSB7DQogICAgICAgIHByZXNlbnRlci51cGRh\ndGVTdGF0dXMoIkV4ZWN1dGluZyBUZXN0OiAiICsgaWQpOw0KICAgICAgICBydW5uZXIucnVuKGlk\nLCB0ZXN0KTsNCiAgICB9DQoNCiAgICBsb2FkZXIub25UZXN0c0V4aGF1c3RlZCA9IGZ1bmN0aW9u\nKCkgew0KICAgICAgICBzdGF0ZSA9ICdzdG9wcGVkJzsNCiAgICAgICAgZWxhcHNlZCArPSBuZXcg\nRGF0ZSgpIC0gc3RhcnRUaW1lOw0KICAgICAgICBlbGFwc2VkID0gZWxhcHNlZC8oMTAwMCo2MCk7\nICAvL21pbnV0ZXMNCiAgICAgICAgZWxhcHNlZCA9IGVsYXBzZWQudG9GaXhlZCgxKTsNCiAgICAg\nICAgcHJlc2VudGVyLmZpbmlzaGVkKGVsYXBzZWQpOw0KICAgIH0NCg0KICAgIHRoaXMuc3RhcnQg\nPSBmdW5jdGlvbigpIHsNCiAgICAgICAgc3RhdGUgPSAncnVubmluZyc7DQogICAgICAgIHN0YXJ0\nVGltZSA9IG5ldyBEYXRlKCk7DQogICAgICAgIGxvYWRlci5nZXROZXh0VGVzdCgpOw0KICAgICAg\nICBwcmVzZW50ZXIuc3RhcnRlZCgpOw0KICAgIH0NCiAgICANCiAgICB0aGlzLnBhdXNlID0gZnVu\nY3Rpb24oKSB7DQogICAgICAgIGVsYXBzZWQgKz0gbmV3IERhdGUoKSAtIHN0YXJ0VGltZTsNCiAg\nICAgICAgc3RhdGUgPSAncGF1c2VkJzsNCiAgICAgICAgcHJlc2VudGVyLnBhdXNlZCgpOw0KICAg\nIH0NCg0KICAgIHRoaXMucmVzZXQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgc3RhcnRUaW1lID0g\nbmV3IERhdGUoKTsNCiAgICAgICAgZWxhcHNlZCA9IDA7DQogICAgICAgIGxvYWRlci5yZXNldCgp\nOw0KICAgICAgICBwcmVzZW50ZXIucmVzZXQoKTsNCiAgICB9DQoNCiAgICB0aGlzLnRvZ2dsZSA9\nIGZ1bmN0aW9uKCkgew0KICAgICAgICBpZihzdGF0ZSA9PT0gJ3J1bm5pbmcnKSB7DQogICAgICAg\nICAgICBjb250cm9sbGVyLnBhdXNlKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBj\nb250cm9sbGVyLnN0YXJ0KCk7DQogICAgICAgIH0NCiAgICB9DQp9DQoNCnZhciBjb250cm9sbGVy\nID0gbmV3IENvbnRyb2xsZXIoKQ0KDQovKiBIZWxwZXIgZnVuY3Rpb24gd2hpY2ggc2hvd3MgaWYg\nd2UncmUgaW4gdGhlICdkZWJ1ZycgbW9kZSBvZiB0aGUgVGVzdDI2MiBzaXRlLg0KICAgVGhpcyBt\nb2RlIGlzIG9ubHkgdXNlZnVsIGZvciBkZWJ1Z2dpbmcgaXNzdWVzIHdpdGggdGhlIHRlc3QgaGFy\nbmVzcyBhbmQgDQogICB3ZWJzaXRlLiAqLw0KZnVuY3Rpb24gaXNTaXRlRGVidWdNb2RlKCkgew0K\nICAgIHZhciBzdHI9d2luZG93LmxvY2F0aW9uLmhyZWYuc3Vic3RyaW5nKHdpbmRvdy5sb2NhdGlv\nbi5ocmVmLmluZGV4T2YoIj8iKSsxKQ0KICAgIGlmKHN0ci5pbmRleE9mKCJzaXRlZGVidWciKSA+\nIC0xKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICBlbHNlIHsNCiAgICAgICAg\ncmV0dXJuIGZhbHNlOw0KICAgIH0NCn0NCg0KDQokKGZ1bmN0aW9uICgpIHsNCiAgICBwcmVzZW50\nZXIuc2V0dXAoKTsNCg0KICAgICQoJy5jb250ZW50LWhvbWUnKS5zaG93KCk7DQogICAgLy8gQWRk\naW5nIGF0dHJpYnV0ZSB0byB0aGUgdGFicyAoZS5nLiBIb21lLCBSdW4gZXRjLikgYW5kIGF0dGFj\naGluZyB0aGUgY2xpY2sgZXZlbnQgb24gYnV0dG9ucyAoZS5nLiBSZXNldCwgU3RhcnQgZXRjLikN\nCiAgICAkKCcubmF2LWxpbmsnKS5lYWNoKGZ1bmN0aW9uIChpbmRleCkgew0KICAgICAgICAvL0Fk\nZGluZyAidGFyZ2V0RGl2IiBhdHRyaWJ1dGUgdG8gdGhlIGhlYWRlciB0YWIgYW5kIG9uIHRoYXQg\nYmFzaXMgdGhlIGRpdiByZWxhdGVkIHRvIGhlYWRlciB0YWJzIGFyZSBkaXNwbGF5ZWQNCiAgICAg\nICAgaWYgKGluZGV4ID09PSAwKSB7DQogICAgICAgICAgICAkKHRoaXMpLmF0dHIoJ3RhcmdldERp\ndicsICcuY29udGVudC1ob21lJyk7DQogICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPT09IDEpIHsN\nCiAgICAgICAgICAgICQodGhpcykuYXR0cigndGFyZ2V0RGl2JywgJy5jb250ZW50LXRlc3RzJyk7\nDQogICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPT09IDIpIHsNCiAgICAgICAgICAgICQodGhpcyku\nYXR0cigndGFyZ2V0RGl2JywgJy5jb250ZW50LXJlc3VsdHMnKTsNCiAgICAgICAgICAgICQodGhp\ncykuYXR0cigndGVzdFJ1bm5pbmcnLCAnZmFsc2UnKTsNCiAgICAgICAgfSBlbHNlIGlmIChpbmRl\neCA9PT0gMykgew0KICAgICAgICAgICAgJCh0aGlzKS5hdHRyKCd0YXJnZXREaXYnLCAnLmNvbnRl\nbnQtZGV2Jyk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAkKHRoaXMp\nLmF0dHIoJ3RhcmdldERpdicsICcuY29udGVudC1icm93c2VycycpOw0KICAgICAgICB9DQoNCiAg\nICAgICAgLy9BdHRhY2hpbmcgdGhlIGNsaWNrIGV2ZW50IHRvIHRoZSBoZWFkZXIgdGFiIHRoYXQg\nc2hvd3MgdGhlIHJlc3BlY3RpdmUgZGl2IG9mIGhlYWRlciAgICAgICAgICAgIA0KICAgICAgICAk\nKHRoaXMpLmNsaWNrKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciB0YXJnZXQgPSAkKHRo\naXMpLmF0dHIoJ3RhcmdldERpdicpOw0KICAgICAgICAgICAgJCgnI2NvbnRlbnRDb250YWluZXIg\nPiBkaXY6dmlzaWJsZScpLmhpZGUoKTsNCiAgICAgICAgICAgICQoJy5uYXZCYXIgLnNlbGVjdGVk\nJykudG9nZ2xlQ2xhc3MoJ3NlbGVjdGVkJyk7DQogICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNz\nKCdzZWxlY3RlZCcpOw0KICAgICAgICAgICAgJCh0YXJnZXQpLnNob3coKTsNCg0KICAgICAgICAg\nICAgLy9JZiBjbGlja2VkIHRhYiBpcyBSZXN1bHQsIGl0IGdlbmVyYXRlcyB0aGUgcmVzdWx0cy4N\nCiAgICAgICAgICAgIGlmICgkKHRhcmdldCkuaGFzQ2xhc3MoJ2NvbnRlbnQtcmVzdWx0cycpKSB7\nDQogICAgICAgICAgICAgICAgcHJlc2VudGVyLnJlZnJlc2goKTsNCiAgICAgICAgICAgIH0NCiAg\nICAgICAgfSk7DQogICAgfSk7DQoNCiAgICAvL0F0dGFjaCB0aGUgY2xpY2sgZXZlbnQgdG8gdGhl\nIHN0YXJ0IGJ1dHRvbi4gSXQgc3RhcnRzLCBzdG9wcyBhbmQgcGF1c2VzIHRoZSB0ZXN0cw0KICAg\nICQoJy5idXR0b24tc3RhcnQnKS5jbGljayhmdW5jdGlvbiAoKSB7DQogICAgICAgIGNvbnRyb2xs\nZXIudG9nZ2xlKCk7DQogICAgfSk7DQoNCiAgICAvL0F0dGFjaCB0aGUgY2xpY2sgZXZlbnQgdG8g\ndGhlIHJlc2V0IGJ1dHRvbi4gSXQgcmVzZXQgYWxsIHRoZSB0ZXN0IHRvIHplcm8NCiAgICAkKCcu\nYnV0dG9uLXJlc2V0JykuY2xpY2soZnVuY3Rpb24gKCkgew0KICAgICAgICBjb250cm9sbGVyLnJl\nc2V0KCk7DQogICAgfSk7DQp9KTsNCg==\n"}}]}}
---
