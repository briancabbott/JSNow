---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":4268,"creation_ts":"2015-04-08 07:51:00 -0700","short_desc":"Presence of iterator.close checked too late","delta_ts":"2015-05-19 18:25:02 -0700","product":"Draft for 7th Edition","component":"Deferred from 6th edition","version":"unspecified","rep_platform":"All","op_sys":"All","bug_status":"CONFIRMED","priority":"Normal","bug_severity":"enhancement","everconfirmed":true,"reporter":{"uid":"rossberg","name":"Andreas Rossberg"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":"claude.pache","long_desc":[{"commentid":14158,"comment_count":0,"who":{"uid":"rossberg","name":"Andreas Rossberg"},"bug_when":"2015-04-08 07:51:16 -0700","thetext":"IIRC, we decided that the presence of a .close method on an iterator should be checked upon _entry_ into a loop. The current spec checks it upon abnormal _exit_ from the loop, by invoking IteratorClose (e.g. for-of loops in 13.6.4.13, but also elsewhere).\n\nBecause it is usually impossible to tell upfront that a .close method cannot be added during iteration, this requires that virtually _every_ iterator loop has to be executed inside an implicit try-finally, which is a significant overhead, even for the vast majority of cases that don't care about .close. In the interest of competitive performance, especially for for-of loops, we should change that semantics the way we discussed."},{"commentid":14160,"comment_count":1,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-04-08 08:10:47 -0700","thetext":"(In reply to Andreas Rossberg from comment #0)\n> IIRC, we decided that the presence of a .close method on an iterator should\n> be checked upon _entry_ into a loop.\n\nWe did? Where is that documented? Are you sure there weren't subsequent discussions?\n\nThe current spec checks it upon\n> abnormal _exit_ from the loop, by invoking IteratorClose (e.g. for-of loops\n> in 13.6.4.13, but also elsewhere).\n> \n> Because it is usually impossible to tell upfront that a .close method cannot\n> be added during iteration, this requires that virtually _every_ iterator\n> loop has to be executed inside an implicit try-finally, which is a\n> significant overhead, even for the vast majority of cases that don't care\n> about .close. In the interest of competitive performance, especially for\n> for-of loops, we should change that semantics the way we discussed.\n\nIt's also impossible to tell whether a .close method isn't deleted during iteration. \n\nPerhaps it's time to implement low cost if not triggers try blocks?"},{"commentid":14161,"comment_count":2,"who":{"uid":"rossberg","name":"Andreas Rossberg"},"bug_when":"2015-04-08 14:35:02 -0700","thetext":"(In reply to Allen Wirfs-Brock from comment #1)\n> (In reply to Andreas Rossberg from comment #0)\n> > IIRC, we decided that the presence of a .close method on an iterator should\n> > be checked upon _entry_ into a loop.\n> \n> We did? Where is that documented? Are you sure there weren't subsequent\n> discussions?\n\nI'm not aware of any subsequent discussions, but I might well have missed some. I do remember that checking for it early was the anodyne put on the table that convinced me to not block the feature. I regret not having ensured that this is recorded explicitly.\n\n> The current spec checks it upon\n> > abnormal _exit_ from the loop, by invoking IteratorClose (e.g. for-of loops\n> > in 13.6.4.13, but also elsewhere).\n> > \n> > Because it is usually impossible to tell upfront that a .close method cannot\n> > be added during iteration, this requires that virtually _every_ iterator\n> > loop has to be executed inside an implicit try-finally, which is a\n> > significant overhead, even for the vast majority of cases that don't care\n> > about .close. In the interest of competitive performance, especially for\n> > for-of loops, we should change that semantics the way we discussed.\n> \n> It's also impossible to tell whether a .close method isn't deleted during\n> iteration. \n\nSure, but that doesn't matter -- in the few cases where .close is present initially it's fine to go on a slower path. What counts is that the extra cost of dealing with .close is not imposed on all the other uses.\n\n> Perhaps it's time to implement low cost if not triggers try blocks?\n\nWe have recently done so in Turbofan. But try-finally is still not free, and I doubt it can ever be in JS. OTOH, a late added .close is an edge case of absolutely zero practical value, wouldn't you agree?"},{"commentid":14427,"comment_count":3,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-05-19 18:25:02 -0700","thetext":"deferred for ES7 discussion"}]}}
---
