---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":4013,"creation_ts":"2015-02-19 18:16:00 -0800","short_desc":"Specify behaviour of forEach when structure is mutated during iteration","delta_ts":"2015-03-04 18:58:15 -0800","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 33: February 12, 2015 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"enhancement","everconfirmed":true,"reporter":"infinity0","assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":"jorendorff","long_desc":[{"commentid":12987,"comment_count":0,"who":"infinity0","bug_when":"2015-02-19 18:16:13 -0800","thetext":"~~~~\nvar o = [0, 1, 2], seen = [];\no.forEach(function (value, i, obj) {\n  seen.push(value);\n  if (value === 1) {\n    o.pop();\n    o.push(3);\n  }\n});\n~~~~\n\nThis results in `o === seen === [0, 1, 3]` in both Firefox 31.4 and Chrome 40.0. Similar results are obtained for Set and Map as well. However, the spec for `Array.prototype.forEach` says:\n\n> Elements which are appended to the array after the call to `forEach` begins will not be visited by *callbackfn*\n\nIt would also be nice if the spec for `Set.prototype.forEach` and `Map.prototype.forEach` mentioned this behaviour explicitly. Currently, the Set spec \"sort of\" implies this behaviour, and the Map spec does not mention it at all:\n\n> [Set] However, a value will be revisited if it is deleted after it has been visited and then re-added before the to `forEach` call completes."},{"commentid":13294,"comment_count":1,"who":{"uid":"jorendorff","name":"Jason Orendorff"},"bug_when":"2015-02-24 12:05:28 -0800","thetext":"The non-normative NOTE on Array.prototype.forEach is incorrect in this detail, but the algorithm is the real standard, and that's what Firefox and Chrome are following here.\n\n(Incidentally my HTML-generating script doesn't read that NOTE properly; I should go figure that out...)\n\n\nThe spec for Set.prototype.forEach explicitly says:\n\n> New values added, after the call to forEach begins are visited.\n\nI think this is appropriate because that's how SetIterator objects work.\n\nTwo typos:\n\n1.  The comma quoted above seems ungrammatical to me.\n\n2.  There's a stray \"to\" in that paragraph as well:\n    \"before the to forEach call completes\""},{"commentid":13331,"comment_count":2,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-02-24 16:15:25 -0800","thetext":"Deleted the troublesome informative paragraph  from Array forEach because the algorithm is clear enough. \n\nKept the corresponding paragraph for Set and added a similar one for Map. These paragraphs also shouldn't be necessary but they should resolve any doubt a reader may have about whether a pseudo code for each over a list see mutation to the list.\n\nfixed the typos that Jason identified."},{"commentid":13497,"comment_count":3,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2015-03-04 18:58:15 -0800","thetext":"fixed in rev35"}]}}
---
