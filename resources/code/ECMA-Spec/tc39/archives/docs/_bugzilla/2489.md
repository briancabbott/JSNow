---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":2489,"creation_ts":"2014-01-30 10:23:00 -0800","short_desc":"6.1.7.3, 9.1.2: Interleaved Proxy handler calls can violate [[SetPrototypeOf]] invariant","delta_ts":"2014-04-06 11:30:12 -0700","product":"Draft for 6th Edition","component":"technical issue","version":"Rev 22: January 20, 2014 Draft","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":{"uid":"andrebargull","name":"André Bargull"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":["erights","tomvc.be"],"long_desc":[{"commentid":7166,"comment_count":0,"who":{"uid":"andrebargull","name":"André Bargull"},"bug_when":"2014-01-30 10:23:35 -0800","thetext":"6.1.7.3 Invariants of the Essential Internal Methods, [[SetPrototypeOf]] (V):\n\n> If target is non-extensible, [[SetPrototypeOf]] must return false,\n> unless V is the SameValue as the target’s observed [[GetPrototypeOf]] value.\n\nThis invariant can be violated in 9.1.2 [[SetPrototypeOf]] when interleaved Proxy handlers calls take place.\n\n\nTest case:\n---\nlet observedProto;\nlet obj = {};\nlet proxy = new Proxy({}, {\n  getPrototypeOf(t) {\n    // Interleaved Proxy handler call\n    print(`(2) IsExtensible(obj) = ${Reflect.isExtensible(obj)}`);\n    // Make object non-extensible and retrieve [[Prototype]]\n    Reflect.preventExtensions(obj);\n    observedProto = Reflect.getPrototypeOf(obj);\n    print(`(3) IsExtensible(obj) = ${Reflect.isExtensible(obj)}`);\n    return Reflect.getPrototypeOf(t);\n  }\n});\n\n// Change [[Prototype]] of `obj`\nprint(`(1) IsExtensible(obj) = ${Reflect.isExtensible(obj)}`);\nlet setProtoResult = Reflect.setPrototypeOf(obj, proxy);\n\n// Inspect current [[Prototype]] of `obj`\nprint(`(4) IsExtensible(obj) = ${Reflect.isExtensible(obj)}`);\nlet currentProto = Reflect.getPrototypeOf(obj);\nprint(`observedProto === currentProto? ${observedProto === currentProto}`);\nprint(`setProtoResult = ${setProtoResult}`);\n---\n\nOutput:\n---\n(1) IsExtensible(obj) = true\n(2) IsExtensible(obj) = true\n(3) IsExtensible(obj) = false\n(4) IsExtensible(obj) = false\nobservedProto === currentProto? false\nsetProtoResult = true\n---\n\nExpected:\n`setProtoResult` should be false to indicate that the [[SetPrototypeOf]] operation was rejected. And `observedProto === currentProto` should yield `true`."},{"commentid":7283,"comment_count":1,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-02-12 17:41:05 -0800","thetext":"fixed in rev23 editor's draft\n\nchanged Ordinary Object [[SetPrototypeOf]] to recheck the preconditions after the final internal call to [[GetPrototypeOf]]\n\nThe [[SetPrototypeOf]] internal method for prozy objects already worked that way."},{"commentid":7548,"comment_count":2,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-04-06 11:30:12 -0700","thetext":"fixed in rev23 draft"}]}}
---
