---
{"_attributes":{"version":"4.4.4+","urlbase":"https://bugs.ecmascript.org/","maintainer":"dherman@mozilla.com"},"bug":{"bug_id":170,"creation_ts":"2011-07-25 16:40:00 -0700","short_desc":"15.12.3 4b(ii) JSON.stringify replacer processing underspecified.","delta_ts":"2014-12-23 20:23:27 -0800","product":"Draft for 6th Edition","component":"technical issue","version":"Initial draft July 12, 2011","rep_platform":"All","op_sys":"All","bug_status":"RESOLVED","resolution":"FIXED","priority":"Normal","bug_severity":"normal","everconfirmed":true,"reporter":{"uid":"allen","name":"Allen Wirfs-Brock"},"assigned_to":{"uid":"allen","name":"Allen Wirfs-Brock"},"cc":"mathias","long_desc":[{"commentid":383,"comment_count":0,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2011-07-25 16:40:12 -0700","thetext":"see https://mail.mozilla.org/pipermail/es5-discuss/2011-April/003977.html \n\nOn Apr 12, 2011, at 2:35 PM, Jeff Walden wrote:\n\nHow JSON.stringify handles array replacer objects is...somewhat vague.  Consider:\n\nvar replacer = [0, 1, 2, 3];\nObject.prototype[3] = 3;\nObject.defineProperty(replacer, 1, {\nget: function()\n{\nObject.defineProperty(replacer, 4, { value: 4 });\ndelete replacer[2];\ndelete replacer[3];\nreplacer[5] = 5;\nreturn 1;\n}\n});\nvar s = JSON.stringify({0: { 1: { 3: { 4: { 5: { 2: \"omitted\" } } } } } }, replacer);\nassertEq(s, ???);\n\nDoes the enumeration in 15.12.3 4b(ii) grab all property names, then get each array property value in numeric order, or is order of getting unspecified?  Or does it get the length, then iterate up to that, getting each property in sequence, seeing numerically-higher properties added after the start of enumeration and omitting numerically-higher properties removed after the start of enumeration?  Does it only look at own properties, or does it look for the property in the replacer and along the entire prototype chain?  This all seems rather vague, arguably too vague for interoperable implementation.\n\nI propose that 15.12.3 4b(ii) be replaced with the following steps, which seem reasonably sensible and straightforward to describe and implement, even in JS itself.  They're also pretty similar to how the array extras methods (map/filter/some/every/forEach/indexOf/lastIndexOf) do their by-indexed-property iteration.  With these semantics we would have |s === '{\"0\":{\"1\":{\"3\":{\"3\":3}},\"3\":3},\"3\":3}'|:\n\nii.  Let len be the result of calling the [[Get]] internal method of replacer\n with the argument \"length\".\niii. Let i be 0.\niv.  While i < len:\n 1. Let item be undefined.\n 2. Let v be the result of calling the [[Get]] internal method of\n    replacer with the argument ToString(i).\n 2. If Type(v) is String then let item be v.\n 3. Else if Type(v) is Number then let item be ToString(v).\n 4. Else if Type(v) is Object then\n    a. If the [[Class]] internal property of v is \"String\" or \"Number\"\n       then let item be ToString(v).\n 5. If item is not undefined and item is not currently an element of\n    PropertyList then,\n    a. Append item to the end of PropertyList.\n 6. Let i be i + 1.\n\nAs far as compatibility of this algorithm goes...let's just say nobody is compatible with anyone on the testcase above, so there's not much existing compatibility to attempt to preserve here:\n\n* Firefox's handling is wrong even outside these axes in that it processes the replacer array anew every time an object is stringified, so it's best to ignore it.\n* IE9 seems to implement this algorithm exactly.\n* WebKit implements this *except* that it doesn't look up the prototype chain for properties.\n* Opera seems to implement the algorithm, except it gets the length every time around the loop.\n* Chrome throws an \"illegal access\" exception whose provenance within JSON.stringify isn't immediately obvious.\n\nSo how about we fix this somehow and get everyone on the same page, eh?\n\nJeff"},{"commentid":11046,"comment_count":1,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-12-16 18:25:54 -0800","thetext":"fixed in rev30 editor's draft"},{"commentid":11163,"comment_count":2,"who":{"uid":"allen","name":"Allen Wirfs-Brock"},"bug_when":"2014-12-23 20:23:27 -0800","thetext":"fixed in rev30"}]}}
---
