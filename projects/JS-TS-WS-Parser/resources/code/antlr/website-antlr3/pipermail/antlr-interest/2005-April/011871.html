<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [antlr-interest] Antlr ANT task: Seemless builds using the Antlr
	-Problems and solutions. Help appreciated!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:antlr-interest%40antlr.org?Subject=%5Bantlr-interest%5D%20Antlr%20ANT%20task%3A%20Seemless%20builds%20using%20the%20Antlr%0A%09-Problems%20and%20solutions.%20Help%20appreciated%21&In-Reply-To=20050417114748.73391.qmail%40web25110.mail.ukl.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011870.html">
   <LINK REL="Next"  HREF="011872.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[antlr-interest] Antlr ANT task: Seemless builds using the Antlr
	-Problems and solutions. Help appreciated!</H1>
    <B>Scott Stanchfield</B> 
    <A HREF="mailto:antlr-interest%40antlr.org?Subject=%5Bantlr-interest%5D%20Antlr%20ANT%20task%3A%20Seemless%20builds%20using%20the%20Antlr%0A%09-Problems%20and%20solutions.%20Help%20appreciated%21&In-Reply-To=20050417114748.73391.qmail%40web25110.mail.ukl.yahoo.com"
       TITLE="[antlr-interest] Antlr ANT task: Seemless builds using the Antlr
	-Problems and solutions. Help appreciated!">scott at javadude.com
       </A><BR>
    <I>Sun Apr 17 08:22:02 PDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="011870.html">[antlr-interest] Antlr ANT task: Seemless builds using the Antlr -
	Problems and solutions. Help appreciated!
</A></li>
        <LI>Next message: <A HREF="011872.html">[antlr-interest] Antlr ANT task: Seemless builds using the Antlr
	-Problems and solutions. Help appreciated!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11871">[ date ]</a>
              <a href="thread.html#11871">[ thread ]</a>
              <a href="subject.html#11871">[ subject ]</a>
              <a href="author.html#11871">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm working on updating the ANTLR ANT task ;)

*However*, order of .g compilation can matter, as one grammar can output
token types that another grammar needs, or there could be grammar
inheritance.

javac doesn't have this problem b/c the compiler reads &quot;all&quot; the java files
and compiles them as a group. ANTLR only processes a single file at a time. 

I was planning on checking mod times and adding the new options (-smap and
-plugin [for xml support]).

For each of your requests:
* mutiple .g files -- ANTLR itself doesn't support it
  I could probably do this, with the cavaet that order can bite you

* mapping source-&gt;dest paths - hmm... the task could do that...
  ANTLR itself doesn't &quot;know&quot; the package; it's just part of the header spec
  I'll look into this... I'd really like this meself...

* timestamps -- I want to add this to the task

* invoking twice for docs/java -- ANTLR runs with separate
  generators for each. We should be able to write a combo generator
  that we delegate to both java and docbook or html generators...
  Hmmm... If I have time, I'll take a quick poke at this, but
  it's not likely I'll have time...

I'd also like to set up some way to make &quot;clean&quot; easy, so we'll know which
files were generated by antlr. I'm doing this in the eclipse plugin (I added
&quot;clean&quot; support), but to do it for an ant build would require tracking
generated files in another file, like .antlr-generated or something. We can
then have a &lt;antlr clean=&quot;yes&quot;&gt; option that removes any generated files. (We
would have to always append to the .antlr-generated file to capture all
renames and such until a clean)
 
I'm working on the ant task today, btw, so good timing ;) Then I've got to
figure out how to contribute the changes... too much fun...

Thoughts?
-- Scott


&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">antlr-interest-bounces at antlr.org</A> 
</I>&gt;<i> [mailto:<A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">antlr-interest-bounces at antlr.org</A>] On Behalf Of M C
</I>&gt;<i> Sent: Sunday, April 17, 2005 7:48 AM
</I>&gt;<i> To: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">antlr-interest at antlr.org</A>
</I>&gt;<i> Subject: [antlr-interest] Antlr ANT task: Seemless builds 
</I>&gt;<i> using the Antlr -Problems and solutions. Help appreciated!
</I>&gt;<i> 
</I>&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> This mail is about my &quot;hard time&quot; integrating the Antlr ANT 
</I>&gt;<i> task in a seemless build enviroment. It detils some 
</I>&gt;<i> solutions, some unsolved problems and a request for changes 
</I>&gt;<i> in the next Antlr version.
</I>&gt;<i> 
</I>&gt;<i> For seemless integration I wanted to use the ANTLR task to:
</I>&gt;<i> 1) Automatically pick up all *.g files in whatever
</I>&gt;<i> src\** directories and generate *.java files and place them 
</I>&gt;<i> in corresponding build\generatedsrc\** directories (this 
</I>&gt;<i> assumes that the *.g files are placed in a sub directory 
</I>&gt;<i> under the main source directory that corresponds to the 
</I>&gt;<i> package the resulting java files will have when put in the 
</I>&gt;<i> generatedsrc build directory. ).
</I>&gt;<i> 
</I>&gt;<i> 2) Generate grammar doocumentation and place it in doc directory.
</I>&gt;<i> 
</I>&gt;<i> 3) Only generate *.java and documentation files if the *.g 
</I>&gt;<i> files have changed (timestamp of *.g files are newer than the 
</I>&gt;<i> generated *.java files).
</I>&gt;<i> 
</I>&gt;<i> Unfortunately, unlike the javac task the antlr ant task has 
</I>&gt;<i> key limitations:
</I>&gt;<i> a) Does not allow for multiple *.g files.
</I>&gt;<i> b) Does not provide direct support for mapping source to 
</I>&gt;<i> destination paths.
</I>&gt;<i> c) Does not check timestamps.
</I>&gt;<i> d) Needs to be invoked twice to generate both *.java files 
</I>&gt;<i> and documentation.
</I>&gt;<i> 
</I>&gt;<i> Despite the above limitation, I tried to use various ANT 
</I>&gt;<i> extensions and complicated techniques to accomplish my goals. 
</I>&gt;<i> See code below. The code is VERY complex but it does conform 
</I>&gt;<i> to goals 1 and 2. However, I could not get the timestamps to 
</I>&gt;<i> work. Consequently, every time I build, the ANT ANTLR task 
</I>&gt;<i> generate new java code, resulting in a long cascade of 
</I>&gt;<i> subsequent build actions that are uncessary when nothing has changed.
</I>&gt;<i> 
</I>&gt;<i> It would be really nice if the next version of Antlr would 
</I>&gt;<i> provide a better ANT task that would allow for integration 
</I>&gt;<i> into a seemless build enviroment.
</I>&gt;<i> Meanwhile, I would welcome if anyone have ideas for improving 
</I>&gt;<i> the ANT workarounds I have detailed below:
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> Morten Christensen
</I>&gt;<i> 
</I>&gt;<i> ----
</I>&gt;<i> 
</I>&gt;<i> &lt;target name=&quot;generateparsers&quot; depends=&quot;init&quot;&gt;
</I>&gt;<i> 	 &lt;echo message=&quot;Generating source code parser(s) for 
</I>&gt;<i> ${ant.project.name}&quot;/&gt;
</I>&gt;<i> 
</I>&gt;<i> 	&lt;!-- Need to generate parsers for ALL *.g files from whatever 
</I>&gt;<i> 	     location. Unfortunately, the ANTLR task does not allow
</I>&gt;<i> 	     for multiple *.g files so we need to iterate though
</I>&gt;<i> 	     all *.g files --&gt;
</I>&gt;<i> 	&lt;foreach target=&quot;generateparsers-antlr-subtask&quot;
</I>&gt;<i> param=&quot;antlrGrammarFile&quot;&gt;
</I>&gt;<i> 		&lt;path&gt;
</I>&gt;<i> 			&lt;fileset dir=&quot;${mainsrc}&quot;&gt;
</I>&gt;<i> 				&lt;include name=&quot;**/*.g&quot;/&gt;	
</I>&gt;<i> 			&lt;/fileset&gt;		
</I>&gt;<i> 		&lt;/path&gt;
</I>&gt;<i> 	&lt;/foreach&gt;
</I>&gt;<i> &lt;/target&gt;
</I>&gt;<i> 	
</I>&gt;<i> &lt;target name=&quot;generateparsers-antlr-subtask&quot;
</I>&gt;<i> if=&quot;antlrGrammarFile&quot; description=&quot;internal helper target&quot;&gt;
</I>&gt;<i> 		
</I>&gt;<i> 	&lt;!-- Need to calculate location in generatedmainsrc 
</I>&gt;<i> that correspond to
</I>&gt;<i> 	     location in src. I.e. outputDir =
</I>&gt;<i> ${antlrGrammarFile} 
</I>&gt;<i> 	     with substring ${srcmain] replaced with 
</I>&gt;<i> ${generatedmainsrc}.
</I>&gt;<i> 	     Tricky using ANT - wish it could be easier.
</I>&gt;<i> 	--&gt; 
</I>&gt;<i> 
</I>&gt;<i> 	&lt;dirname property=&quot;inputDir&quot;
</I>&gt;<i> file=&quot;${antlrGrammarFile}&quot;/&gt;
</I>&gt;<i> 	&lt;path id=&quot;mainSrcDirPath&quot;
</I>&gt;<i> location=&quot;${basedir}${file.separator}${mainsrc}&quot;/&gt;
</I>&gt;<i> 	 &lt;pathconvert dirSep=&quot;${file.separator}&quot;
</I>&gt;<i> pathsep=&quot;${file.separator}&quot;
</I>&gt;<i> property=&quot;normalizedMainSrcDir&quot;
</I>&gt;<i> refid=&quot;mainSrcDirPath&quot;/&gt;
</I>&gt;<i> 	&lt;path id=&quot;inputDirPath&quot; location=&quot;${inputDir}&quot;/&gt;
</I>&gt;<i> 	 &lt;pathconvert dirSep=&quot;${file.separator}&quot;
</I>&gt;<i> pathsep=&quot;${file.separator}&quot;
</I>&gt;<i> property=&quot;normalizedOutputDir&quot; refid=&quot;inputDirPath&quot;/&gt;
</I>&gt;<i> 	&lt;path id=&quot;normalizedOutputDirPath&quot;
</I>&gt;<i> location=&quot;${normalizedOutputDir}&quot;/&gt;
</I>&gt;<i> 	 &lt;pathconvert dirSep=&quot;${file.separator}&quot;
</I>&gt;<i> pathsep=&quot;${file.separator}&quot; property=&quot;outputDir&quot;
</I>&gt;<i> refid=&quot;normalizedOutputDirPath&quot;&gt;
</I>&gt;<i> 	    &lt;map from=&quot;${normalizedMainSrcDir}&quot;
</I>&gt;<i> to=&quot;${basedir}${file.separator}${generatedmainsrc}&quot;/&gt;
</I>&gt;<i> 	 &lt;/pathconvert&gt;
</I>&gt;<i> 		
</I>&gt;<i> 	&lt;!--
</I>&gt;<i> 	Would like to only run antlr task on *.g files that
</I>&gt;<i> 	are newer than the generated java files.
</I>&gt;<i> Unfortunately,
</I>&gt;<i> 	I can't make the code update property initialize
</I>&gt;<i> 	itself correctly.
</I>&gt;<i> 		
</I>&gt;<i>             &lt;uptodate
</I>&gt;<i> property=&quot;checkAntlrGrammarFileChanged&quot;&gt;
</I>&gt;<i> 	      &lt;srcfiles dir= &quot;/&quot;
</I>&gt;<i> includes=&quot;${antlrGrammarFile}&quot;/&gt;
</I>&gt;<i> 	      &lt;mapper type=&quot;merge&quot; to=&quot;${outputDir}&quot;/&gt;
</I>&gt;<i> 	&lt;/uptodate&gt;
</I>&gt;<i> 		
</I>&gt;<i> 	&lt;echo message=&quot;Uptodate? :
</I>&gt;<i> ${checkAntlrGrammarFileChanged}&quot;/&gt;
</I>&gt;<i> 	--&gt;
</I>&gt;<i> 		
</I>&gt;<i> 	&lt;!-- Create output dir on the fly and invoke antlr 
</I>&gt;<i> (need to invoke antlr twice. Once for code, once for docs). --&gt;
</I>&gt;<i> 	&lt;echo message=&quot;Invoking antlr on grammar 
</I>&gt;<i> ${antlrGrammarFile} with code output to directory 
</I>&gt;<i> ${outputDir} and documentation output to ${referencedocs}&quot;/&gt;
</I>&gt;<i> 	&lt;mkdir dir=&quot;${outputDir}&quot; /&gt;
</I>&gt;<i> 	&lt;antlr dir=&quot;.&quot;
</I>&gt;<i> 	    target=&quot;${antlrGrammarFile}&quot;
</I>&gt;<i> 	    outputdirectory=&quot;${outputDir}&quot;/&gt;
</I>&gt;<i> 	&lt;antlr dir=&quot;.&quot; html=&quot;true&quot;
</I>&gt;<i> 	    target=&quot;${antlrGrammarFile}&quot;
</I>&gt;<i> 	    outputdirectory=&quot;${referencedocs}&quot;/&gt;
</I>&gt;<i> &lt;/target&gt;
</I>&gt;<i> 	
</I>&gt;<i> 
</I>



</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011870.html">[antlr-interest] Antlr ANT task: Seemless builds using the Antlr -
	Problems and solutions. Help appreciated!
</A></li>
	<LI>Next message: <A HREF="011872.html">[antlr-interest] Antlr ANT task: Seemless builds using the Antlr
	-Problems and solutions. Help appreciated!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11871">[ date ]</a>
              <a href="thread.html#11871">[ thread ]</a>
              <a href="subject.html#11871">[ subject ]</a>
              <a href="author.html#11871">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://www.antlr.org/mailman/listinfo/antlr-interest">More information about the antlr-interest
mailing list</a><br>
</body></html>
