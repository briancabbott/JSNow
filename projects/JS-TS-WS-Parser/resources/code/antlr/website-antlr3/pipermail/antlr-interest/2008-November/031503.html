<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [antlr-interest] Antlr C code memory leak in Antlr 3.1.1
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20Antlr%20C%20code%20memory%20leak%20in%20Antlr%203.1.1&In-Reply-To=%3CBAY118-W2227BB17C2C5FD974BD266E2140%40phx.gbl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031502.html">
   <LINK REL="Next"  HREF="031460.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[antlr-interest] Antlr C code memory leak in Antlr 3.1.1</H1>
    <B>merry_winfly at hotmail.com</B> 
    <A HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20Antlr%20C%20code%20memory%20leak%20in%20Antlr%203.1.1&In-Reply-To=%3CBAY118-W2227BB17C2C5FD974BD266E2140%40phx.gbl%3E"
       TITLE="[antlr-interest] Antlr C code memory leak in Antlr 3.1.1">merry_winfly at hotmail.com
       </A><BR>
    <I>Tue Nov 11 18:21:36 PST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="031502.html">[antlr-interest] Antlr C code memory leak in Antlr 3.1.1
</A></li>
        <LI>Next message: <A HREF="031460.html">[antlr-interest] gUnit error with NewLine
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31503">[ date ]</a>
              <a href="thread.html#31503">[ thread ]</a>
              <a href="subject.html#31503">[ subject ]</a>
              <a href="author.html#31503">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Use the attachment to see the source code for the display issue (I can't send the all code for large size, any more information pls tell me directly). Thanks Winfly Lin&gt; &gt; &gt; From: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">merry_winfly at hotmail.com</A>&gt; &gt; To: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">jimi at temporal-wave.com</A>&gt; &gt; Date: Wed, 12 Nov 2008 02:10:08 +0000&gt; &gt; CC: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">antlr-interest at antlr.org</A>&gt; &gt; Subject: Re: [antlr-interest] Antlr C code memory leak in Antlr 3.1.1&gt; &gt; &gt; &gt; &gt; &gt; Hi Jim&gt; &gt; &gt; &gt; =&gt;&gt; &gt; pANTLR3_INPUT_STREAM lInput=NULL;&gt; &gt; pANTLR3_COMMON_TOKEN_STREAM lPredigestTokenStream=NULL;&gt; &gt; pPLSQLpredigestParser lPredigestParser=NULL;&gt; &gt; pPLSQLpredigestLexer lPredigestLexer=NULL;&gt; &gt; lInput = antlr3NewAsciiStringInPlaceStream((pANTLR3_UINT8)SQL.c_str(), (ANTLR3_UINT64)SQL.size(), NULL);&gt; &gt; if(!lInput)&gt; &gt; {&gt; &gt; cout&lt;&lt;&quot; input error&quot; &gt; &gt; lPredigestLexer = PLSQLpredigestLexerNew(lInput);&gt; &gt; if(!lPredigestLexer)&gt; &gt; {&gt; &gt; cout&lt;&lt;&quot; lPredigestLexer error&quot; &gt; &gt; lPredigestParser-&gt;free(lPredigestParser);&gt; &gt; lPredigestTokenStream-&gt;free(lPredigestTokenStream);&gt; &gt; lPredigestLexer-&gt;free(lPredigestLexer);&gt; &gt; lInput-&gt;close(lInput);&gt; &gt; lPredigestParser=NULL;&gt; &gt; lPredigestTokenStream=NULL;&gt; &gt; lPredigestLexer=NULL;&gt; &gt; lInput=NULL;&gt; &gt; &gt; &gt; =&gt;This is my all source code, and memory leak exist in PLSQLpredigestParser_start_rule_return psr = lPredigestParser-&gt;start_rule(lPredigestParser);&gt; &gt; &gt; &gt; &gt; &gt; Actually, I have two type PLSQL's lexer and parser code from two type PLSQL g file. &gt; &gt; &gt; &gt; But only this file (PLSQLPredigest.g,I send to you before)exist memory leak (the source PLSQL.g is from website, and no memory leak issue,PLSQLpredigest is predigested from PLSQL.g) , and I seems to follow the &quot;treeparser&quot; sample to code (because I don't have any walker to new a node &quot;antlr3CommonTreeNodeStreamNewTree&quot;). &gt; &gt; &gt; &gt; Thank Jim.&gt; &gt; &gt; &gt; Best Regards&gt; &gt; Winfly Lin&gt; &gt; &gt; &gt;&gt; Subject: Re: [antlr-interest] Antlr C code memory leak in Antlr 3.1.1&gt; &gt;&gt; From: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">jimi at temporal-wave.com</A>&gt; &gt;&gt; To: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">merry_winfly at hotmail.com</A>&gt; &gt;&gt; CC: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">antlr-interest at antlr.org</A>&gt; &gt;&gt; Date: Tue, 11 Nov 2008 08:52:30 -0800&gt; &gt;&gt; &gt; &gt;&gt; On Tue, 2008-11-11 at 13:39 +0000, <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">merry_winfly at hotmail.com</A> wrote:&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; ==&gt;&gt; &gt;&gt;&gt; Actully, I find when (lPredigestParser-&gt;free(lPredigestParser);) the adapter and vector will be freed by this free action, but at last some tokenstream didn't be freed, I don't know if my source code issue or antlr's bug.&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; And any one know this, pls freely tell me the reason.&gt; &gt;&gt; &gt; &gt;&gt; Did you call free on the token stream itself? I think that this is your&gt; &gt;&gt; issue. There is a treenode stream that you must free too. Check against&gt; &gt;&gt; that example tree parsers, but I will look at your issue today.&gt; &gt;&gt; &gt; &gt;&gt; Jim&gt; &gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; Thanks a lot.&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; Best Regards&gt; &gt;&gt;&gt; Winfly Lin&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; From: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">merry_winfly at hotmail.com</A>&gt; &gt;&gt;&gt; To: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">antlr-interest at antlr.org</A>&gt; &gt;&gt;&gt; Date: Mon, 10 Nov 2008 13:21:04 +0000&gt; &gt;&gt;&gt; Subject: [antlr-interest] Antlr C code memory leak in Antlr 3.1.1&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; Hi All,&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; When I use the C code from antlr generator with predigest PLSQL parser , I find it exist obvious memory leak issue.&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; I use valgrind to check and the result is:&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; valgrind --leak-check=full ./treeMemory&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; ==9541== Memcheck, a memory error detector.&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; ==9541== Copyright (C) 2002-2007, and GNU GPL'd, by Julian Seward et al.&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; ==9541== Using LibVEX rev 1854, a library for dynamic binary translation.&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; ==9541== Copyright (C) 2004-2007, and GNU GPL'd, by OpenWorks LLP.&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; ==9541== Using valgrind-3.3.1, a dynamic binary instrumentation framework.&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; ==9541== Copyright (C) 2000-2007, and GNU GPL'd, by Julian Seward et al.&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; ==9541== For more details, rerun with: -v&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; ==9541==&gt; &gt;&gt;&gt; ==9541==&gt; &gt;&gt;&gt; ==9541== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 17 from 1)&gt; &gt;&gt;&gt; ==9541== malloc/free: in use at exit: 8,008 bytes in 98 blocks.&gt; &gt;&gt;&gt; ==9541== malloc/free: 8,847 allocs, 8,749 frees, 2,202,767 bytes allocated.&gt; &gt;&gt;&gt; ==954 1== For counts of detected errors, rerun with: -v&gt; &gt;&gt;&gt; ==9541== searching for pointers to 98 not-freed blocks.&gt; &gt;&gt;&gt; ==9541== checked 149,260 bytes.&gt; &gt;&gt;&gt; ==9541==&gt; &gt;&gt;&gt; ==9541== 8,008 (7,560 direct, 448 indirect) bytes in 90 blocks are definitely lost in loss record 3 of 3&gt; &gt;&gt;&gt; ==9541== at 0x40057C8: malloc (vg_replace_malloc.c:207)&gt; &gt;&gt;&gt; ==9541== by 0x8055BFA: antlr3RewriteRuleElementStreamNewAE (antlr3rewritestreams.c:94)&gt; &gt;&gt;&gt; ==9541== by 0x8055DA0: antlr3RewriteRuleTOKENStreamNewAE (antlr3rewritestreams.c:192)&gt; &gt;&gt;&gt; ==9541== by 0x80B8125: select_list (PLSQLpredigestParser.c:51593)&gt; &gt;&gt;&gt; ==9541== by 0x80B4E0F: select_expression (PLSQLpredigestParser.c:50283)&gt; &gt;&gt;&gt; ==9541== by 0x80B3F4D: select_statement (PLSQLpredigestParser.c:49890)&gt; &gt;&gt;&gt; ==9541== by 0x810C0F5: insert_command (PLSQLpredigestParser.c:83912)&gt; &gt;&gt;&gt; ==9541== by 0x80B1E12: sql_command (PLSQLpredigest Parser.c:49133)&gt; &gt;&gt;&gt; ==9541== by 0x80B13BE: sql_statement (PLSQLpredigestParser.c:48855)&gt; &gt;&gt;&gt; ==9541== by 0x8083185: statement (PLSQLpredigestParser.c:31331)&gt; &gt;&gt;&gt; ==9541== by 0x808110E: seq_of_statements (PLSQLpredigestParser.c:30542)&gt; &gt;&gt;&gt; ==9541== by 0x8077D5C: start_rule (PLSQLpredigestParser.c:26944)&gt; &gt;&gt;&gt; ==9541==&gt; &gt;&gt;&gt; ==9541== LEAK SUMMARY:&gt; &gt;&gt;&gt; ==9541== definitely lost: 7,560 bytes in 90 blocks.&gt; &gt;&gt;&gt; ==9541== indirectly lost: 448 bytes in 8 blocks.&gt; &gt;&gt;&gt; ==9541== possibly lost: 0 bytes in 0 blocks.&gt; &gt;&gt;&gt; ==9541== still reachable: 0 bytes in 0 blocks.&gt; &gt;&gt;&gt; ==9541== suppressed: 0 bytes in 0 blocks.&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; Source Code:&gt; &gt;&gt;&gt; ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&gt; &gt;&gt;&gt; string SQL=&quot;insert into T K(a1,a2,a3) select a,b,c from t2 where a&gt;9 union all select e,f,g from t5 where e&gt;'winfly' ;&quot;;&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; pANTLR3_INPUT_STREAM lInput=NULL;&gt; &gt;&gt;&gt; pANTLR3_COMMON_TOKEN_STREAM lPredigestTokenStream=NULL;&gt; &gt;&gt;&gt; pPLSQLpredigestParser lPredigestParser=NULL;&gt; &gt;&gt;&gt; pPLSQLpredigestLexer lPredigestLexer=NULL;&gt; &gt;&gt;&gt; lInput = antlr3NewAsciiStringInPlaceStream((pANTLR3_UINT8)SQL.c_str(), (ANTLR3_UINT64)SQL.size(), NULL);&gt; &gt;&gt;&gt; if(!lInput)&gt; &gt;&gt;&gt; {&gt; &gt;&gt;&gt; cout&lt;&lt;&quot; input error&quot;&gt; &gt; &gt;&gt;&gt; lPredigestLexer = PLSQLpredigestLexerNew(lInput);&gt; &gt;&gt;&gt; if(!lPredigestLexer)&gt; &gt;&gt;&gt; {&gt; &gt;&gt;&gt; cout&lt;&lt;&quot; lPredigestLexer error&quot;&gt; &gt; &gt;&gt;&gt; lPredigestParser-&gt;free(lPredigestParser);&gt; &gt;&gt;&gt; lPredigestTokenStream-&gt;free(lPredigestTokenStream);&gt; &gt;&gt;&gt; lPredigestLexer-&gt;free(lPredigestLexer);&gt; &gt;&gt;&gt; lInput-&gt;close(lInput);&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~`&gt; &gt;&gt;&gt; Actually the memory leak exist PLSQLpredigestParser_start_rule_return psr = lPredigestParser-&gt;start_rule(lPredigestParser);&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; I don't know why so simple code cause so obvious memory leak&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; Could you help me to solve this? (I'm hurry for this code, thanks a lot!)&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; I list the information and attachment includes all code about it (C file ):&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; Platform: RedHat Enterprise 5 Server, virtual machine.&gt; &gt;&gt;&gt; GCC version: 4.1.1&gt; &gt;&gt;&gt; Antlr Version: 3.1.1&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; I don't know if it is enough information to trace this problem, but if you want to know any more information, pls freely contact me with this E-mail (<A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">merry_winfly at hotmail.com</A>).&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; Thanks a lot.&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; Best Regards&gt; &gt;&gt;&gt; Winfly Lin&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; Get news, entertainment and everything you care about at Live.com. Check it out!&gt; &gt;&gt;&gt; _________________________________________________________________&gt; &gt;&gt;&gt; Connect to the next generation of MSN Messenger &gt; &gt;&gt;&gt; <A HREF="http://imagine-msn.com/messenger/launch80/default.aspx?locale=en-us&amp;source=wlmailtagline">http://imagine-msn.com/messenger/launch80/default.aspx?locale=en-us&amp;source=wlmailtagline</A>&gt; &gt;&gt;&gt; &gt; &gt;&gt;&gt; List: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">http://www.antlr.org/mailman/listinfo/antlr-interest</A>&gt; &gt;&gt;&gt; Unsubscribe: <A HREF="http://www.antlr.org/mailman/options/antlr-interest/your-email-address">http://www.antlr.org/mailman/options/antlr-interest/your-email-address</A>&gt; &gt;&gt;&gt; &gt; &gt;&gt; &gt; &gt; _________________________________________________________________&gt; &gt; Connect to the next generation of MSN Messenger &gt; &gt; <A HREF="http://imagine-msn.com/messenger/launch80/default.aspx?locale=en-us&amp;source=wlmailtagline">http://imagine-msn.com/messenger/launch80/default.aspx?locale=en-us&amp;source=wlmailtagline</A>&gt; &gt; &gt; &gt; List: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">http://www.antlr.org/mailman/listinfo/antlr-interest</A>&gt; &gt; Unsubscribe: <A HREF="http://www.antlr.org/mailman/options/antlr-interest/your-email-address">http://www.antlr.org/mailman/options/antlr-interest/your-email-address</A>&gt; &gt; &gt; _________________________________________________________________&gt; Discover the new Windows Vista&gt; <A HREF="http://search.msn.com/results.aspx?q=windows+vista&amp;mkt=en-US&amp;form=QBRE">http://search.msn.com/results.aspx?q=windows+vista&amp;mkt=en-US&amp;form=QBRE</A>
_________________________________________________________________
Invite your mail contacts to join your friends list with Windows Live Spaces. It's easy!
<A HREF="http://spaces.live.com/spacesapi.aspx?wx_action=create&amp;wx_url=/friends.aspx&amp;mkt=en-us">http://spaces.live.com/spacesapi.aspx?wx_action=create&amp;wx_url=/friends.aspx&amp;mkt=en-us</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://www.antlr.org/pipermail/antlr-interest/attachments/20081112/b15de281/attachment.html">http://www.antlr.org/pipermail/antlr-interest/attachments/20081112/b15de281/attachment.html</A> 
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: test.cpp
Url: <A HREF="http://www.antlr.org/pipermail/antlr-interest/attachments/20081112/b15de281/attachment.pl">http://www.antlr.org/pipermail/antlr-interest/attachments/20081112/b15de281/attachment.pl</A> 
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031502.html">[antlr-interest] Antlr C code memory leak in Antlr 3.1.1
</A></li>
	<LI>Next message: <A HREF="031460.html">[antlr-interest] gUnit error with NewLine
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31503">[ date ]</a>
              <a href="thread.html#31503">[ thread ]</a>
              <a href="subject.html#31503">[ subject ]</a>
              <a href="author.html#31503">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://www.antlr.org/mailman/listinfo/antlr-interest">More information about the antlr-interest
mailing list</a><br>
</body></html>
