<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [antlr-interest] Fragment and error tokens are not generated by emit() -- breaks setting TokenLabelType
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20Fragment%20and%20error%20tokens%20are%20not%20generated%20by%0A%20emit%28%29%20--%20breaks%20setting%20TokenLabelType&In-Reply-To=%3C4A565048.5090800%40jacaranda.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035134.html">
   <LINK REL="Next"  HREF="035146.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[antlr-interest] Fragment and error tokens are not generated by emit() -- breaks setting TokenLabelType</H1>
    <B>David-Sarah Hopwood</B> 
    <A HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20Fragment%20and%20error%20tokens%20are%20not%20generated%20by%0A%20emit%28%29%20--%20breaks%20setting%20TokenLabelType&In-Reply-To=%3C4A565048.5090800%40jacaranda.org%3E"
       TITLE="[antlr-interest] Fragment and error tokens are not generated by emit() -- breaks setting TokenLabelType">david-sarah at jacaranda.org
       </A><BR>
    <I>Thu Jul  9 13:17:12 PDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="035134.html">[antlr-interest] Fragment tokens are not generated by emit() --	breaks setting TokenLabelType
</A></li>
        <LI>Next message: <A HREF="035146.html">[antlr-interest] Fragment and error tokens are not generated by emit() -- breaks setting TokenLabelType
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35143">[ date ]</a>
              <a href="thread.html#35143">[ thread ]</a>
              <a href="subject.html#35143">[ subject ]</a>
              <a href="author.html#35143">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Jim Idle wrote:
&gt;<i> David-Sarah Hopwood wrote:
</I>&gt;&gt;<i> In order to change the token type (so that I can associate another
</I>&gt;&gt;<i> field with each token), I have overridden emit() in my lexer as shown
</I>&gt;&gt;<i> below:
</I>[snipped]
&gt;&gt;<i> The problem is that the generated code has compilation errors because
</I>&gt;&gt;<i> not all creation of token objects goes through emit(); there are some
</I>&gt;&gt;<i> direct uses of 'new CommonToken(...)':
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> org\jacaranda\verifier\JacarandaLexer.java:4006: incompatible types
</I>&gt;&gt;<i> found   : org.antlr.runtime.CommonToken
</I>&gt;&gt;<i> required: org.jacaranda.verifier.JacarandaToken
</I>&gt;&gt;<i>   d = new CommonToken(input, Token.INVALID_TOKEN_TYPE,
</I>&gt;&gt;<i>           Token.DEFAULT_CHANNEL, dStart1982, getCharIndex()-1);
</I>&gt;&gt;<i>       ^
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The errors seem to occur in lexer rules where a child rule that is
</I>&gt;&gt;<i> a fragment is given a name (whether or not that name is used in an
</I>&gt;&gt;<i> action), for example: [snipped]
</I>&gt;<i>
</I>&gt;<i> Yes, I think you are correct.
</I>&gt;<i> 
</I>&gt;<i> The solution is either that return types of fragments in lexerRuleRef() 
</I>&gt;<i> template, should be known to be CommonToken or that the hard coded new 
</I>&gt;<i> CommonToken should use the template's labelType.
</I>
The latter assumes that the labelType has a constructor with
signature (CharStream input, int type, int channel, int start, int stop),
and makes it inconvenient for token creation to make use of any other
lexer state (since the lexer object is not passed into the token
constructor).

&gt;<i> Probably the latter, 
</I>&gt;<i> but fragment labels are really for using the token to determine the 
</I>&gt;<i> start and end of fragments spans and so on, rather than emit()'ing them, 
</I>&gt;<i> so perhaps not.
</I>&gt;<i> 
</I>&gt;<i> However, if you separate the lexer and parser, and use TokenLabelType 
</I>&gt;<i> only in the parser grammar, then I think it would work as you require, 
</I>&gt;<i> even with labeled fragment rules.
</I>
Unfortunately not. I've since found other cases in which a CommonToken
gets placed on the token stream (e.g. due to a parse error), and then
the generated code for the parser (not lexer) fails at runtime when it
attempts to cast it to a JacarandaToken. This is much harder to work
around, because of the cast being in generated parser code. For the time
being, I've stopped using the TokenLabelType option and decided to live
with the tokens being a mixture of JacarandaToken and CommonToken, but
that's not an ideal solution.


// parser rule
unreservedIdentifier
  : id=Identifier^ { ... }
  ;


// generated parser code
JacarandaToken id=null;
...
// line 2003:
id=(JacarandaToken)match(input,Identifier,FOLLOW_Identifier_in_unreservedIdentifier3071);


// when used to parse input where Identifier is missing:
line 1:0 [unreservedIdentifier] missing Identifier at [@0,0:4='throw',&lt;27&gt;,1:0]
java.lang.ClassCastException: org.antlr.runtime.CommonToken cannot be cast
to org.jacaranda.verifier.JacarandaToken
        at
org.jacaranda.verifier.JacarandaParser.unreservedIdentifier(JacarandaParser.java:2003)


So, it seems like the only workable fix that would maintain compatibility
with the emit() recipe given in
&lt;<A HREF="http://www.antlr.org/wiki/pages/viewpage.action?pageId=1844">http://www.antlr.org/wiki/pages/viewpage.action?pageId=1844</A>&gt;, is to
eliminate all instances of 'new CommonToken(...)' from generated code,
and have all token objects created via emit(). Or else the recipe
could be changed to create all tokens via a factory method:

lexer::@members {
  public Token createToken(CharStream input, int type, int channel,
                           int start, int stop) {
    return new MyToken(input, type, channel, start, stop);
  }
}

(with the default emit() using this method, of course).

-- 
David-Sarah Hopwood  &#9893;  <A HREF="http://davidsarah.livejournal.com">http://davidsarah.livejournal.com</A>

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035134.html">[antlr-interest] Fragment tokens are not generated by emit() --	breaks setting TokenLabelType
</A></li>
	<LI>Next message: <A HREF="035146.html">[antlr-interest] Fragment and error tokens are not generated by emit() -- breaks setting TokenLabelType
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35143">[ date ]</a>
              <a href="thread.html#35143">[ thread ]</a>
              <a href="subject.html#35143">[ subject ]</a>
              <a href="author.html#35143">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://www.antlr.org/mailman/listinfo/antlr-interest">More information about the antlr-interest
mailing list</a><br>
</body></html>
