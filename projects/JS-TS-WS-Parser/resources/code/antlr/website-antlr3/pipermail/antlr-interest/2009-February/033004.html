<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [antlr-interest] SUGGESTION: Make unit testing available for	Composite Grammars
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20SUGGESTION%3A%20Make%20unit%20testing%20available%20for%0A%09Composite%20Grammars&In-Reply-To=%3CD3439AAC-112A-4A15-86CC-0E63E747AF13%40cs.usfca.edu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032999.html">
   <LINK REL="Next"  HREF="033001.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[antlr-interest] SUGGESTION: Make unit testing available for	Composite Grammars</H1>
    <B>Terence Parr</B> 
    <A HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20SUGGESTION%3A%20Make%20unit%20testing%20available%20for%0A%09Composite%20Grammars&In-Reply-To=%3CD3439AAC-112A-4A15-86CC-0E63E747AF13%40cs.usfca.edu%3E"
       TITLE="[antlr-interest] SUGGESTION: Make unit testing available for	Composite Grammars">parrt at cs.usfca.edu
       </A><BR>
    <I>Thu Feb 19 17:44:07 PST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="032999.html">[antlr-interest] SUGGESTION: Make unit testing available for	Composite Grammars
</A></li>
        <LI>Next message: <A HREF="033001.html">[antlr-interest] Parsing a command line?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33004">[ date ]</a>
              <a href="thread.html#33004">[ thread ]</a>
              <a href="subject.html#33004">[ subject ]</a>
              <a href="author.html#33004">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Feb 19, 2009, at 1:11 PM, George S. Cowan wrote:

&gt;<i> ANTLR's new Composite Grammar facility presents some difficulties  
</I>&gt;<i> when trying to use good unit testing practices, and I hope that  
</I>&gt;<i> these difficulties can be addressed in an upcoming release. The  
</I>&gt;<i> problems apply to both gUnit and JUnit.
</I>&gt;<i>
</I>&gt;<i> In both of the cases that follow, the general problem is that a test  
</I>&gt;<i> must include code that references the level at which a rule is  
</I>&gt;<i> defined - thus a test will break when a fix is implemented by  
</I>&gt;<i> overriding the rule at a new level. A test will also break when a  
</I>&gt;<i> change is made to a rule by overriding it at a new level, even if  
</I>&gt;<i> the change does not affect that particular test.
</I>&gt;<i>
</I>&gt;<i> No matter how hard it may be to change ANTLR and its templates, at  
</I>&gt;<i> least the fix for the problems is simple to state: &quot;ANTLR must  
</I>&gt;<i> delegate all rule access from the top level in a way that external  
</I>&gt;<i> callers are not required to know about which level the rule is  
</I>&gt;<i> delegated to.&quot;
</I>
That was my intent anyway ;)  Top level is only reliable object to  
test I think.

&gt;<i> First, an easy problem. The lexers generated by ANTLR 3.1.1 do not  
</I>&gt;<i> delegate their rules from the top level at all.
</I>
  i think we have  number of errorsRelated to this; for example

<A HREF="http://www.antlr.org/jira/browse/ANTLR-353">http://www.antlr.org/jira/browse/ANTLR-353</A>
<A HREF="http://www.antlr.org/jira/browse/ANTLR-386">http://www.antlr.org/jira/browse/ANTLR-386</A>

&gt;<i> For a workaround, see <A HREF="http://www.antlr.org/pipermail/antlr-interest/2009-January/032201.html">http://www.antlr.org/pipermail/antlr-interest/2009-January/032201.html</A>
</I>&gt;<i> My impression is that this Lexer problem can be easily solved by  
</I>&gt;<i> having ANTLR add the delegating rules to the main lexer, but my  
</I>&gt;<i> experience is only with very straightforward lexers.
</I>
Well, the issue I see is that I don't think I intended people to call  
individual lexer rules, even from the root grammar. I expect all  
lexical stuff to go through the implicit Tokens rule invoke from  
nextToken

&gt;<i> THE BIGGER PROBLEM
</I>&gt;<i>
</I>&gt;<i> AST results generated from a rule have a return type that depends  
</I>&gt;<i> upon the subgrammar in which the rule is defined. Here is an example  
</I>&gt;<i> of a delegation from the a top level grammar C that might be  
</I>&gt;<i> generated in its parser CParser.java:
</I>&gt;<i>
</I>&gt;<i>   public C_P2_P1.spaces_return spaces() throws RecognitionException {
</I>&gt;<i>     return gP1.spaces();
</I>&gt;<i>   }
</I>&gt;<i>
</I>&gt;<i> (For those not already familiar with this code: The spaces()  
</I>&gt;<i> function returns a value of type &quot;C_P2_P1.spaces_return&quot;, which is a  
</I>&gt;<i> a subclass defined in the class &quot;C_P2_P1&quot;  generated by ANTLR for  
</I>&gt;<i> the grammar P1 which is imported by P2 which is imported by the top  
</I>&gt;<i> level grammar, C. This &quot;spaces_return&quot; subclass contains, among  
</I>&gt;<i> other things, the tree that must be accessed by a test of the rule  
</I>&gt;<i> for &quot;spaces&quot;.)
</I>&gt;<i>
</I>&gt;<i> Therefore, the testing program must know that the rule is delegated  
</I>&gt;<i> to the P1 subgrammar in order to know  the return type of the rule.  
</I>&gt;<i> If the spaces rule is overridden in the C grammar, the return value  
</I>&gt;<i> will become &quot;CParser.spaces_return&quot; and any tests that assume  
</I>&gt;<i> &quot;C_P2_P1.spaces_return&quot; will be broken, even if the issue they are  
</I>&gt;<i> testing still works.
</I>
Can we use the generic ParserRuleReturnScope object?  Hmm...that off  
work because we might have special elements in there that we need to  
access. crap.

Again, this might be a problem because we are trying to access these  
objects directly.

&gt;<i> Note that the problem applies not just with tests of AST trees but  
</I>&gt;<i> with tests of any value returned from a rule, which includes string  
</I>&gt;<i> template results.
</I>
yup. :(

&gt;<i> SUGGESTED SOLUTIONS
</I>&gt;<i>
</I>&gt;<i> One possible solution is to define all the rule_return subclasses in  
</I>&gt;<i> the generated parser for the top level, no matter what level the  
</I>&gt;<i> rule is from, e.g., &quot;CParser.spaces_return&quot;. Since all the generated  
</I>&gt;<i> subgrammar parsers know about the top level parser, this should not  
</I>&gt;<i> cause any problems.
</I>&gt;<i>
</I>&gt;<i> An alternative is for every rule to return a Map or an array of  
</I>&gt;<i> maplets. For ordinary programming, I don't like this as much because  
</I>&gt;<i> its generality introduces too many opportunities for errors. In  
</I>&gt;<i> generated code, it's more controlled and simplifies ANTLR's  
</I>&gt;<i> situation where there must be many different kinds of return  
</I>&gt;<i> collections. It also gets rid of all those subclass files in the  
</I>&gt;<i> class directory, like &quot;C_P2_P1$spaces_return.class&quot;. On the negative  
</I>&gt;<i> side, I expect it would use a little more space and time for each  
</I>&gt;<i> return value.
</I>&gt;<i>
</I>&gt;<i> A compromise would be to define a single class that had the usual  
</I>&gt;<i> start, stop, tree, and/or st values along with a map to hold extra  
</I>&gt;<i> return values when needed.
</I>&gt;<i>
</I>&gt;<i> The key issue is to maintain the unit test pattern while allowing  
</I>&gt;<i> all the new patterns that Composite grammars introduce.
</I>
Hmm...would it be possible to test everything you need to test going  
through the root grammar rather than directly to the delegates?

Ter
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032999.html">[antlr-interest] SUGGESTION: Make unit testing available for	Composite Grammars
</A></li>
	<LI>Next message: <A HREF="033001.html">[antlr-interest] Parsing a command line?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33004">[ date ]</a>
              <a href="thread.html#33004">[ thread ]</a>
              <a href="subject.html#33004">[ subject ]</a>
              <a href="author.html#33004">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://www.antlr.org/mailman/listinfo/antlr-interest">More information about the antlr-interest
mailing list</a><br>
</body></html>
