<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [antlr-interest] C target - initialization of return/scope	structures
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20C%20target%20-%20initialization%20of%20return/scope%0A%09structures&In-Reply-To=%3CAANLkTin0d8bPJC9ya_kSa1KtcCF-jMx5GUB81MaU307H%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038737.html">
   <LINK REL="Next"  HREF="038740.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[antlr-interest] C target - initialization of return/scope	structures</H1>
    <B>Cristian T&#226;r&#351;oag&#259;</B> 
    <A HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20C%20target%20-%20initialization%20of%20return/scope%0A%09structures&In-Reply-To=%3CAANLkTin0d8bPJC9ya_kSa1KtcCF-jMx5GUB81MaU307H%40mail.gmail.com%3E"
       TITLE="[antlr-interest] C target - initialization of return/scope	structures">cristian.tarsoaga at gmail.com
       </A><BR>
    <I>Thu May 20 05:48:37 PDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="038737.html">[antlr-interest] C target - initialization of return/scope structures
</A></li>
        <LI>Next message: <A HREF="038740.html">[antlr-interest] C target - initialization of return/scope	structures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38738">[ date ]</a>
              <a href="thread.html#38738">[ thread ]</a>
              <a href="subject.html#38738">[ subject ]</a>
              <a href="author.html#38738">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Mark,

thanks a lot, I think that is what I was looking for!
once I'll be able to install a custom deleter, my problems are solved!
allocation was not a problem even without using 'placement' new, but
deletion was a problem indeed (only when the rule was failing, leaks could
occur)

Honestly, I never thought to put something like this:
ctx-&gt;pMyGrammarParser_GSTop-&gt;free = &amp;free_MyStruct;
in the @init action, I thought that maybe there is a general way to install
the deleter, using a macro...I don't know...

But you're right, this WILL delete my pointers properly, THANKS!!   :-)

    Chris





2010/5/20 Mark Wright &lt;<A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">markwright at internode.on.net</A>&gt;

&gt;<i> On Thu, May 20, 2010 at 10:04:09AM +0300, Cristian T&#226;r&#351;oag&#259; wrote:
</I>&gt;<i> &gt; Hi Jim, that is not my problem, let me show you an example
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I want to have a scoped value which is a structure, and my structure
</I>&gt;<i> holds
</I>&gt;<i> &gt; some std::strings
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; struct MyStruct
</I>&gt;<i> &gt; {
</I>&gt;<i> &gt;   std::string s1;
</I>&gt;<i> &gt;   std::string s2;
</I>&gt;<i> &gt; };
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; //this is part of my grammar
</I>&gt;<i> &gt; myrule
</I>&gt;<i> &gt; scope {MyStruct s;} //scoped VALUE
</I>&gt;<i> &gt; @init{}
</I>&gt;<i> &gt; @after{}
</I>&gt;<i> &gt; : rulegoeshere....;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; As you can see, there is no pointer here, the scoped variable is a
</I>&gt;<i> 'value'.
</I>&gt;<i> &gt; The code generated by antlr creates a scoped wrapper structure that holds
</I>&gt;<i> &gt; MyStruct, something like:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ctx-&gt;pMyParser_myruleTop = pMyParser_myrulePush(ctx); // this will create
</I>&gt;<i> a
</I>&gt;<i> &gt; wrapper for the scoped value by calling ANTLR3_MALLOC
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; the wrapper looks like this:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; typedef struct  MyParser_myrule_SCOPE_struct
</I>&gt;<i> &gt; {
</I>&gt;<i> &gt;     void    (ANTLR3_CDECL *free)    (struct MyParser_myrule_SCOPE_struct
</I>&gt;<i> *
</I>&gt;<i> &gt; frame);
</I>&gt;<i> &gt;     MyStruct s;
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; As you can see my struct is inside this structure. The problem is that to
</I>&gt;<i> &gt; create the wrapper (see pMyParser_myrulePush above)
</I>&gt;<i> &gt; antlr calls ANTLR3_MALLOC (which does malloc of course).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; THIS MEANS I'M GONNA GET A CRASH!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Why? because std::string is a c++ class, which HAS to be
</I>&gt;<i> created/destroyed
</I>&gt;<i> &gt; using new/delete, not malloc/free.
</I>&gt;<i>
</I>&gt;<i> Hi Cristian,
</I>&gt;<i>
</I>&gt;<i> As Jim advised, you need to initialise it in @init().  As the memory has
</I>&gt;<i> already been allocated, the correct way to initialise it is to call the
</I>&gt;<i> constructor with placement operator new.
</I>&gt;<i>
</I>&gt;<i> And it is necessary to register your own free method to call the
</I>&gt;<i> destructor.
</I>&gt;<i>
</I>&gt;<i> grammar MyGrammar;
</I>&gt;<i>
</I>&gt;<i> options {
</I>&gt;<i>        language = C;
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> scope GS {
</I>&gt;<i>  MyStruct s;
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> @parser::includes {
</I>&gt;<i> #include &lt;new&gt;
</I>&gt;<i> #include &quot;MyStruct.h&quot;
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> myrule
</I>&gt;<i> scope GS;
</I>&gt;<i> @init{
</I>&gt;<i>  new(&amp;($GS::s))MyStruct;
</I>&gt;<i>  ctx-&gt;pMyGrammarParser_GSTop-&gt;free = &amp;free_MyStruct;
</I>&gt;<i> }
</I>&gt;<i>        : 'foo'
</I>&gt;<i>        | 'bar'
</I>&gt;<i>        ;
</I>&gt;<i>
</I>&gt;<i> mystruct.h:
</I>&gt;<i> #include &lt;string&gt;
</I>&gt;<i> #include &lt;antlr3.h&gt;
</I>&gt;<i>
</I>&gt;<i> struct MyStruct
</I>&gt;<i> {
</I>&gt;<i>  std::string s1;
</I>&gt;<i>  std::string s2;
</I>&gt;<i> };
</I>&gt;<i>
</I>&gt;<i> extern &quot;C&quot; {
</I>&gt;<i>  void ANTLR3_CDECL free_MyStruct(struct MyGrammarParser_GS_SCOPE_struct
</I>&gt;<i> *scope);
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> mystruct.cpp:
</I>&gt;<i> extern &quot;C&quot; {
</I>&gt;<i> void ANTLR3_CDECL free_MyStruct(struct MyGrammarParser_GS_SCOPE_struct
</I>&gt;<i> *scope)
</I>&gt;<i> {
</I>&gt;<i>  // Call the destructor
</I>&gt;<i>  (&amp;(scope-&gt;s))-&gt;MyStruct::~MyStruct();
</I>&gt;<i> }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> Regards, Mark
</I>&gt;<i>
</I>&gt;<i> &gt; That means, I cannot use a scoped VALUE, I have to use a scoped POINTER
</I>&gt;<i> &gt; instead, as suggested here:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="http://www.mail-archive.com/il-antlr-interest@googlegroups.com/msg02614.html">http://www.mail-archive.com/il-antlr-interest@googlegroups.com/msg02614.html</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Suggested Solution 1: local new/delete allocation/deallocation
</I>&gt;<i> &gt; ------------------------------
</I>&gt;<i> &gt; -----------------------------------------------------------
</I>&gt;<i> &gt; So my rule will now look like this:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; myrule
</I>&gt;<i> &gt; scope {MyStruct* s;} //scoped POINTER
</I>&gt;<i> &gt; @init{ $myrule::s = new MyStruct();} //explicit allocation using new
</I>&gt;<i> &gt; @after{ delete $myrule::s; } //explicit deallocation using delete
</I>&gt;<i> &gt; : rulegoeshere....;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Looks good? Well, I think not!
</I>&gt;<i> &gt; Because when the rule fails, the @after action is NOT called, and I'm
</I>&gt;<i> gonna
</I>&gt;<i> &gt; get a nice memory leak.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Solution 1': the scoped wrapper has a member called free that can hold a
</I>&gt;<i> &gt; 'deleter', but I couldn't find a way to set that.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Suggested Solution2: override antlr macros ANTLR3_MALLOC and ANTLR3_FREE
</I>&gt;<i> &gt;
</I>&gt;<i> ------------------------------------------------------------------------------------------------------------------------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Nice try, but ANTLR3_MALLOC is currently defined like this:
</I>&gt;<i> &gt; #define    ANTLR3_MALLOC(request)                    malloc
</I>&gt;<i> &gt; ((size_t)(request))
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; As you can see, the 'request' argument is a SIZE, not a type, which means
</I>&gt;<i> &gt; that if I want to override it to make it use 'new' instead of malloc, I
</I>&gt;<i> &gt; cannot use it.
</I>&gt;<i> &gt; &gt;From the given size I cannot deduce the type (this could work the other
</I>&gt;<i> way
</I>&gt;<i> &gt; around if you change the define, to pass it the type you could get the
</I>&gt;<i> size,
</I>&gt;<i> &gt; and it could be possible to override the default way of antlr's
</I>&gt;<i> &gt; allocations/deallocations)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; That is my problem and those are the options I have. Maybe with some
</I>&gt;<i> &gt; adjustment some of them will work, but right now, I'm not happy with any
</I>&gt;<i> of
</I>&gt;<i> &gt; them: first one leaks, second one is not usable.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Maybe you have some hints for me :-)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks a lot for your answer
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;    Chris
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; List: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">http://www.antlr.org/mailman/listinfo/antlr-interest</A>
</I>&gt;<i> &gt; Unsubscribe:
</I>&gt;<i> <A HREF="http://www.antlr.org/mailman/options/antlr-interest/your-email-address">http://www.antlr.org/mailman/options/antlr-interest/your-email-address</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I></PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038737.html">[antlr-interest] C target - initialization of return/scope structures
</A></li>
	<LI>Next message: <A HREF="038740.html">[antlr-interest] C target - initialization of return/scope	structures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38738">[ date ]</a>
              <a href="thread.html#38738">[ thread ]</a>
              <a href="subject.html#38738">[ subject ]</a>
              <a href="author.html#38738">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://www.antlr.org/mailman/listinfo/antlr-interest">More information about the antlr-interest
mailing list</a><br>
</body></html>
