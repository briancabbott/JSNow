<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [antlr-interest] 'Dude' error in v3.4 and possible bugs explained [was: on &quot;crap&quot; grammars]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20%27Dude%27%20error%20in%20v3.4%20and%20possible%20bugs%0A%20explained%20%5Bwas%3A%20on%20%22crap%22%20grammars%5D&In-Reply-To=%3C577c3156bfb5513b5d51ab20837203ef%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="042210.html">
   <LINK REL="Next"  HREF="042214.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[antlr-interest] 'Dude' error in v3.4 and possible bugs explained [was: on &quot;crap&quot; grammars]</H1>
    <B>Jim Idle</B> 
    <A HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20%27Dude%27%20error%20in%20v3.4%20and%20possible%20bugs%0A%20explained%20%5Bwas%3A%20on%20%22crap%22%20grammars%5D&In-Reply-To=%3C577c3156bfb5513b5d51ab20837203ef%40mail.gmail.com%3E"
       TITLE="[antlr-interest] 'Dude' error in v3.4 and possible bugs explained [was: on &quot;crap&quot; grammars]">jimi at temporal-wave.com
       </A><BR>
    <I>Thu Jul 21 12:37:39 PDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="042210.html">[antlr-interest] 'Dude' error in v3.4 and possible bugs	explained [was: on &quot;crap&quot; grammars]
</A></li>
        <LI>Next message: <A HREF="042214.html">[antlr-interest] a project observation [Re: 'Dude' error in v3.4	and possible bugs explained [was: on &quot;crap&quot; grammars]]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42211">[ date ]</a>
              <a href="thread.html#42211">[ thread ]</a>
              <a href="subject.html#42211">[ subject ]</a>
              <a href="author.html#42211">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This was changed because the tool no longer generates those sets.

Jim

&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">antlr-interest-bounces at antlr.org</A> [mailto:antlr-interest-
</I>&gt;<i> <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">bounces at antlr.org</A>] On Behalf Of Justin Murray
</I>&gt;<i> Sent: Thursday, July 21, 2011 12:28 PM
</I>&gt;<i> To: Vlad
</I>&gt;<i> Cc: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">antlr-interest at antlr.org</A>
</I>&gt;<i> Subject: Re: [antlr-interest] 'Dude' error in v3.4 and possible bugs
</I>&gt;<i> explained [was: on &quot;crap&quot; grammars]
</I>&gt;<i>
</I>&gt;<i> I think that Vlad may be onto something here. From what I can tell from
</I>&gt;<i> my generated grammar, this only affects ANTLR3_MISMATCHED_SET_EXCEPTION
</I>&gt;<i> type exceptions. My grammar has several hundred parser rules, but only
</I>&gt;<i> in 4 cases is a ANTLR3_MISMATCHED_SET_EXCEPTION generated. In all 4
</I>&gt;<i> cases, the expectingSet is being set to NULL, and in no other cases is
</I>&gt;<i> expectingSet being set to NULL. I agree that this would be improved if
</I>&gt;<i> changed as Vlad described.
</I>&gt;<i>
</I>&gt;<i> It just so happens that the way I implemented my exception handling, I
</I>&gt;<i> treat ANTLR3_MISMATCHED_SET_EXCEPTION the same as
</I>&gt;<i> ANTLR3_RECOGNITION_EXCEPTION, and don't bother to display the
</I>&gt;<i> expectingSet, so I never would have discovered this problem.
</I>&gt;<i>
</I>&gt;<i> Since I recently figured out how the C template works, I decided to
</I>&gt;<i> take a peek. I found the following in antlr-3.4-complete-no-
</I>&gt;<i> antlrv2.jar/org/antlr/codegen/templates/C/C.stg:
</I>&gt;<i>
</I>&gt;<i> &lt;if(PARSER)&gt;
</I>&gt;<i> EXCEPTION-&gt;expectingSet = NULL;
</I>&gt;<i> &lt;! use following code to make it recover inline;
</I>&gt;<i> EXCEPTION-&gt;expectingSet = &amp;FOLLOW_set_in_&lt;ruleName&gt;&lt;elementIndex&gt;;
</I>&gt;<i> !&gt;
</I>&gt;<i> &lt;endif&gt;
</I>&gt;<i>
</I>&gt;<i> So it appears that this was done explicitly at some point. You could
</I>&gt;<i> edit C.stg to uncomment the code above, and I imagine that it will
</I>&gt;<i> generate the correct follow set pointer. Perhaps Jim knows why this is
</I>&gt;<i> like this? This may be avoiding some other problems, so I don't know
</I>&gt;<i> how safe of a change this would be.
</I>&gt;<i>
</I>&gt;<i> - Justin
</I>&gt;<i>
</I>&gt;<i> On 7/21/2011 2:45 PM, Vlad wrote:
</I>&gt;<i>
</I>&gt;<i> 	Previously I was on 3.2 runtime. It occurred to me to try 3.4
</I>&gt;<i> released a day ago. To this end I've switched to 3.4-beta4 runtime as
</I>&gt;<i> well. Using one of the testerrors.g grammars with non-inlined int/float
</I>&gt;<i> tokens and parser generated by antlr-3.4-complete.jar I now get on
</I>&gt;<i> input string &quot;name : bad&quot;:
</I>&gt;<i>
</I>&gt;<i> 	&lt;string&gt;(1)  : error 4 : Unexpected token, at offset 6
</I>&gt;<i> 	    near [Index: 4 (Start: 31458399-Stop: 31458401) ='bad',
</I>&gt;<i> type&lt;6&gt; Line: 1 LinePos:6]
</I>&gt;<i> 	     : unexpected input...
</I>&gt;<i> 	  expected one of : Actually dude, we didn't seem to be expecting
</I>&gt;<i> anything here, or at least
</I>&gt;<i> 	I could not work out what I was expecting, like so many of us
</I>&gt;<i> these days!
</I>&gt;<i>
</I>&gt;<i> 	(this required switching to antlr3StringStreamNew() from
</I>&gt;<i> antlr3NewAsciiStringInPlaceStream() as was posted by Jim here:
</I>&gt;<i> <A HREF="http://groups.google.com/group/il-antlr-">http://groups.google.com/group/il-antlr-</A>
</I>&gt;<i> interest/browse_thread/thread/981a79239e352c89 and as is mentioned
</I>&gt;<i> within that thread the last argument can't be NULL to avoid a
</I>&gt;<i> segfault).
</I>&gt;<i>
</I>&gt;<i> 	So, this is better because at least the offending token is
</I>&gt;<i> identified correctly. The reason the expected set is still not
</I>&gt;<i> identified correctly (the 'Dude' part) is because the generated error
</I>&gt;<i> path for the 'type' non-terminal always sets the exception's
</I>&gt;<i> expectingSet to NULL:
</I>&gt;<i>
</I>&gt;<i> 	        {
</I>&gt;<i> 	            if ( ((LA(1) &gt;= AT_FLOAT_) &amp;&amp; (LA(1) &lt;= AT_INT_)) )
</I>&gt;<i> 	            {
</I>&gt;<i> 	                CONSUME();
</I>&gt;<i> 	                PERRORRECOVERY=ANTLR3_FALSE;
</I>&gt;<i> 	            }
</I>&gt;<i> 	            else
</I>&gt;<i> 	            {
</I>&gt;<i> 	                CONSTRUCTEX();
</I>&gt;<i> 	                EXCEPTION-&gt;type         =
</I>&gt;<i> ANTLR3_MISMATCHED_SET_EXCEPTION;
</I>&gt;<i> 	                EXCEPTION-&gt;name         = (void
</I>&gt;<i> *)ANTLR3_MISMATCHED_SET_NAME;
</I>&gt;<i> 	                EXCEPTION-&gt;expectingSet = NULL; // &lt;--- ????
</I>&gt;<i>
</I>&gt;<i> 	                goto ruletypeEx;
</I>&gt;<i> 	            }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 	        }
</I>&gt;<i>
</I>&gt;<i> 	I might be called names again, but I'd say this error handling
</I>&gt;<i> does not look correct because the rule knows exactly what token set it
</I>&gt;<i> expects right here but then goes ahead and ignores that info for the
</I>&gt;<i> purposes of generating exception info (what's the point in indicating
</I>&gt;<i> ANTLR3_MISMATCHED_SET_NAME if that set is always set to NULL).
</I>&gt;<i>
</I>&gt;<i> 	Examining the generated parser code, I in fact see what appears to
</I>&gt;<i> be a correct set that would be FOLLOW(':'): it has bits set for
</I>&gt;<i> AT_FLOAT_ and AT_INT_ and is FOLLOWPUSH()ed before the rule is entered.
</I>&gt;<i>
</I>&gt;<i> 	By manually doctoring the parser code to set  EXCEPTION-
</I>&gt;<i> &gt;expectingSet to point to this FOLLOW set, I get rid of the 'Dude'
</I>&gt;<i> message but hit on another bug in displayRecognitionError() that prints
</I>&gt;<i> the wrong two token names:
</I>&gt;<i>
</I>&gt;<i> 	&lt;string&gt;(1)  : error 4 : Unexpected token, at offset 6
</I>&gt;<i> 	    near [Index: 4 (Start: 13845599-Stop: 13845601) ='bad',
</I>&gt;<i> type&lt;6&gt; Line: 1 LinePos:6]
</I>&gt;<i> 	     : unexpected input...
</I>&gt;<i> 	  expected one of : &lt;EOR&gt;, &lt;DOWN&gt;
</I>&gt;<i>
</I>&gt;<i> 	Looking at the stock displayRecognitionError() code, it is clear
</I>&gt;<i> that the loop over the set bits is not correct (the TODO is right).
</I>&gt;<i> Fixing it by adding errBits-&gt;isMember(errBits, bit):
</I>&gt;<i>
</I>&gt;<i> 	for (bit = 1; bit &lt; numbits &amp;&amp; count &lt; 8 &amp;&amp; count &lt; size; bit++)
</I>&gt;<i> 	{
</I>&gt;<i> 	// TODO: This doesn;t look right - should be asking if the bit is
</I>&gt;<i> set!!
</I>&gt;<i> 	//
</I>&gt;<i> 	if  (errBits-&gt;isMember(errBits, bit) &amp;&amp; tokenNames[bit]) // &lt;---
</I>&gt;<i> ???? was missing bitset member check
</I>&gt;<i> 	{
</I>&gt;<i> 	ANTLR3_FPRINTF(stderr, &quot;%s%s&quot;, count &gt; 0 ? &quot;, &quot; : &quot;&quot;,
</I>&gt;<i> tokenNames[bit]);
</I>&gt;<i> 	count++;
</I>&gt;<i> 	}
</I>&gt;<i> 	}
</I>&gt;<i>
</I>&gt;<i> 	finally gets me the error message that makes sense:
</I>&gt;<i>
</I>&gt;<i> 	&lt;string&gt;(1)  : error 4 : Unexpected token, at offset 6
</I>&gt;<i> 	    near [Index: 4 (Start: 30442591-Stop: 30442593) ='bad',
</I>&gt;<i> type&lt;6&gt; Line: 1 LinePos:6]
</I>&gt;<i> 	     : unexpected input...
</I>&gt;<i> 	  expected one of : AT_FLOAT_, AT_INT_
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 	&quot;Crap&quot; grammars, I hear somebody said? Hmm, I don't think so...
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> List: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">http://www.antlr.org/mailman/listinfo/antlr-interest</A>
</I>&gt;<i> Unsubscribe: <A HREF="http://www.antlr.org/mailman/options/antlr-interest/your-">http://www.antlr.org/mailman/options/antlr-interest/your-</A>
</I>&gt;<i> email-address
</I></PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="042210.html">[antlr-interest] 'Dude' error in v3.4 and possible bugs	explained [was: on &quot;crap&quot; grammars]
</A></li>
	<LI>Next message: <A HREF="042214.html">[antlr-interest] a project observation [Re: 'Dude' error in v3.4	and possible bugs explained [was: on &quot;crap&quot; grammars]]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42211">[ date ]</a>
              <a href="thread.html#42211">[ thread ]</a>
              <a href="subject.html#42211">[ subject ]</a>
              <a href="author.html#42211">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://www.antlr.org/mailman/listinfo/antlr-interest">More information about the antlr-interest
mailing list</a><br>
</body></html>
