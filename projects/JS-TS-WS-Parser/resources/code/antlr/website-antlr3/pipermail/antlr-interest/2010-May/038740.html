<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [antlr-interest] C target - initialization of return/scope	structures
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20C%20target%20-%20initialization%20of%20return/scope%0A%09structures&In-Reply-To=%3C0c063dcdea80ad449964eab4fe5d4fee%40temporal-wave.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038738.html">
   <LINK REL="Next"  HREF="038743.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[antlr-interest] C target - initialization of return/scope	structures</H1>
    <B>Jim Idle</B> 
    <A HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20C%20target%20-%20initialization%20of%20return/scope%0A%09structures&In-Reply-To=%3C0c063dcdea80ad449964eab4fe5d4fee%40temporal-wave.com%3E"
       TITLE="[antlr-interest] C target - initialization of return/scope	structures">jimi at temporal-wave.com
       </A><BR>
    <I>Thu May 20 06:17:25 PDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="038738.html">[antlr-interest] C target - initialization of return/scope	structures
</A></li>
        <LI>Next message: <A HREF="038743.html">[antlr-interest] C target - initialization of return/scope	structures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38740">[ date ]</a>
              <a href="thread.html#38740">[ thread ]</a>
              <a href="subject.html#38740">[ subject ]</a>
              <a href="author.html#38740">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>There is a macro to access the SCOPE_TOP(). 

Jim


&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">antlr-interest-bounces at antlr.org</A> [mailto:antlr-interest-
</I>&gt;<i> <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">bounces at antlr.org</A>] On Behalf Of Cristian T&#226;r&#186;oag&#227;
</I>&gt;<i> Sent: Thursday, May 20, 2010 5:49 AM
</I>&gt;<i> To: antlr-interest
</I>&gt;<i> Subject: Re: [antlr-interest] C target - initialization of return/scope
</I>&gt;<i> structures
</I>&gt;<i> 
</I>&gt;<i> Hi Mark,
</I>&gt;<i> 
</I>&gt;<i> thanks a lot, I think that is what I was looking for!
</I>&gt;<i> once I'll be able to install a custom deleter, my problems are solved!
</I>&gt;<i> allocation was not a problem even without using 'placement' new, but
</I>&gt;<i> deletion was a problem indeed (only when the rule was failing, leaks
</I>&gt;<i> could
</I>&gt;<i> occur)
</I>&gt;<i> 
</I>&gt;<i> Honestly, I never thought to put something like this:
</I>&gt;<i> ctx-&gt;pMyGrammarParser_GSTop-&gt;free = &amp;free_MyStruct;
</I>&gt;<i> in the @init action, I thought that maybe there is a general way to
</I>&gt;<i> install
</I>&gt;<i> the deleter, using a macro...I don't know...
</I>&gt;<i> 
</I>&gt;<i> But you're right, this WILL delete my pointers properly, THANKS!!   :-)
</I>&gt;<i> 
</I>&gt;<i>     Chris
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 2010/5/20 Mark Wright &lt;<A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">markwright at internode.on.net</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> &gt; On Thu, May 20, 2010 at 10:04:09AM +0300, Cristian T&#226;r&#351;oag&#259; wrote:
</I>&gt;<i> &gt; &gt; Hi Jim, that is not my problem, let me show you an example
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I want to have a scoped value which is a structure, and my
</I>&gt;<i> structure
</I>&gt;<i> &gt; holds
</I>&gt;<i> &gt; &gt; some std::strings
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; struct MyStruct
</I>&gt;<i> &gt; &gt; {
</I>&gt;<i> &gt; &gt;   std::string s1;
</I>&gt;<i> &gt; &gt;   std::string s2;
</I>&gt;<i> &gt; &gt; };
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; //this is part of my grammar
</I>&gt;<i> &gt; &gt; myrule
</I>&gt;<i> &gt; &gt; scope {MyStruct s;} //scoped VALUE
</I>&gt;<i> &gt; &gt; @init{}
</I>&gt;<i> &gt; &gt; @after{}
</I>&gt;<i> &gt; &gt; : rulegoeshere....;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; As you can see, there is no pointer here, the scoped variable is a
</I>&gt;<i> &gt; 'value'.
</I>&gt;<i> &gt; &gt; The code generated by antlr creates a scoped wrapper structure that
</I>&gt;<i> holds
</I>&gt;<i> &gt; &gt; MyStruct, something like:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; ctx-&gt;pMyParser_myruleTop = pMyParser_myrulePush(ctx); // this will
</I>&gt;<i> create
</I>&gt;<i> &gt; a
</I>&gt;<i> &gt; &gt; wrapper for the scoped value by calling ANTLR3_MALLOC
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; the wrapper looks like this:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; typedef struct  MyParser_myrule_SCOPE_struct
</I>&gt;<i> &gt; &gt; {
</I>&gt;<i> &gt; &gt;     void    (ANTLR3_CDECL *free)    (struct
</I>&gt;<i> MyParser_myrule_SCOPE_struct
</I>&gt;<i> &gt; *
</I>&gt;<i> &gt; &gt; frame);
</I>&gt;<i> &gt; &gt;     MyStruct s;
</I>&gt;<i> &gt; &gt; }
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; As you can see my struct is inside this structure. The problem is
</I>&gt;<i> that to
</I>&gt;<i> &gt; &gt; create the wrapper (see pMyParser_myrulePush above)
</I>&gt;<i> &gt; &gt; antlr calls ANTLR3_MALLOC (which does malloc of course).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; THIS MEANS I'M GONNA GET A CRASH!
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Why? because std::string is a c++ class, which HAS to be
</I>&gt;<i> &gt; created/destroyed
</I>&gt;<i> &gt; &gt; using new/delete, not malloc/free.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hi Cristian,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; As Jim advised, you need to initialise it in @init().  As the memory
</I>&gt;<i> has
</I>&gt;<i> &gt; already been allocated, the correct way to initialise it is to call
</I>&gt;<i> the
</I>&gt;<i> &gt; constructor with placement operator new.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; And it is necessary to register your own free method to call the
</I>&gt;<i> &gt; destructor.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; grammar MyGrammar;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; options {
</I>&gt;<i> &gt;        language = C;
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; scope GS {
</I>&gt;<i> &gt;  MyStruct s;
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; @parser::includes {
</I>&gt;<i> &gt; #include &lt;new&gt;
</I>&gt;<i> &gt; #include &quot;MyStruct.h&quot;
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; myrule
</I>&gt;<i> &gt; scope GS;
</I>&gt;<i> &gt; @init{
</I>&gt;<i> &gt;  new(&amp;($GS::s))MyStruct;
</I>&gt;<i> &gt;  ctx-&gt;pMyGrammarParser_GSTop-&gt;free = &amp;free_MyStruct;
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt;        : 'foo'
</I>&gt;<i> &gt;        | 'bar'
</I>&gt;<i> &gt;        ;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; mystruct.h:
</I>&gt;<i> &gt; #include &lt;string&gt;
</I>&gt;<i> &gt; #include &lt;antlr3.h&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; struct MyStruct
</I>&gt;<i> &gt; {
</I>&gt;<i> &gt;  std::string s1;
</I>&gt;<i> &gt;  std::string s2;
</I>&gt;<i> &gt; };
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; extern &quot;C&quot; {
</I>&gt;<i> &gt;  void ANTLR3_CDECL free_MyStruct(struct
</I>&gt;<i> MyGrammarParser_GS_SCOPE_struct
</I>&gt;<i> &gt; *scope);
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; mystruct.cpp:
</I>&gt;<i> &gt; extern &quot;C&quot; {
</I>&gt;<i> &gt; void ANTLR3_CDECL free_MyStruct(struct
</I>&gt;<i> MyGrammarParser_GS_SCOPE_struct
</I>&gt;<i> &gt; *scope)
</I>&gt;<i> &gt; {
</I>&gt;<i> &gt;  // Call the destructor
</I>&gt;<i> &gt;  (&amp;(scope-&gt;s))-&gt;MyStruct::~MyStruct();
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Regards, Mark
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; That means, I cannot use a scoped VALUE, I have to use a scoped
</I>&gt;<i> POINTER
</I>&gt;<i> &gt; &gt; instead, as suggested here:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; <A HREF="http://www.mail-archive.com/il-antlr-">http://www.mail-archive.com/il-antlr-</A>
</I>&gt;<i> <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">interest at googlegroups.com</A>/msg02614.html
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Suggested Solution 1: local new/delete allocation/deallocation
</I>&gt;<i> &gt; &gt; ------------------------------
</I>&gt;<i> &gt; &gt; -----------------------------------------------------------
</I>&gt;<i> &gt; &gt; So my rule will now look like this:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; myrule
</I>&gt;<i> &gt; &gt; scope {MyStruct* s;} //scoped POINTER
</I>&gt;<i> &gt; &gt; @init{ $myrule::s = new MyStruct();} //explicit allocation using
</I>&gt;<i> new
</I>&gt;<i> &gt; &gt; @after{ delete $myrule::s; } //explicit deallocation using delete
</I>&gt;<i> &gt; &gt; : rulegoeshere....;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Looks good? Well, I think not!
</I>&gt;<i> &gt; &gt; Because when the rule fails, the @after action is NOT called, and
</I>&gt;<i> I'm
</I>&gt;<i> &gt; gonna
</I>&gt;<i> &gt; &gt; get a nice memory leak.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Solution 1': the scoped wrapper has a member called free that can
</I>&gt;<i> hold a
</I>&gt;<i> &gt; &gt; 'deleter', but I couldn't find a way to set that.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Suggested Solution2: override antlr macros ANTLR3_MALLOC and
</I>&gt;<i> ANTLR3_FREE
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; ---------------------------------------------------------------------
</I>&gt;<i> ---------------------------------------------------
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Nice try, but ANTLR3_MALLOC is currently defined like this:
</I>&gt;<i> &gt; &gt; #define    ANTLR3_MALLOC(request)                    malloc
</I>&gt;<i> &gt; &gt; ((size_t)(request))
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; As you can see, the 'request' argument is a SIZE, not a type, which
</I>&gt;<i> means
</I>&gt;<i> &gt; &gt; that if I want to override it to make it use 'new' instead of
</I>&gt;<i> malloc, I
</I>&gt;<i> &gt; &gt; cannot use it.
</I>&gt;<i> &gt; &gt; &gt;From the given size I cannot deduce the type (this could work the
</I>&gt;<i> other
</I>&gt;<i> &gt; way
</I>&gt;<i> &gt; &gt; around if you change the define, to pass it the type you could get
</I>&gt;<i> the
</I>&gt;<i> &gt; size,
</I>&gt;<i> &gt; &gt; and it could be possible to override the default way of antlr's
</I>&gt;<i> &gt; &gt; allocations/deallocations)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; That is my problem and those are the options I have. Maybe with
</I>&gt;<i> some
</I>&gt;<i> &gt; &gt; adjustment some of them will work, but right now, I'm not happy
</I>&gt;<i> with any
</I>&gt;<i> &gt; of
</I>&gt;<i> &gt; &gt; them: first one leaks, second one is not usable.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Maybe you have some hints for me :-)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Thanks a lot for your answer
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;    Chris
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; List: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">http://www.antlr.org/mailman/listinfo/antlr-interest</A>
</I>&gt;<i> &gt; &gt; Unsubscribe:
</I>&gt;<i> &gt; <A HREF="http://www.antlr.org/mailman/options/antlr-interest/your-email-">http://www.antlr.org/mailman/options/antlr-interest/your-email-</A>
</I>&gt;<i> address
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> List: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">http://www.antlr.org/mailman/listinfo/antlr-interest</A>
</I>&gt;<i> Unsubscribe: <A HREF="http://www.antlr.org/mailman/options/antlr-interest/your-">http://www.antlr.org/mailman/options/antlr-interest/your-</A>
</I>&gt;<i> email-address
</I>


</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038738.html">[antlr-interest] C target - initialization of return/scope	structures
</A></li>
	<LI>Next message: <A HREF="038743.html">[antlr-interest] C target - initialization of return/scope	structures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38740">[ date ]</a>
              <a href="thread.html#38740">[ thread ]</a>
              <a href="subject.html#38740">[ subject ]</a>
              <a href="author.html#38740">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://www.antlr.org/mailman/listinfo/antlr-interest">More information about the antlr-interest
mailing list</a><br>
</body></html>
