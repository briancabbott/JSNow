<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [antlr-interest] faster expression parsing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20faster%20expression%20parsing&In-Reply-To=%3CFF993752CB890B4EB591BE5450C37BF1FF4CF3%40navamane001.ad.internal.corp%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027270.html">
   <LINK REL="Next"  HREF="027273.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[antlr-interest] faster expression parsing</H1>
    <B>Edwards, Waverly</B> 
    <A HREF="mailto:antlr-interest%40antlr.org?Subject=Re:%20%5Bantlr-interest%5D%20faster%20expression%20parsing&In-Reply-To=%3CFF993752CB890B4EB591BE5450C37BF1FF4CF3%40navamane001.ad.internal.corp%3E"
       TITLE="[antlr-interest] faster expression parsing">Waverly.Edwards at genesys.com
       </A><BR>
    <I>Mon Mar 17 15:29:50 PDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="027270.html">[antlr-interest] faster expression parsing
</A></li>
        <LI>Next message: <A HREF="027273.html">[antlr-interest] faster expression parsing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27272">[ date ]</a>
              <a href="thread.html#27272">[ thread ]</a>
              <a href="subject.html#27272">[ subject ]</a>
              <a href="author.html#27272">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> 
Mr. Norvell algorithm reminds me of a paper I read by David R. Hanson
who co-wrote &quot;A Retargetable C Compiler: Design and Implementation&quot;
It was a short fascinating read.  There was another paper that he did
with his co-author Christopher W. Frasier which may have simplified it
even further.  I haven't found that paper online but I know it exists
because I used the algorithm in one of my own programs.


W.

<A HREF="http://drhanson.s3.amazonaws.com/storage/documents/compact.pdf">http://drhanson.s3.amazonaws.com/storage/documents/compact.pdf</A>

-----Original Message-----
From: <A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">antlr-interest-bounces at antlr.org</A>
[mailto:<A HREF="http://www.antlr.org/mailman/listinfo/antlr-interest">antlr-interest-bounces at antlr.org</A>] On Behalf Of Terence Parr
Sent: Monday, March 17, 2008 5:18 PM
To: antlr-interest Interest
Subject: [antlr-interest] faster expression parsing

So, I should have been working on something else but got to thinking  
about how annoying it is specifying expressions in recursive descent  
parsers.  You have to have a new rule for each precedence level.   
This is also very slow. Just to match 34 it has to descend about 15  
method calls.  I built a prototype single-rule (plus primary and  
suffix) operator matching thingie today.  I should be able to  
generate this from some metameta syntax in antlr.  Try it out...it's  
amazing (v3.1 required due to tree bulding bug fix).

Ter
---------------
/** Test faster recursive-descent expression parsing.
  *  Goal: avoid recursing for *each* precedence level.
  *  Recurse for changes in precedence, avoiding repeated
  *  tests for each level.  The key is passing into expression
  *  the min precedence level to match, which is based upon
  *  previous operator.
  *
  *  Based upon &quot;precedence climbling&quot; by Theodore Norvell:
  *      <A HREF="http://www.engr.mun.ca/~theo/Misc/exp_parsing.htm">http://www.engr.mun.ca/~theo/Misc/exp_parsing.htm</A>
  *
  *  NOTES:
  *      1. Holy crap!  This actually works!
  *      2. Should be able to autogenerate from list of operators,  
precedence
  *         etc...
  */
grammar T;

options { output=AST; ASTLabelType=CommonTree; }

tokens { PREINC; POSTINC; CALL; INDEX; }

@members {
public static final int LEFT = 1;
public static final int RIGHT = 2;
static int[] prec = new int[tokenNames.length];
static int[] uprec = new int[tokenNames.length];
static int[] postprec = new int[tokenNames.length];
static int[] assoc = new int[tokenNames.length];
static {
     for (int i=0; i&lt;tokenNames.length; i++) { assoc[i]=LEFT; }
     prec[PLUS] = 1;
     prec[MINUS] = 1;
     prec[STAR] = 3;
     prec[CARET] = 4;
     prec[DOT] = 6;
     assoc[CARET] = RIGHT;

     uprec[MINUS] = 2;       // sits between +/- binary and * binary ops
     postprec[LPAREN] = 5;   // lower than DOT for p.f()
     postprec[LBRACK] = 5;
     postprec[INC] = 5;
}

int nextp(int p) {
     int prevOpType = input.LA(-1);
     if ( assoc[prevOpType]==LEFT ) return prec[prevOpType]+1;
     else return prec[prevOpType];
}
}

expr : e[0] {System.out.println($e.tree.toStringTree());} ;

/** This could be autogenerated if you give me primary and suffix and  
precedence levels */
e[int p]
     :   (primary-&gt;primary)
         (   {prec[input.LA(1)]&gt;=p}?=&gt;     bop r=e[nextp(p)] -&gt; ^(bop  
$e $r)
         |   {postprec[input.LA(1)]&gt;=p}?=&gt; suffix[$e.tree]   -&gt;  
{$suffix.tree}
         )*
     ;

primary
     :   INT
     |   ID
     |   uop^ {int q=uprec[input.LA(-1)];} e[q]
     |   '(' expr ')' -&gt; expr
     ;

suffix[CommonTree lhs]
     :   t='[' expr ']'                -&gt; ^(INDEX[$t] {$lhs} expr)
     |   t='(' (expr (',' expr)*)? ')' -&gt; ^(CALL[$t] {$lhs} expr*)
     |   t='++'                        -&gt; ^(POSTINC[$t] {$lhs})
     ;

bop :   '+' | '-' | '*' | '^' | '.' ;

uop :   '-' | t='++' -&gt; PREINC[$t];

INC : '++';
LPAREN : '(' ;
LBRACK : '[' ;
PLUS: '+';
MINUS: '-';
STAR: '*';
DOT : '.';
CARET:'^';
INT : '0'..'9'+ ;
ID  : 'a'..'z'+ ;
WS  : (' '|'\n')+ ;

</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027270.html">[antlr-interest] faster expression parsing
</A></li>
	<LI>Next message: <A HREF="027273.html">[antlr-interest] faster expression parsing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27272">[ date ]</a>
              <a href="thread.html#27272">[ thread ]</a>
              <a href="subject.html#27272">[ subject ]</a>
              <a href="author.html#27272">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://www.antlr.org/mailman/listinfo/antlr-interest">More information about the antlr-interest
mailing list</a><br>
</body></html>
